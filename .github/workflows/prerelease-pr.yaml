---
name: prerelease a pull request
on:
  workflow_dispatch:
    inputs:
      tag:
        description: "tag"
        required: true
      pr:
        description: "pr number"
        required: true
permissions:
  contents: write
jobs:
  release:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    env:
      PR: ${{inputs.pr}}
      TAG: ${{inputs.tag}}
    steps:
      - uses: actions/checkout@d632683dd7b4114ad314bca15554477dd762a938 # v4.2.0
      - run: gh pr checkout "$PR"
        env:
          GITHUB_TOKEN: ${{github.token}}

      - name: Generate token
        id: generate_token
        uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2.1.0
        with:
          app_id: ${{secrets.APP_ID}}
          private_key: ${{secrets.APP_PRIVATE_KEY}}
          permissions: >-
            {
              "contents": "write"
            }
          repositories: >-
            [
              "${{github.event.repository.name}}"
            ]

      - run: gh auth setup-git
        env:
          GITHUB_TOKEN: ${{steps.generate_token.outputs.token}}
      # https://github.community/t/github-actions-bot-email-address/17204/5
      - run: git config user.name "github-actions[bot]"
      - run: git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - run: |
          git ls-files | grep -E "/action\.yaml$" |
            xargs -n 1 sed -i "s|- uses: suzuki-shunsuke/tfaction/\(.*\)@main|- uses: suzuki-shunsuke/tfaction/\1@${TAG}|"
      - run: git checkout -b "release/${TAG}"
      - run: |
          git ls-files | grep -E "/action\.yaml$" | xargs git add
      - run: |
          git commit -m "chore: release ${TAG}
          base revision: $GITHUB_SHA"
      - run: git tag "$TAG"
      - run: git push origin "${TAG}"
      - run: |
          gh release create "$TAG" -p --title "$TAG" -n "$NOTE"
        env:
          NOTE: "[Issues](https://github.com/suzuki-shunsuke/tfaction/issues?q=is%3Aissue+is%3Aclosed+milestone%3A${{env.TAG}}) | [Pull Requests](https://github.com/suzuki-shunsuke/tfaction/pulls?q=is%3Apr+is%3Aclosed+milestone%3A${{github.event.inputs.tag}}) | https://github.com/suzuki-shunsuke/tfaction/compare/${{env.TAG}}...${{env.TAG}} | [Base revision](https://github.com/suzuki-shunsuke/tfaction/tree/${{env.GITHUB_SHA}})"
          GITHUB_TOKEN: ${{ github.token }}
