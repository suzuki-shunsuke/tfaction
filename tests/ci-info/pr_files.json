[
  {
    "sha": "dd4106378f71cf27df6bde73772cb7bf7826c138",
    "filename": ".github/workflows/wc-create-pr-branch.yaml",
    "additions": 6,
    "deletions": 11,
    "changes": 17,
    "status": "modified",
    "patch": "@@ -72,6 +72,11 @@ jobs:\n       - name: Install dependencies\n         uses: ./install\n \n+      - name: ci-info\n+        uses: ./js\n+        with:\n+          action: ci-info\n+\n       - name: Test js/get-target-config\n         uses: ./js\n         id: js-target-config\n@@ -109,19 +114,12 @@ jobs:\n         id: js-check-terraform-skip\n         with:\n           action: check-terraform-skip\n-          labels: js/test/labels.txt\n-          skip_label_prefix: \"skip:\"\n-          pr_author: suzuki-shunsuke\n         env:\n           TFACTION_CONFIG: js/test/tfaction-root.yaml\n           TFACTION_JOB_TYPE: terraform\n       - name: Test check-terraform-skip\n         uses: ./check-terraform-skip\n         id: check-terraform-skip\n-        with:\n-          labels: js/test/labels.txt\n-          skip_label_prefix: \"skip:\"\n-          pr_author: suzuki-shunsuke\n         env:\n           TFACTION_CONFIG: js/test/tfaction-root.yaml\n           TFACTION_JOB_TYPE: terraform\n@@ -159,10 +157,8 @@ jobs:\n         id: js-list-targets-with-changed-files\n         with:\n           action: list-targets-with-changed-files\n-          changed_files: js/test/changed_files.txt\n-          labels: js/test/labels.txt\n-          module_files: js/test/list-module-callers/module_files.txt\n           config_files: js/test/list-module-callers/config_files.txt\n+          module_files: js/test/list-module-callers/module_files.txt\n           pull_request: \"\" # A path to ci-info's pr.json\n           module_callers: \"\"\n         env:\n@@ -175,7 +171,6 @@ jobs:\n           labels: js/test/labels.txt\n           module_files: js/test/list-module-callers/module_files.txt\n           config_files: js/test/list-module-callers/config_files.txt\n-          pull_request: \"\" # A path to ci-info's pr.json\n           module_callers: \"\"\n         env:\n           TFACTION_CONFIG: js/test/tfaction-root.yaml",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/.github%2Fworkflows%2Fwc-create-pr-branch.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/.github%2Fworkflows%2Fwc-create-pr-branch.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/.github%2Fworkflows%2Fwc-create-pr-branch.yaml?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "4a50f09ce3efd765318a12dd42c730994e3bf1a9",
    "filename": ".gitignore",
    "additions": 1,
    "deletions": 0,
    "changes": 1,
    "status": "modified",
    "patch": "@@ -6,3 +6,4 @@ dist\n .terraform\n schema\n terragrunt.rendered.json\n+.terragrunt-cache",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/.gitignore",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/.gitignore",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/.gitignore?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "c93cda52eaed2a97c7eee6a5be234a3e74a3ac77",
    "filename": "apply/action.yaml",
    "additions": 21,
    "deletions": 11,
    "changes": 32,
    "status": "modified",
    "patch": "@@ -26,21 +26,31 @@ inputs:\n runs:\n   using: composite\n   steps:\n-    - uses: suzuki-shunsuke/tfaction/terraform-apply@main\n+    # terraform-apply\n+    - uses: suzuki-shunsuke/tfaction@main\n       if: env.TFACTION_JOB_TYPE == 'terraform'\n+      id: check-terraform-skip\n       with:\n-        # pull-requests:write - Create pull request comments and labels\n-        # actions:read - Download artifacts\n-        # contents:write - Update pull request branches\n-        github_token: ${{inputs.github_token}}\n+        action: check-terraform-skip\n+\n+    - uses: suzuki-shunsuke/tfaction@main\n+      id: terraform-apply\n+      if: |\n+        steps.check-terraform-skip.outputs.skip_terraform != 'true' \u0026\u0026\n+        env.TFACTION_JOB_TYPE == 'terraform'\n+      with:\n+        action: terraform-apply\n+        github_token: ${{ inputs.github_token }}\n         securefix_action_app_id: ${{inputs.securefix_action_app_id}}\n         securefix_action_app_private_key: ${{inputs.securefix_action_app_private_key}}\n \n-    - uses: suzuki-shunsuke/tfaction/tfmigrate-apply@main\n+    # tfmigrate-apply\n+    - uses: suzuki-shunsuke/tfaction@main\n       if: env.TFACTION_JOB_TYPE == 'tfmigrate'\n+      id: tfmigrate-apply\n+      working-directory: ${{ steps.target-config.outputs.working_directory }}\n       with:\n-        # pull-requests:write - Create pull request comments\n-        # contents:write - Update pull request branches\n-        github_token: ${{inputs.github_token}}\n-        securefix_action_app_id: ${{inputs.securefix_action_app_id}}\n-        securefix_action_app_private_key: ${{inputs.securefix_action_app_private_key}}\n+        github_token: ${{ inputs.github_token }}\n+        action: tfmigrate-apply\n+        securefix_action_app_id: ${{ inputs.securefix_action_app_id }}\n+        securefix_action_app_private_key: ${{ inputs.securefix_action_app_private_key }}",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/apply%2Faction.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/apply%2Faction.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/apply%2Faction.yaml?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "c77e46131c4603dd8703c6e5358c4f91783940bf",
    "filename": "check-terraform-skip/action.yaml",
    "additions": 6,
    "deletions": 9,
    "changes": 15,
    "status": "modified",
    "patch": "@@ -2,14 +2,14 @@ name: Check if terraform plan and apply are skipped\n description: Check if terraform plan and apply are skipped\n inputs:\n   labels:\n-    description: \"Labels File\"\n-    required: true\n+    description: \"Deprecated. This input is no longer used.\"\n+    required: false\n   skip_label_prefix:\n-    description: \"Skip Label Prefix\"\n-    required: true\n+    description: \"Deprecated. This input is no longer used.\"\n+    required: false\n   pr_author:\n-    description: \"Pull Request Author\"\n-    required: true\n+    description: \"Deprecated. This input is no longer used.\"\n+    required: false\n outputs:\n   skip_terraform:\n     description: whether terraform is skipped\n@@ -24,6 +24,3 @@ runs:\n       id: main\n       with:\n         action: check-terraform-skip\n-        labels: ${{inputs.labels}}\n-        skip_label_prefix: ${{inputs.skip_label_prefix}}\n-        pr_author: ${{inputs.pr_author}}",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/check-terraform-skip%2Faction.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/check-terraform-skip%2Faction.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/check-terraform-skip%2Faction.yaml?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "04b93e5eb4003055c2ce94f3989c2f7135740958",
    "filename": "install/action.yaml",
    "additions": 4,
    "deletions": 0,
    "changes": 4,
    "status": "modified",
    "patch": "@@ -24,3 +24,7 @@ runs:\n         AQUA_GITHUB_TOKEN: ${{ inputs.github_token }}\n     - shell: bash\n       run: echo \"AQUA_GLOBAL_CONFIG=$GITHUB_ACTION_PATH/aqua.yaml:${AQUA_GLOBAL_CONFIG:-}\" \u003e\u003e \"$GITHUB_ENV\"\n+    - shell: bash\n+      run: echo \"TFACTION_GITHUB_COMMENT_CONFIG=$GITHUB_ACTION_PATH/github-comment.yaml\" \u003e\u003e \"$GITHUB_ENV\"\n+    - shell: bash\n+      run: echo \"TFACTION_INSTALL_DIR=$GITHUB_ACTION_PATH\" \u003e\u003e \"$GITHUB_ENV\"",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/install%2Faction.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/install%2Faction.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/install%2Faction.yaml?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "6c8d61720516c1eb73cb24b53502fbd3cf1c40f9",
    "filename": "install/aqua-checksums.json",
    "additions": 0,
    "deletions": 30,
    "changes": 30,
    "status": "modified",
    "patch": "@@ -135,36 +135,6 @@\n       \"checksum\": \"97C733E492DEC1FD83B9342C25A384D5AB6EBFA72B6978346E9A436CAD1853F6\",\n       \"algorithm\": \"sha256\"\n     },\n-    {\n-      \"id\": \"github_release/github.com/suzuki-shunsuke/ci-info/v2.4.1/ci-info_2.4.1_darwin_amd64.tar.gz\",\n-      \"checksum\": \"1862D5A77B4FE2B4A9D7622699A0027278B542D43538CF4EC3D955B1E6D6A8C0\",\n-      \"algorithm\": \"sha256\"\n-    },\n-    {\n-      \"id\": \"github_release/github.com/suzuki-shunsuke/ci-info/v2.4.1/ci-info_2.4.1_darwin_arm64.tar.gz\",\n-      \"checksum\": \"3A7237021550633D6DB8DB3BA2531CB069C75D2E3556E4E4573FE07F20644832\",\n-      \"algorithm\": \"sha256\"\n-    },\n-    {\n-      \"id\": \"github_release/github.com/suzuki-shunsuke/ci-info/v2.4.1/ci-info_2.4.1_linux_amd64.tar.gz\",\n-      \"checksum\": \"059BA5A0EF29E8327F82D209BD08A04A02631E967F86836CBFF869602AA93B75\",\n-      \"algorithm\": \"sha256\"\n-    },\n-    {\n-      \"id\": \"github_release/github.com/suzuki-shunsuke/ci-info/v2.4.1/ci-info_2.4.1_linux_arm64.tar.gz\",\n-      \"checksum\": \"DF6AFA9E9789AB10DECAFA09685404F0FA252A0639842A0CD535E5C644FE2501\",\n-      \"algorithm\": \"sha256\"\n-    },\n-    {\n-      \"id\": \"github_release/github.com/suzuki-shunsuke/ci-info/v2.4.1/ci-info_2.4.1_windows_amd64.tar.gz\",\n-      \"checksum\": \"FE01FB2A1C2FA523FE0C4F02EE683EB3E0AD15D4F624C6582AD4689D7C397DE5\",\n-      \"algorithm\": \"sha256\"\n-    },\n-    {\n-      \"id\": \"github_release/github.com/suzuki-shunsuke/ci-info/v2.4.1/ci-info_2.4.1_windows_arm64.tar.gz\",\n-      \"checksum\": \"7FD398899478039BFC31B056A954772D7B01C62BA18E630A872E4DF72D0D27F6\",\n-      \"algorithm\": \"sha256\"\n-    },\n     {\n       \"id\": \"github_release/github.com/suzuki-shunsuke/github-comment/v6.3.5/github-comment_6.3.5_darwin_amd64.tar.gz\",\n       \"checksum\": \"AE36C77AF8B341EC8A6ACAC83BA68641DCC933B3571DE6F213F7970993CA88FA\",",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/install%2Faqua-checksums.json",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/install%2Faqua-checksums.json",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/install%2Faqua-checksums.json?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "bf72daf7a15e748fd95171893b6a390bda295e17",
    "filename": "install/aqua/ci-info.yaml",
    "additions": 0,
    "deletions": 2,
    "changes": 2,
    "status": "removed",
    "patch": "@@ -1,2 +0,0 @@\n-packages:\n-  - name: suzuki-shunsuke/ci-info@v2.4.1",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/0fc0ced9de02901ebeaa991bce25770f6d2a8ec1/install%2Faqua%2Fci-info.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/0fc0ced9de02901ebeaa991bce25770f6d2a8ec1/install%2Faqua%2Fci-info.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/install%2Faqua%2Fci-info.yaml?ref=0fc0ced9de02901ebeaa991bce25770f6d2a8ec1"
  },
  {
    "sha": "e6d5bb46564c1d3d10f81ef1279a835db6a8b86c",
    "filename": "install/github-comment.yaml",
    "additions": 227,
    "deletions": 0,
    "changes": 227,
    "status": "added",
    "patch": "@@ -0,0 +1,227 @@\n+# https://github.com/suzuki-shunsuke/github-comment\n+# This file is a merged version of all github-comment.yaml files in the repository\n+post:\n+  invalid-workflow-sha:\n+    template: |\n+      ## :x: {{if .Vars.tfaction_target}}{{.Vars.tfaction_target}}: {{end}}workflow run's headSha is invalid\n+\n+      {{template \"link\" .}}\n+\n+      It failed to get a Terraform plan file from the pull request workflow run's artifacts.\n+      workflow run's headSha ({{.Vars.wf_sha}}) is different from the associated pull request's head sha ({{.Vars.pr_sha}}).\n+\n+  no-workflow-run-found:\n+    template: |\n+      ## :x: {{.Vars.tfaction_target}}: No workflow run is found `{{.Vars.plan_workflow_name}}`\n+\n+      {{template \"link\" .}}\n+\n+      plan_workflow_name: {{.Vars.plan_workflow_name}}\n+      branch: {{.Vars.branch}}\n+\n+      Maybe the setting `plan_workflow_name` in `tfaction-root.yaml` is wrong.\n+      `plan_workflow_name` must be the workflow name where terraform plan is run in CI of pull requests.\n+\n+  create-follow-up-pr:\n+    template: |\n+      ## {{if .Vars.tfaction_target}}{{.Vars.tfaction_target}}: {{end}}Follow up PR was created\n+\n+      {{template \"link\" .}}\n+\n+      {{.Vars.mentions}}\n+\n+      Apply failed. Please handle the problem. **:warning: Don't rerun GitHub Actions Workflow**\n+\n+      1. Check the error message\n+      1. Check {{.Vars.follow_up_pr_url}}\n+      1. Add commits to {{.Vars.follow_up_pr_url}} to fix the problem if needed\n+      1. Review and merge {{.Vars.follow_up_pr_url}}\n+\n+  skip-create-follow-up-pr:\n+    template: |\n+      ## {{if .Vars.tfaction_target}}{{.Vars.tfaction_target}}: {{end}}Please create a follow up pull request\n+\n+      {{template \"link\" .}}\n+\n+      {{.Vars.mentions}}\n+\n+      Apply failed. Please handle the problem. **:warning: Don't rerun GitHub Actions Workflow**\n+\n+      1. Check the error message\n+      1. Create a follow up pull request\n+\n+      ```sh\n+      gh pr create {{.Vars.opts | AvoidHTMLEscape}}\n+      ```\n+\n+      ref. [gh pr create](https://cli.github.com/manual/gh_pr_create)\n+\n+      3. Add commits to the follow up pull request to fix the problem if needed\n+      4. Review and merge {{.Vars.follow_up_pr_url}}\n+\n+  too-many-changed-dirs:\n+    template: |\n+      ## :x: Too many working directories are changed\n+\n+      {{template \"link\" .}}\n+\n+      Too many working directories are changed in one pull request.\n+      You can change up to {{.Vars.max_changed_dirs}} working directories.\n+      This is configured in tfaction-root.yaml.\n+\n+      [For more details, please see the document](https://suzuki-shunsuke.github.io/tfaction/docs/codes/001).\n+\n+  too-many-changed-modules:\n+    template: |\n+      ## :x: Too many modules are changed\n+\n+      {{template \"link\" .}}\n+\n+      Too many modules are changed in one pull request.\n+      You can change up to {{.Vars.max_changed_modules}} modules.\n+      This is configured in tfaction-root.yaml.\n+\n+      [For more details, please see the document](https://suzuki-shunsuke.github.io/tfaction/docs/codes/001).\n+\n+  tfmigrate-hcl-not-found:\n+    template: |\n+      ## :x: {{if .Vars.tfaction_target}}{{.Vars.tfaction_target}}: {{end}}.tfmigrate.hcl isn't found\n+\n+      {{template \"link\" .}}\n+\n+      To run `tfmigrate plan`, `.tfmigrate.hcl` is required.\n+\n+  renovate-plan-change:\n+    template: |\n+      ## :x: {{if .Vars.tfaction_target}}{{.Vars.tfaction_target}}: {{end}}Renovate's PR must be `No change`\n+\n+      {{template \"link\" .}}\n+\n+      In the pull request created by Renovate, the result of `terraform plan` must be `No change` to enable automerge safely.\n+      If you allow changes, please set the pull request label `renovate-change` and rerun CI.\n+\n+exec:\n+  default:\n+    - when: ExitCode != 0\n+      template: |\n+        :x: {{.Vars.tfaction_target}}\n+\n+        {{template \"link\" .}}\n+\n+        {{template \"join_command\" .}}\n+\n+        {{template \"hidden_combined_output\" .}}\n+\n+  list-workflow-runs:\n+    - when: ExitCode != 0 and Stderr contains \"could not find any workflows named\"\n+      template: |\n+        ## :x: {{.Vars.tfaction_target}}: Failed to list workflow runs `{{.Vars.plan_workflow_name}}`\n+\n+        {{template \"link\" .}}\n+\n+        It failed to list workflow runs `{{.Vars.plan_workflow_name}}`.\n+        Probably the setting `plan_workflow_name` in `tfaction-root.yaml` is wrong.\n+        `plan_workflow_name` must be the workflow name where terraform plan is run in CI of pull requests.\n+\n+        {{template \"join_command\" .}}\n+\n+        {{template \"hidden_combined_output\" .}}\n+    - when: ExitCode != 0\n+      template: |\n+        ## :x: {{.Vars.tfaction_target}}: Failed to list workflow runs `{{.Vars.plan_workflow_name}}`\n+\n+        {{template \"link\" .}}\n+\n+        It failed to list workflow runs `{{.Vars.plan_workflow_name}}`.\n+\n+        {{template \"join_command\" .}}\n+\n+        {{template \"hidden_combined_output\" .}}\n+    - when: Stdout == \"\"\n+      template: |\n+        ## :x: {{.Vars.tfaction_target}}: No workflow run is found `{{.Vars.plan_workflow_name}}`\n+\n+        {{template \"link\" .}}\n+\n+        {{template \"join_command\" .}}\n+\n+        {{template \"hidden_combined_output\" .}}\n+\n+  download-plan-file:\n+    - when: ExitCode != 0\n+      template: |\n+        ## :x: {{.Vars.tfaction_target}}: Failed to download a plan file from GitHub Actions Artifact\n+\n+        {{template \"link\" .}}\n+\n+        {{template \"join_command\" .}}\n+\n+        {{template \"hidden_combined_output\" .}}\n+\n+  terraform-docs:\n+    - when: ExitCode != 0\n+      template: |\n+        ## :x: Failed to generate a Module document with terraform-docs ({{.Vars.tfaction_target}})\n+\n+        [terraform-docs](https://terraform-docs.io/) | {{template \"link\" .}}\n+\n+        {{template \"join_command\" .}}\n+\n+        {{template \"hidden_combined_output\" .}}\n+\n+  tfmigrate-apply:\n+    - when: true\n+      template: |\n+        ## {{template \"status\" .}} {{if .Vars.tfaction_target}}{{.Vars.tfaction_target}}: {{end}} tfmigrate apply\n+\n+        {{template \"link\" .}}\n+\n+        {{template \"join_command\" .}}\n+\n+        {{template \"hidden_combined_output\" .}}\n+\n+  drift-apply:\n+    - when: true\n+      template: |\n+        ## {{template \"status\" .}} tfmigrate apply\n+\n+        [Pull Request]({{.Vars.pr_url}}) | {{template \"link\" .}}\n+\n+        ```console\n+        $ tfmigrate apply\n+        ```\n+\n+        {{template \"hidden_combined_output\" .}}\n+\n+  conftest:\n+    - when: ExitCode != 0\n+      template: |\n+        ## :x: {{if .Vars.tfaction_target}}{{.Vars.tfaction_target}}: {{end}}Violate Conftest Policy\n+\n+        {{template \"link\" .}}\n+\n+        {{template \"join_command\" .}}\n+\n+        {{.CombinedOutput | AvoidHTMLEscape}}\n+\n+  tfmigrate-plan:\n+    - when: true\n+      template: |\n+        ## {{template \"status\" .}} {{if .Vars.tfaction_target}}{{.Vars.tfaction_target}}: {{end}} tfmigrate plan\n+\n+        {{template \"link\" .}}\n+\n+        {{template \"join_command\" .}}\n+\n+        {{template \"hidden_combined_output\" .}}\n+\n+  terraform-validate:\n+    - when: ExitCode != 0\n+      template: |\n+        ## :x: {{.Vars.tfaction_target}}: terraform validate\n+\n+        {{template \"link\" .}}\n+\n+        {{template \"join_command\" .}}\n+\n+        {{template \"hidden_combined_output\" .}}",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/install%2Fgithub-comment.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/install%2Fgithub-comment.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/install%2Fgithub-comment.yaml?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "e4a2a8429a207228003f6d2d16598a1558dd7d95",
    "filename": "install/tfcmt-drift.yaml",
    "additions": 39,
    "deletions": 0,
    "changes": 39,
    "status": "added",
    "patch": "@@ -0,0 +1,39 @@\n+terraform:\n+  plan:\n+    disable_label: true\n+  apply:\n+    template: |\n+      {{template \"apply_title\" .}}\n+\n+      [Pull Request]({{.Vars.pr_url}}) | {{if .Link}}[CI link]({{.Link}}){{end}}\n+\n+      {{if ne .ExitCode 0}}{{template \"guide_apply_failure\" .}}{{end}}\n+\n+      {{template \"result\" .}}\n+\n+      \u003cdetails\u003e\u003csummary\u003eDetails (Click me)\u003c/summary\u003e\n+      {{wrapCode .CombinedOutput}}\n+      \u003c/details\u003e\n+      {{template \"error_messages\" .}}`\n+    when_parse_error:\n+      template: |\n+        {{template \"apply_title\" .}}\n+\n+        [Pull Request]({{.Vars.pr_url}}) | {{if .Link}}[CI link]({{.Link}}){{end}}\n+\n+        {{template \"guide_apply_parse_error\" .}}\n+\n+        It failed to parse the result.\n+\n+        \u003cdetails\u003e\u003csummary\u003eDetails (Click me)\u003c/summary\u003e\n+        {{wrapCode .CombinedOutput}}\n+        \u003c/details\u003e\n+templates:\n+  plan_title: |\n+    {{if eq .ExitCode 0}}\n+    ## :white_check_mark: No drift is found\n+    {{else if eq .ExitCode 1}}\n+    ## :x: Failed to run `terraform plan`\n+    {{else}}\n+    ## :x: Drift is detected\n+    {{end}}",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/install%2Ftfcmt-drift.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/install%2Ftfcmt-drift.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/install%2Ftfcmt-drift.yaml?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "0ef8ac5900c2e632aa2a97711633b186a0e6da70",
    "filename": "install/tfmigrate-gcs.hcl",
    "additions": 0,
    "deletions": 0,
    "changes": 0,
    "status": "renamed",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/install%2Ftfmigrate-gcs.hcl",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/install%2Ftfmigrate-gcs.hcl",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/install%2Ftfmigrate-gcs.hcl?ref=b563e88c9df0528b43b45881dc8c1e14fe030145",
    "previous_filename": "plan/tfmigrate-gcs.hcl"
  },
  {
    "sha": "f970ad1b698980416949f3c2d3a0af17c5eafc01",
    "filename": "install/tfmigrate.hcl",
    "additions": 0,
    "deletions": 0,
    "changes": 0,
    "status": "renamed",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/install%2Ftfmigrate.hcl",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/install%2Ftfmigrate.hcl",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/install%2Ftfmigrate.hcl?ref=b563e88c9df0528b43b45881dc8c1e14fe030145",
    "previous_filename": "plan/tfmigrate.hcl"
  },
  {
    "sha": "41583e36ca8d2eaf61c855a0500988bb163adc2a",
    "filename": "js/.npmrc",
    "additions": 1,
    "deletions": 0,
    "changes": 1,
    "status": "added",
    "patch": "@@ -0,0 +1 @@\n+@jsr:registry=https://npm.jsr.io",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2F.npmrc",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2F.npmrc",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2F.npmrc?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "f73fc53deeb400f40e951bd1ad614b0061c29f7f",
    "filename": "js/action.yaml",
    "additions": 17,
    "deletions": 10,
    "changes": 27,
    "status": "modified",
    "patch": "@@ -4,16 +4,6 @@ inputs:\n   action:\n     description: action\n     required: true\n-  # check-terraform-skip\n-  labels:\n-    description: \"Labels File\"\n-    required: false\n-  skip_label_prefix:\n-    description: \"Skip Label Prefix\"\n-    required: false\n-  pr_author:\n-    description: \"Pull Request Author\"\n-    required: false\n \n   # list-changed-modules\n   changed_files:\n@@ -80,6 +70,23 @@ inputs:\n     required: false\n     default: \"false\"\n \n+  # commit\n+  commit_message:\n+    description: Commit message for the commit action\n+    required: false\n+  files:\n+    description: Files to commit\n+    required: false\n+  securefix_action_server_repository:\n+    description: Securefix Action Server Repository\n+    required: false\n+  securefix_action_app_id:\n+    description: GitHub App ID\n+    required: false\n+  securefix_action_app_private_key:\n+    description: GitHub App Private Key\n+    required: false\n+\n outputs:\n   # get-target-config\n   working_directory:",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Faction.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Faction.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Faction.yaml?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "cc4598aace40215121ca507c773b38acda0a5289",
    "filename": "js/package-lock.json",
    "additions": 2384,
    "deletions": 311,
    "changes": 2695,
    "status": "modified",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fpackage-lock.json",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fpackage-lock.json",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fpackage-lock.json?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "3923d515bcc2bde587fbf0c1550ba15b8a1cd191",
    "filename": "js/package.json",
    "additions": 4,
    "deletions": 0,
    "changes": 4,
    "status": "modified",
    "patch": "@@ -9,8 +9,12 @@\n     \"@actions/exec\": \"^1.1.1\",\n     \"@actions/github\": \"6.0.1\",\n     \"@aws-sdk/client-secrets-manager\": \"3.940.0\",\n+    \"@csm-actions/securefix-action\": \"npm:@jsr/csm-actions__securefix-action@^0.0.3\",\n+    \"@csm-actions/update-branch-action\": \"npm:@jsr/csm-actions__update-branch-action@^0.0.1\",\n     \"@octokit/core\": \"^7.0.0\",\n     \"@octokit/plugin-paginate-graphql\": \"^6.0.0\",\n+    \"@suzuki-shunsuke/commit-ts\": \"npm:@jsr/suzuki-shunsuke__commit-ts@^0.1.4\",\n+    \"@suzuki-shunsuke/github-app-token\": \"npm:@jsr/suzuki-shunsuke__github-app-token@^0.0.3\",\n     \"@types/json-diff\": \"^1.0.3\",\n     \"glob\": \"11.1.0\",\n     \"js-yaml\": \"4.1.1\",",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fpackage.json",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fpackage.json",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fpackage.json?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "635ce76d5e74248e4467e574c4fa07d73262a55b",
    "filename": "js/src/aqua-update-checksum/index.ts",
    "additions": 1,
    "deletions": 0,
    "changes": 1,
    "status": "added",
    "patch": "@@ -0,0 +1 @@\n+export { main } from \"./run\";",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Faqua-update-checksum%2Findex.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Faqua-update-checksum%2Findex.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Faqua-update-checksum%2Findex.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "3b395e10c579c5923a558a57261a87391cc7439d",
    "filename": "js/src/aqua-update-checksum/run.ts",
    "additions": 207,
    "deletions": 0,
    "changes": 207,
    "status": "added",
    "patch": "@@ -0,0 +1,207 @@\n+import * as core from \"@actions/core\";\n+import * as exec from \"@actions/exec\";\n+import * as github from \"@actions/github\";\n+import * as securefix from \"@csm-actions/securefix-action\";\n+import * as commit from \"@suzuki-shunsuke/commit-ts\";\n+import * as fs from \"fs\";\n+import * as path from \"path\";\n+\n+type Inputs = {\n+  workingDirectory: string;\n+  prune: boolean;\n+  skipPush: boolean;\n+  githubToken: string;\n+  readChecksumToken: string;\n+  securefixActionServerRepository: string;\n+  securefixActionAppId: string;\n+  securefixActionAppPrivateKey: string;\n+};\n+\n+const getInputs = (): Inputs =\u003e {\n+  return {\n+    workingDirectory: core.getInput(\"working_directory\"),\n+    prune: core.getInput(\"prune\") === \"true\",\n+    skipPush: core.getInput(\"skip_push\") === \"true\",\n+    githubToken:\n+      core.getInput(\"github_token\") || process.env.GITHUB_TOKEN || \"\",\n+    readChecksumToken: core.getInput(\"read_checksum_token\"),\n+    securefixActionServerRepository: core.getInput(\n+      \"securefix_action_server_repository\",\n+    ),\n+    securefixActionAppId: core.getInput(\"securefix_action_app_id\"),\n+    securefixActionAppPrivateKey: core.getInput(\n+      \"securefix_action_app_private_key\",\n+    ),\n+  };\n+};\n+\n+const getAquaGitHubToken = (inputs: Inputs): string =\u003e {\n+  if (inputs.readChecksumToken) {\n+    return inputs.readChecksumToken;\n+  }\n+  if (inputs.githubToken) {\n+    return inputs.githubToken;\n+  }\n+  return process.env.AQUA_GITHUB_TOKEN || \"\";\n+};\n+\n+const runAquaUpdateChecksum = async (inputs: Inputs): Promise\u003cvoid\u003e =\u003e {\n+  const args = [\"update-checksum\"];\n+  if (inputs.prune) {\n+    args.push(\"-prune\");\n+  }\n+\n+  const aquaToken = getAquaGitHubToken(inputs);\n+  const options: exec.ExecOptions = {\n+    cwd: inputs.workingDirectory || process.cwd(),\n+  };\n+\n+  if (aquaToken) {\n+    options.env = {\n+      ...process.env,\n+      AQUA_GITHUB_TOKEN: aquaToken,\n+    } as { [key: string]: string };\n+  }\n+\n+  await exec.exec(\"aqua\", args, options);\n+};\n+\n+const findChecksumFile = (workingDir: string): string | null =\u003e {\n+  const candidates = [\n+    \"aqua-checksums.json\",\n+    \".aqua-checksums.json\",\n+    \"aqua/aqua-checksums.json\",\n+    \"aqua/.aqua-checksums.json\",\n+    \".aqua/aqua-checksums.json\",\n+    \".aqua/.aqua-checksums.json\",\n+  ];\n+\n+  for (const candidate of candidates) {\n+    const fullPath = path.join(workingDir, candidate);\n+    if (fs.existsSync(fullPath)) {\n+      return candidate;\n+    }\n+  }\n+\n+  return null;\n+};\n+\n+const checkIfChanged = async (\n+  checksumFile: string,\n+  workingDir: string,\n+): Promise\u003cboolean\u003e =\u003e {\n+  // Check if file is tracked by git\n+  const lsFilesOptions: exec.ExecOptions = {\n+    cwd: workingDir,\n+    ignoreReturnCode: true,\n+    silent: true,\n+  };\n+\n+  const lsFilesExitCode = await exec.exec(\n+    \"git\",\n+    [\"ls-files\", \"--error-unmatch\", \"--\", checksumFile],\n+    lsFilesOptions,\n+  );\n+\n+  if (lsFilesExitCode !== 0) {\n+    // File is not tracked, so it's a new file\n+    return true;\n+  }\n+\n+  // Check if file has changes\n+  const diffOptions: exec.ExecOptions = {\n+    cwd: workingDir,\n+    ignoreReturnCode: true,\n+    silent: true,\n+  };\n+\n+  const diffExitCode = await exec.exec(\n+    \"git\",\n+    [\"diff\", \"--quiet\", \"--\", checksumFile],\n+    diffOptions,\n+  );\n+\n+  // git diff --quiet returns 0 if no changes, 1 if there are changes\n+  return diffExitCode !== 0;\n+};\n+\n+const createCommitIfNeeded = async (\n+  inputs: Inputs,\n+  checksumFile: string,\n+): Promise\u003cvoid\u003e =\u003e {\n+  const fullChecksumFilePath = inputs.workingDirectory\n+    ? path.join(inputs.workingDirectory, checksumFile)\n+    : checksumFile;\n+\n+  const commitMessage = `chore(aqua): update ${checksumFile}`;\n+\n+  if (inputs.securefixActionServerRepository) {\n+    if (!inputs.securefixActionAppId || !inputs.securefixActionAppPrivateKey) {\n+      throw new Error(\n+        \"app_id and app_private_key are required when securefix_action_server_repository is set\",\n+      );\n+    }\n+\n+    await securefix.request({\n+      appId: inputs.securefixActionAppId,\n+      privateKey: inputs.securefixActionAppPrivateKey,\n+      serverRepository: inputs.securefixActionServerRepository,\n+      files: new Set([fullChecksumFilePath]),\n+      commitMessage: commitMessage,\n+      workspace: process.env.GITHUB_WORKSPACE ?? \"\",\n+    });\n+    return;\n+  }\n+\n+  const octokit = github.getOctokit(inputs.githubToken);\n+  await commit.createCommit(octokit, {\n+    owner: github.context.repo.owner,\n+    repo: github.context.repo.repo,\n+    branch: process.env.GITHUB_HEAD_REF || process.env.GITHUB_REF_NAME || \"\",\n+    message: commitMessage,\n+    files: [fullChecksumFilePath],\n+    deleteIfNotExist: true,\n+    logger: {\n+      info: core.info,\n+    },\n+  });\n+};\n+\n+export const main = async () =\u003e {\n+  const inputs = getInputs();\n+\n+  // Run aqua update-checksum\n+  await runAquaUpdateChecksum(inputs);\n+\n+  // Find checksum file\n+  const workingDir = inputs.workingDirectory || process.cwd();\n+  const checksumFile = findChecksumFile(workingDir);\n+\n+  if (!checksumFile) {\n+    throw new Error(\"aqua checksum json file isn't found\");\n+  }\n+\n+  // Set output for checksum_file\n+  const checksumFileOutput = inputs.workingDirectory\n+    ? path.join(inputs.workingDirectory, checksumFile)\n+    : checksumFile;\n+  core.setOutput(\"checksum_file\", checksumFileOutput);\n+\n+  // Check if file has changed\n+  const changed = await checkIfChanged(checksumFile, workingDir);\n+  core.setOutput(\"changed\", changed.toString());\n+\n+  if (!changed) {\n+    core.info(\"No changes to checksum file\");\n+    return;\n+  }\n+\n+  // If skip_push is true and there are changes, fail\n+  if (inputs.skipPush) {\n+    throw new Error(`${checksumFileOutput} isn't latest.`);\n+  }\n+\n+  // Create commit\n+  await createCommitIfNeeded(inputs, checksumFile);\n+  throw new Error(`${checksumFileOutput} is updated.`);\n+};",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Faqua-update-checksum%2Frun.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Faqua-update-checksum%2Frun.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Faqua-update-checksum%2Frun.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "bac21e5074fe91c751a99065e8f0f127460fe137",
    "filename": "js/src/check-terraform-skip/index.ts",
    "additions": 15,
    "deletions": 6,
    "changes": 21,
    "status": "modified",
    "patch": "@@ -1,6 +1,8 @@\n-import * as lib from \"../lib\";\n-import * as core from \"@actions/core\";\n import * as fs from \"fs\";\n+import * as path from \"path\";\n+import * as core from \"@actions/core\";\n+import * as lib from \"../lib\";\n+import * as getGlobalConfig from \"../get-global-config\";\n \n type Inputs = {\n   skipLabelPrefix: string;\n@@ -10,13 +12,20 @@ type Inputs = {\n };\n \n export const main = async () =\u003e {\n+  const config = lib.getConfig();\n+  const globalConfig = getGlobalConfig.main_(config, {});\n+  if (!process.env.CI_INFO_TEMP_DIR) {\n+    throw new Error(\"CI_INFO_TEMP_DIR is not set\");\n+  }\n+  if (!process.env.CI_INFO_PR_AUTHOR) {\n+    throw new Error(\"CI_INFO_PR_AUTHOR is not set\");\n+  }\n   const inputs = {\n-    skipLabelPrefix: core.getInput(\"skip_label_prefix\", { required: true }),\n-    labels: core.getInput(\"labels\", { required: true }),\n-    prAuthor: core.getInput(\"pr_author\", { required: true }),\n+    skipLabelPrefix: globalConfig.outputs.label_prefix_skip,\n+    labels: path.join(process.env.CI_INFO_TEMP_DIR, \"labels.txt\"),\n+    prAuthor: process.env.CI_INFO_PR_AUTHOR,\n     target: process.env.TFACTION_TARGET,\n   };\n-  const config = lib.getConfig();\n   // labels is pull request's labels.\n   const labels = fs.readFileSync(inputs.labels, \"utf8\").split(\"\\n\");\n ",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fcheck-terraform-skip%2Findex.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fcheck-terraform-skip%2Findex.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Fcheck-terraform-skip%2Findex.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "ddd6cea6e8d35a47f91f854c04ce410d84003d0c",
    "filename": "js/src/ci-info/index.ts",
    "additions": 220,
    "deletions": 0,
    "changes": 220,
    "status": "added",
    "patch": "@@ -0,0 +1,220 @@\n+import * as core from \"@actions/core\";\n+import * as github from \"@actions/github\";\n+import * as fs from \"fs/promises\";\n+import * as os from \"os\";\n+import * as path from \"path\";\n+\n+interface PRFile {\n+  filename: string;\n+  previous_filename?: string;\n+}\n+\n+const getPRNumberFromMergeGroup = (): number | undefined =\u003e {\n+  const refName = process.env.GITHUB_REF_NAME;\n+  if (!refName) {\n+    return undefined;\n+  }\n+\n+  // GITHUB_REF_NAME format for merge_group: pr-\u003cnumber\u003e-\u003csha\u003e\n+  // e.g., \"pr-123-abc123\"\n+  const withoutPrefix = refName.replace(/^pr-/, \"\");\n+  const dashIndex = withoutPrefix.indexOf(\"-\");\n+\n+  if (dashIndex === -1) {\n+    core.warning(\n+      `GITHUB_REF_NAME is not a valid merge_group format: ${refName}`,\n+    );\n+    return undefined;\n+  }\n+\n+  const prNumberStr = withoutPrefix.substring(0, dashIndex);\n+  const prNumber = parseInt(prNumberStr, 10);\n+\n+  if (isNaN(prNumber)) {\n+    core.warning(`Failed to parse PR number from GITHUB_REF_NAME: ${refName}`);\n+    return undefined;\n+  }\n+\n+  return prNumber;\n+};\n+\n+const getPRNumberFromSHA = async (\n+  octokit: ReturnType\u003ctypeof github.getOctokit\u003e,\n+  owner: string,\n+  repo: string,\n+  sha: string,\n+): Promise\u003cnumber | undefined\u003e =\u003e {\n+  try {\n+    const { data } =\n+      await octokit.rest.repos.listPullRequestsAssociatedWithCommit({\n+        owner,\n+        repo,\n+        commit_sha: sha,\n+      });\n+\n+    if (data.length === 0) {\n+      return undefined;\n+    }\n+\n+    return data[0].number;\n+  } catch (error) {\n+    core.warning(`Failed to get PR from SHA: ${error}`);\n+    return undefined;\n+  }\n+};\n+\n+const getPRFiles = async (\n+  octokit: ReturnType\u003ctypeof github.getOctokit\u003e,\n+  owner: string,\n+  repo: string,\n+  prNumber: number,\n+): Promise\u003cPRFile[]\u003e =\u003e {\n+  const maxPerPage = 100;\n+  const maxFiles = 3000;\n+  const files: PRFile[] = [];\n+\n+  let page = 1;\n+  while (files.length \u003c maxFiles) {\n+    const { data } = await octokit.rest.pulls.listFiles({\n+      owner,\n+      repo,\n+      pull_number: prNumber,\n+      per_page: maxPerPage,\n+      page,\n+    });\n+\n+    if (data.length === 0) {\n+      break;\n+    }\n+\n+    files.push(\n+      ...data.map((f) =\u003e ({\n+        filename: f.filename,\n+        previous_filename: f.previous_filename,\n+      })),\n+    );\n+\n+    if (data.length \u003c maxPerPage) {\n+      break;\n+    }\n+\n+    page++;\n+\n+    if (files.length \u003e= maxFiles) {\n+      break;\n+    }\n+  }\n+\n+  return files.slice(0, maxFiles);\n+};\n+\n+const setValue = (key: string, value: any) =\u003e {\n+  core.setOutput(key, value);\n+  core.exportVariable(`CI_INFO_${key.toUpperCase()}`, value);\n+};\n+\n+const writeOutputFiles = async (dir: string, prData: any, files: PRFile[]) =\u003e {\n+  await fs.mkdir(dir, { recursive: true });\n+\n+  // Write pr.json\n+  await fs.writeFile(\n+    path.join(dir, \"pr.json\"),\n+    JSON.stringify(prData, null, 2),\n+  );\n+\n+  // Write pr_files.json\n+  await fs.writeFile(\n+    path.join(dir, \"pr_files.json\"),\n+    JSON.stringify(files, null, 2),\n+  );\n+\n+  // Write pr_files.txt\n+  const filenames = files.map((f) =\u003e f.filename).join(\"\\n\");\n+  await fs.writeFile(path.join(dir, \"pr_files.txt\"), filenames);\n+\n+  // Write pr_all_filenames.txt (including previous_filename for renames)\n+  const allFilenames = new Set\u003cstring\u003e();\n+  files.forEach((f) =\u003e {\n+    allFilenames.add(f.filename);\n+    if (f.previous_filename) {\n+      allFilenames.add(f.previous_filename);\n+    }\n+  });\n+  await fs.writeFile(\n+    path.join(dir, \"pr_all_filenames.txt\"),\n+    Array.from(allFilenames).join(\"\\n\"),\n+  );\n+\n+  // Write labels.txt\n+  const labels = (prData.labels || []).map((l: any) =\u003e l.name).join(\"\\n\");\n+  await fs.writeFile(path.join(dir, \"labels.txt\"), labels);\n+};\n+\n+export const main = async () =\u003e {\n+  setValue(\"repo_owner\", github.context.repo.owner);\n+  setValue(\"repo_name\", github.context.repo.repo);\n+\n+  // Determine PR number\n+  let prNumber = github.context.payload.pull_request?.number;\n+  // Try to get PR number from merge_group event\n+  if (!prNumber \u0026\u0026 github.context.eventName === \"merge_group\") {\n+    core.info(\"Attempting to get PR number from merge_group event\");\n+    prNumber = getPRNumberFromMergeGroup();\n+  }\n+  setValue(\"is_pr\", prNumber !== undefined);\n+\n+  const octokit = github.getOctokit(\n+    core.getInput(\"github_token\", {\n+      required: true,\n+    }),\n+  );\n+\n+  // Try to get PR number from SHA\n+  if (!prNumber) {\n+    prNumber = await getPRNumberFromSHA(\n+      octokit,\n+      github.context.repo.owner,\n+      github.context.repo.repo,\n+      github.context.sha,\n+    );\n+  }\n+  setValue(\"has_associated_pr\", prNumber !== undefined);\n+\n+  if (!prNumber) {\n+    core.info(\"No PR number found - running in non-PR environment\");\n+    return;\n+  }\n+  setValue(\"pr_number\", prNumber);\n+\n+  // Get PR details\n+  core.info(`Fetching PR #${prNumber}`);\n+  const { data: prData } = await octokit.rest.pulls.get({\n+    owner: github.context.repo.owner,\n+    repo: github.context.repo.repo,\n+    pull_number: prNumber,\n+  });\n+\n+  setValue(\"base_ref\", prData.base.ref);\n+  setValue(\"head_ref\", prData.head.ref);\n+  setValue(\"pr_author\", prData.user.login);\n+  setValue(\"pr_merged\", prData.merged);\n+\n+  // Get PR files\n+  core.info(\"Fetching PR files\");\n+  const files = await getPRFiles(\n+    octokit,\n+    github.context.repo.owner,\n+    github.context.repo.repo,\n+    prNumber,\n+  );\n+  core.info(`Found ${files.length} files`);\n+\n+  // Determine output directory\n+  const outputDir = await fs.mkdtemp(path.join(os.tmpdir(), \"ci-info\"));\n+  setValue(\"temp_dir\", outputDir);\n+  // Write output files\n+  await writeOutputFiles(outputDir, prData, files);\n+  core.info(`Output files written to: ${outputDir}`);\n+\n+  core.info(\"CI info collection completed successfully\");\n+};",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fci-info%2Findex.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fci-info%2Findex.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Fci-info%2Findex.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "54aea56f772c6fed9402c529de85001d93768329",
    "filename": "js/src/commit/index.ts",
    "additions": 64,
    "deletions": 0,
    "changes": 64,
    "status": "added",
    "patch": "@@ -0,0 +1,64 @@\n+import * as core from \"@actions/core\";\n+import * as github from \"@actions/github\";\n+import * as securefix from \"@csm-actions/securefix-action\";\n+import * as commit from \"@suzuki-shunsuke/commit-ts\";\n+\n+type Inputs = {\n+  commitMessage: string;\n+  githubToken: string;\n+  files: Set\u003cstring\u003e;\n+  serverRepository: string;\n+  appId: string;\n+  appPrivateKey: string;\n+};\n+\n+export const create = async (inputs: Inputs) =\u003e {\n+  if (inputs.serverRepository) {\n+    if (!inputs.appId || !inputs.appPrivateKey) {\n+      throw new Error(\n+        \"app_id and app_private_key are required when securefix_action_server_repository is set\",\n+      );\n+    }\n+\n+    await securefix.request({\n+      appId: inputs.appId,\n+      privateKey: inputs.appPrivateKey,\n+      serverRepository: inputs.serverRepository,\n+      files: inputs.files,\n+      commitMessage: inputs.commitMessage,\n+      workspace: process.env.GITHUB_WORKSPACE ?? \"\",\n+    });\n+    return;\n+  }\n+\n+  const octokit = github.getOctokit(inputs.githubToken);\n+  await commit.createCommit(octokit, {\n+    owner: github.context.repo.owner,\n+    repo: github.context.repo.repo,\n+    branch: process.env.GITHUB_HEAD_REF || process.env.GITHUB_REF_NAME || \"\",\n+    message: inputs.commitMessage,\n+    files: [...inputs.files],\n+    deleteIfNotExist: true,\n+    logger: {\n+      info: core.info,\n+    },\n+  });\n+};\n+\n+export const main = async () =\u003e {\n+  const inputs: Inputs = {\n+    commitMessage: core.getInput(\"commit_message\", { required: true }),\n+    githubToken: core.getInput(\"github_token\"),\n+    files: new Set(\n+      core\n+        .getInput(\"files\")\n+        .split(\"\\n\")\n+        .map((s) =\u003e s.trim())\n+        .filter((s) =\u003e s.length \u003e 0),\n+    ),\n+    serverRepository: core.getInput(\"securefix_action_server_repository\"),\n+    appId: core.getInput(\"securefix_action_app_id\"),\n+    appPrivateKey: core.getInput(\"securefix_action_app_private_key\"),\n+  };\n+  await create(inputs);\n+};",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fcommit%2Findex.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fcommit%2Findex.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Fcommit%2Findex.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "635ce76d5e74248e4467e574c4fa07d73262a55b",
    "filename": "js/src/download-plan/index.ts",
    "additions": 1,
    "deletions": 0,
    "changes": 1,
    "status": "added",
    "patch": "@@ -0,0 +1 @@\n+export { main } from \"./run\";",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fdownload-plan%2Findex.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fdownload-plan%2Findex.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Fdownload-plan%2Findex.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "c240c28b1e4ae6138201e59ce6ee99112e5c4614",
    "filename": "js/src/download-plan/run.ts",
    "additions": 150,
    "deletions": 0,
    "changes": 150,
    "status": "added",
    "patch": "@@ -0,0 +1,150 @@\n+import * as exec from \"@actions/exec\";\n+import * as core from \"@actions/core\";\n+import * as github from \"@actions/github\";\n+import * as fs from \"fs\";\n+import * as os from \"os\";\n+import * as path from \"path\";\n+import * as lib from \"../lib\";\n+import {\n+  DefaultArtifactClient,\n+  FindOptions,\n+  DownloadArtifactOptions,\n+} from \"@actions/artifact\";\n+\n+type WorkflowRun = {\n+  headSha: string;\n+  databaseId: number;\n+};\n+\n+const downloadArtifact = async (\n+  token: string,\n+  owner: string,\n+  repo: string,\n+  runId: number,\n+  artifactName: string,\n+  dest: string,\n+): Promise\u003cvoid\u003e =\u003e {\n+  // Download a GitHub Actions Artifact\n+  const artifact = new DefaultArtifactClient();\n+  core.info(`Getting an artifact`);\n+  const artifactOpts: DownloadArtifactOptions \u0026 FindOptions = {\n+    findBy: {\n+      token: token,\n+      repositoryOwner: owner,\n+      repositoryName: repo,\n+      workflowRunId: runId,\n+    },\n+    path: dest,\n+  };\n+  const { artifact: targetArtifact } = await artifact.getArtifact(\n+    artifactName,\n+    artifactOpts,\n+  );\n+  if (!targetArtifact) {\n+    core.setFailed(`Artifact '${artifactName}' not found`);\n+    return;\n+  }\n+  core.info(`Downloading an artifact`);\n+  await artifact.downloadArtifact(targetArtifact.id, artifactOpts);\n+};\n+\n+export const main = async (): Promise\u003cvoid\u003e =\u003e {\n+  const cfg = lib.getConfig();\n+  const githubToken = core.getInput(\"github_token\");\n+  const target = process.env.TFACTION_TARGET || \"\";\n+  const planWorkflowName = cfg.plan_workflow_name;\n+  const ciInfoTempDir = process.env.CI_INFO_TEMP_DIR || \"\";\n+  const branch = process.env.CI_INFO_HEAD_REF || \"\";\n+\n+  const filename = \"tfplan.binary\";\n+  const artifactName = `terraform_plan_file_${target.replaceAll(\"/\", \"__\")}`;\n+\n+  // Get PR head SHA\n+  const prJsonPath = path.join(ciInfoTempDir, \"pr.json\");\n+  const prJson = JSON.parse(fs.readFileSync(prJsonPath, \"utf8\"));\n+  const prHeadSha = prJson.head.sha;\n+\n+  // Get workflow run\n+  const octokit = github.getOctokit(githubToken);\n+  const { data: workflowRuns } = await octokit.rest.actions.listWorkflowRuns({\n+    owner: github.context.repo.owner,\n+    repo: github.context.repo.repo,\n+    workflow_id: planWorkflowName,\n+    branch: branch,\n+    per_page: 1,\n+  });\n+\n+  if (workflowRuns.workflow_runs.length === 0) {\n+    await exec.exec(\n+      \"github-comment\",\n+      [\n+        \"post\",\n+        \"-var\",\n+        `tfaction_target:${target}`,\n+        \"-var\",\n+        `plan_workflow_name:${planWorkflowName}`,\n+        \"-var\",\n+        `branch:${branch}`,\n+        \"-k\",\n+        \"no-workflow-run-found\",\n+      ],\n+      {\n+        env: {\n+          ...process.env,\n+          GITHUB_TOKEN: githubToken,\n+        },\n+      },\n+    );\n+    throw new Error(\"No workflow run is found\");\n+  }\n+\n+  const latestRun = workflowRuns.workflow_runs[0];\n+  const workflowRun: WorkflowRun = {\n+    headSha: latestRun.head_sha,\n+    databaseId: latestRun.id,\n+  };\n+  const runId = workflowRun.databaseId;\n+  const headSha = workflowRun.headSha;\n+\n+  // Check if headSha matches\n+  if (headSha !== prHeadSha) {\n+    await exec.exec(\n+      \"github-comment\",\n+      [\n+        \"post\",\n+        \"-var\",\n+        `tfaction_target:${target}`,\n+        \"-var\",\n+        `wf_sha:${headSha}`,\n+        \"-var\",\n+        `pr_sha:${prHeadSha}`,\n+        \"-k\",\n+        \"invalid-workflow-sha\",\n+      ],\n+      {\n+        env: {\n+          ...process.env,\n+          GITHUB_TOKEN: githubToken,\n+        },\n+      },\n+    );\n+    throw new Error(\n+      `workflow run's headSha (${headSha}) is different from the associated pull request's head sha (${prHeadSha})`,\n+    );\n+  }\n+\n+  // Download artifact\n+  const tempDir = fs.mkdtempSync(path.join(os.tmpdir(), \"tfaction-\"));\n+\n+  await downloadArtifact(\n+    githubToken,\n+    github.context.repo.owner,\n+    github.context.repo.repo,\n+    runId,\n+    artifactName,\n+    tempDir,\n+  );\n+\n+  const sourcePath = path.join(tempDir, filename);\n+  core.setOutput(\"plan_file_path\", sourcePath);\n+};",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fdownload-plan%2Frun.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fdownload-plan%2Frun.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Fdownload-plan%2Frun.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "2cbab0905bbdb934e23cdfb086410ceeab33a6eb",
    "filename": "js/src/get-global-config/index.test.ts",
    "additions": 0,
    "deletions": 3,
    "changes": 3,
    "status": "modified",
    "patch": "@@ -50,7 +50,6 @@ test(\"default\", () =\u003e {\n         target_groups: [],\n       },\n       {\n-        repository: \"\",\n         drift_issue_number: \"\",\n       },\n     ),\n@@ -68,7 +67,6 @@ test(\"plan_workflow_name is required\", () =\u003e {\n         target_groups: [],\n       },\n       {\n-        repository: \"\",\n         drift_issue_number: \"\",\n       },\n     );\n@@ -133,7 +131,6 @@ test(\"customize\", () =\u003e {\n         terraform_command: \"tofu\",\n       },\n       {\n-        repository: \"\",\n         drift_issue_number: \"\",\n       },\n     ),",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fget-global-config%2Findex.test.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fget-global-config%2Findex.test.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Fget-global-config%2Findex.test.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "502f3f4c78c2b688dabfd40d764b8e6872692da1",
    "filename": "js/src/get-global-config/index.ts",
    "additions": 10,
    "deletions": 17,
    "changes": 27,
    "status": "modified",
    "patch": "@@ -1,10 +1,10 @@\n import * as core from \"@actions/core\";\n+import * as github from \"@actions/github\";\n import * as lib from \"../lib\";\n \n export const main = async () =\u003e {\n   const config = lib.getConfig();\n   const result = main_(config, {\n-    repository: process.env.GITHUB_REPOSITORY,\n     drift_issue_number: process.env.TFACTION_DRIFT_ISSUE_NUMBER,\n   });\n   for (const [key, value] of Object.entries(result.envs)) {\n@@ -16,7 +16,6 @@ export const main = async () =\u003e {\n };\n \n interface Input {\n-  repository?: string;\n   drift_issue_number?: string;\n }\n \n@@ -124,22 +123,16 @@ export const main_ = (config: lib.Config, input: Input): Result =\u003e {\n       config?.scaffold_working_directory?.skip_adding_aqua_packages ?? true,\n   };\n \n-  if (config.drift_detection \u0026\u0026 config.drift_detection.issue_repo_owner) {\n-    outputs.drift_issue_repo_owner = config.drift_detection.issue_repo_owner;\n-  } else {\n-    if (input.repository) {\n-      outputs.drift_issue_repo_owner = input.repository.split(\"/\")[0];\n+  if (config.drift_detection) {\n+    if (config.drift_detection.issue_repo_owner) {\n+      outputs.drift_issue_repo_owner = config.drift_detection.issue_repo_owner;\n+    } else {\n+      outputs.drift_issue_repo_owner = github.context.repo.owner;\n     }\n-  }\n-\n-  if (config.drift_detection \u0026\u0026 config.drift_detection.issue_repo_name) {\n-    outputs.drift_issue_repo_name = config.drift_detection.issue_repo_name;\n-  } else {\n-    if (input.repository) {\n-      const a = input.repository.split(\"/\");\n-      if (a.length \u003e 1) {\n-        outputs.drift_issue_repo_name = a[1];\n-      }\n+    if (config.drift_detection.issue_repo_name) {\n+      outputs.drift_issue_repo_name = config.drift_detection.issue_repo_name;\n+    } else {\n+      outputs.drift_issue_repo_name = github.context.repo.repo;\n     }\n   }\n ",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fget-global-config%2Findex.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fget-global-config%2Findex.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Fget-global-config%2Findex.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "706c4317058a4d83da04e20e98d0a82ccc67c8c3",
    "filename": "js/src/list-module-callers/index.ts",
    "additions": 19,
    "deletions": 6,
    "changes": 25,
    "status": "modified",
    "patch": "@@ -4,7 +4,11 @@ import * as tmp from \"tmp\";\n import * as semver from \"semver\";\n import * as core from \"@actions/core\";\n import * as exec from \"@actions/exec\";\n-import { buildModuleToCallers, resolveRelativeCallTree } from \"./lib\";\n+import {\n+  buildModuleToCallers,\n+  resolveRelativeCallTree,\n+  ModuleToCallers,\n+} from \"./lib\";\n \n export const main = async () =\u003e {\n   const configFiles = fs\n@@ -16,6 +20,19 @@ export const main = async () =\u003e {\n     .trim()\n     .split(\"\\n\");\n \n+  const moduleCallers = await list(configFiles, moduleFiles);\n+\n+  const json = JSON.stringify(moduleCallers);\n+  core.info(`file: ${json}`);\n+  const tmpobj = tmp.fileSync();\n+  fs.writeFileSync(tmpobj.name, json);\n+  core.setOutput(\"file\", tmpobj.name);\n+};\n+\n+export const list = async (\n+  configFiles: string[],\n+  moduleFiles: string[],\n+): Promise\u003cModuleToCallers\u003e =\u003e {\n   // directory where uses modules =\u003e used modules\n   const rawModuleCalls: Record\u003cstring, Array\u003cstring\u003e\u003e = {};\n \n@@ -121,9 +138,5 @@ export const main = async () =\u003e {\n   const moduleCallers = buildModuleToCallers(\n     resolveRelativeCallTree(rawModuleCalls),\n   );\n-  const json = JSON.stringify(moduleCallers);\n-  core.info(`file: ${json}`);\n-  const tmpobj = tmp.fileSync();\n-  fs.writeFileSync(tmpobj.name, json);\n-  core.setOutput(\"file\", tmpobj.name);\n+  return moduleCallers;\n };",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Flist-module-callers%2Findex.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Flist-module-callers%2Findex.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Flist-module-callers%2Findex.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "62c1de4d74d35dd65941a863034ee2ca79ce25a9",
    "filename": "js/src/list-module-callers/lib.ts",
    "additions": 1,
    "deletions": 1,
    "changes": 2,
    "status": "modified",
    "patch": "@@ -2,7 +2,7 @@ import path from \"node:path\";\n \n type ModuleCalls = Record\u003cstring, string[]\u003e; // directory where uses modules =\u003e modules which are used\n \n-type ModuleToCallers = Record\u003cstring, string[]\u003e; // module =\u003e directories where use the module\n+export type ModuleToCallers = Record\u003cstring, string[]\u003e; // module =\u003e directories where use the module\n \n export function resolveRelativeCallTree(\n   rawModuleCalls: ModuleCalls,",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Flist-module-callers%2Flib.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Flist-module-callers%2Flib.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Flist-module-callers%2Flib.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "649b600a7db0bc02c485e828597162bab8eca75f",
    "filename": "js/src/list-targets-with-changed-files/index.ts",
    "additions": 36,
    "deletions": 17,
    "changes": 53,
    "status": "modified",
    "patch": "@@ -4,6 +4,9 @@ import * as exec from \"@actions/exec\";\n import * as fs from \"fs\";\n import * as path from \"path\";\n import * as lib from \"../lib\";\n+import * as getGlobalConfig from \"../get-global-config\";\n+import { listFiles } from \"../list-working-dirs\";\n+import { list as listModuleCallers } from \"../list-module-callers\";\n \n type TargetConfig = {\n   target: string;\n@@ -371,27 +374,45 @@ const handleLabels = (\n \n export const main = async () =\u003e {\n   // The path to ci-info's pr.json.\n-  const prPath = core.getInput(\"pull_request\");\n+  if (!process.env.CI_INFO_TEMP_DIR) {\n+    throw new Error(\"CI_INFO_TEMP_DIR is not set\");\n+  }\n+  const prPath = `${process.env.CI_INFO_TEMP_DIR}/pr.json`;\n   const pr = prPath ? fs.readFileSync(prPath, \"utf8\") : \"\";\n-  const moduleCallersPath = core.getInput(\"module_callers\");\n+  const cfg = lib.getConfig();\n+  const globalConfig = await getGlobalConfig.main_(cfg, {});\n+\n+  const baseWorkingDirectory = globalConfig.outputs.base_working_directory;\n+  const workingDirectoryFile = globalConfig.outputs.working_directory_file;\n+\n+  const configFiles = await listFiles(\n+    baseWorkingDirectory,\n+    workingDirectoryFile,\n+  );\n+\n+  const moduleBaseDirectory = globalConfig.outputs.module_base_directory;\n+  const moduleFile = globalConfig.outputs.module_file;\n+  const modules = await listFiles(moduleBaseDirectory, moduleFile);\n+\n+  const moduleCallers = await listModuleCallers(configFiles, modules);\n \n   const result = await run({\n-    labels: fs.readFileSync(core.getInput(\"labels\"), \"utf8\").split(\"\\n\"),\n+    labels: fs\n+      .readFileSync(`${process.env.CI_INFO_TEMP_DIR}/labels.txt`, \"utf8\")\n+      .split(\"\\n\"),\n     config: lib.getConfig(),\n     isApply: lib.getIsApply(),\n     changedFiles: fs\n-      .readFileSync(core.getInput(\"changed_files\"), \"utf8\")\n-      .split(\"\\n\"),\n-    configFiles: fs\n-      .readFileSync(core.getInput(\"config_files\"), \"utf8\")\n-      .split(\"\\n\"),\n-    moduleFiles: fs\n-      .readFileSync(core.getInput(\"module_files\"), \"utf8\")\n+      .readFileSync(\n+        `${process.env.CI_INFO_TEMP_DIR}/pr_all_filenames.txt`,\n+        \"utf8\",\n+      )\n       .split(\"\\n\"),\n-    maxChangedWorkingDirectories: parseInt(\n-      core.getInput(\"max_changed_working_dirs\"),\n-    ),\n-    maxChangedModules: parseInt(core.getInput(\"max_changed_modules\")),\n+    configFiles,\n+    moduleFiles: modules,\n+    maxChangedWorkingDirectories:\n+      globalConfig.outputs.max_changed_working_dirs ?? 0,\n+    maxChangedModules: globalConfig.outputs.max_changed_modules ?? 0,\n     pr,\n     payload: github.context.payload,\n     githubToken: core.getInput(\"github_token\", { required: true }),\n@@ -401,9 +422,7 @@ export const main = async () =\u003e {\n       module1: [caller1, caller2],\n     }\n     */\n-    moduleCallers: moduleCallersPath\n-      ? JSON.parse(fs.readFileSync(moduleCallersPath, \"utf8\"))\n-      : {},\n+    moduleCallers,\n   });\n \n   core.info(`result: ${JSON.stringify(result)}`);",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Flist-targets-with-changed-files%2Findex.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Flist-targets-with-changed-files%2Findex.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Flist-targets-with-changed-files%2Findex.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "fbe4540be596dfd3f835207d47e053230dd8b0ab",
    "filename": "js/src/list-working-dirs/index.ts",
    "additions": 1,
    "deletions": 0,
    "changes": 1,
    "status": "added",
    "patch": "@@ -0,0 +1 @@\n+export { main, listFiles } from \"./run\";",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Flist-working-dirs%2Findex.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Flist-working-dirs%2Findex.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Flist-working-dirs%2Findex.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "81d5e602a4ca8b56499e09a716150dce6d20b114",
    "filename": "js/src/list-working-dirs/run.ts",
    "additions": 73,
    "deletions": 0,
    "changes": 73,
    "status": "added",
    "patch": "@@ -0,0 +1,73 @@\n+import * as exec from \"@actions/exec\";\n+import * as core from \"@actions/core\";\n+import * as fs from \"fs\";\n+import * as os from \"os\";\n+import * as path from \"path\";\n+import * as lib from \"../lib\";\n+import * as getGlobalConfig from \"../get-global-config\";\n+\n+export const listFiles = async (\n+  baseDir: string,\n+  fileName: string,\n+): Promise\u003cstring[]\u003e =\u003e {\n+  // Run git ls-files\n+  const result = await exec.getExecOutput(\"git\", [\"ls-files\", baseDir], {\n+    ignoreReturnCode: true,\n+  });\n+\n+  const arr: string[] = [];\n+  for (const line of result.stderr.split(\"\\n\").map((l) =\u003e l.trim())) {\n+    if (line === \"\") {\n+      continue;\n+    }\n+    if (path.basename(line) === fileName) {\n+      arr.push(line);\n+    }\n+  }\n+  return arr;\n+};\n+\n+export const main = async (): Promise\u003cvoid\u003e =\u003e {\n+  // Get global config\n+  const config = lib.getConfig();\n+  const globalConfigResult = getGlobalConfig.main_(config, {\n+    drift_issue_number: process.env.TFACTION_DRIFT_ISSUE_NUMBER,\n+  });\n+\n+  const baseWorkingDirectory =\n+    globalConfigResult.outputs.base_working_directory;\n+  const workingDirectoryFile =\n+    globalConfigResult.outputs.working_directory_file;\n+  const moduleBaseDirectory = globalConfigResult.outputs.module_base_directory;\n+  const moduleFile = globalConfigResult.outputs.module_file;\n+\n+  // List working directories\n+  const workingDirs = await listFiles(\n+    baseWorkingDirectory,\n+    workingDirectoryFile,\n+  );\n+\n+  // Write to temp file\n+  const tempDir = fs.mkdtempSync(path.join(os.tmpdir(), \"tfaction-\"));\n+  const workingDirFile = path.join(tempDir, \"working-dirs.txt\");\n+  fs.writeFileSync(workingDirFile, workingDirs.join(\"\\n\"));\n+\n+  // Output to stderr (for debugging)\n+  core.info(workingDirs.join(\"\\n\"));\n+\n+  // Set output\n+  core.setOutput(\"file\", workingDirFile);\n+\n+  // List modules\n+  const modules = await listFiles(moduleBaseDirectory, moduleFile);\n+\n+  // Write to temp file\n+  const moduleFilePath = path.join(tempDir, \"modules.txt\");\n+  fs.writeFileSync(moduleFilePath, modules.join(\"\\n\"));\n+\n+  // Output to stderr (for debugging)\n+  core.info(modules.join(\"\\n\"));\n+\n+  // Set output\n+  core.setOutput(\"module_file\", moduleFilePath);\n+};",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Flist-working-dirs%2Frun.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Flist-working-dirs%2Frun.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Flist-working-dirs%2Frun.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "635ce76d5e74248e4467e574c4fa07d73262a55b",
    "filename": "js/src/plan/index.ts",
    "additions": 1,
    "deletions": 0,
    "changes": 1,
    "status": "added",
    "patch": "@@ -0,0 +1 @@\n+export { main } from \"./run\";",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fplan%2Findex.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fplan%2Findex.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Fplan%2Findex.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "f6e2904b16f1f96b883a00186eef21411e97e835",
    "filename": "js/src/plan/run.ts",
    "additions": 391,
    "deletions": 0,
    "changes": 391,
    "status": "added",
    "patch": "@@ -0,0 +1,391 @@\n+import * as exec from \"@actions/exec\";\n+import * as core from \"@actions/core\";\n+import * as fs from \"fs\";\n+import * as os from \"os\";\n+import * as path from \"path\";\n+import { DefaultArtifactClient } from \"@actions/artifact\";\n+import * as lib from \"../lib\";\n+import * as getGlobalConfig from \"../get-global-config\";\n+import * as getTargetConfig from \"../get-target-config\";\n+\n+type Inputs = {\n+  githubToken: string;\n+  workingDirectory: string;\n+  renovateLogin: string;\n+  destroy: boolean;\n+  conftestPolicyDirectory?: string;\n+  tfCommand: string;\n+  target: string;\n+  driftIssueNumber?: string;\n+  prAuthor?: string;\n+  ciInfoTempDir?: string;\n+  s3BucketNameTfmigrateHistory?: string;\n+  gcsBucketNameTfmigrateHistory?: string;\n+};\n+\n+type TerraformPlanOutputs = {\n+  detailedExitcode: number;\n+  planBinary: string;\n+  planJson: string;\n+  skipped?: boolean;\n+};\n+\n+type TfmigratePlanOutputs = {\n+  changed?: boolean;\n+  planBinary?: string;\n+  planJson?: string;\n+};\n+\n+const validateRenovateChange = async (inputs: Inputs): Promise\u003cvoid\u003e =\u003e {\n+  // Skip if not a renovate PR\n+  if (inputs.prAuthor !== inputs.renovateLogin) {\n+    return;\n+  }\n+\n+  // Check if renovate-change label exists\n+  const labelsFile = path.join(inputs.ciInfoTempDir || \"\", \"labels.txt\");\n+  if (!fs.existsSync(labelsFile)) {\n+    core.warning(`Labels file not found: ${labelsFile}`);\n+    return;\n+  }\n+\n+  const labels = fs.readFileSync(labelsFile, \"utf8\").split(\"\\n\");\n+  const hasRenovateChangeLabel = labels.some(\n+    (label) =\u003e label.trim() === \"renovate-change\",\n+  );\n+\n+  if (hasRenovateChangeLabel) {\n+    return;\n+  }\n+\n+  await exec.exec(\n+    \"github-comment\",\n+    [\n+      \"post\",\n+      \"-var\",\n+      `tfaction_target:${inputs.target}`,\n+      \"-k\",\n+      \"renovate-plan-change\",\n+    ],\n+    {\n+      env: {\n+        ...process.env,\n+        GITHUB_TOKEN: inputs.githubToken,\n+      },\n+    },\n+  );\n+\n+  throw new Error(\n+    \"Renovate PR must have 'No change' or 'renovate-change' label\",\n+  );\n+};\n+\n+const generateTfmigrateHcl = async (inputs: Inputs): Promise\u003cboolean\u003e =\u003e {\n+  const tfmigrateHclPath = path.join(inputs.workingDirectory, \".tfmigrate.hcl\");\n+\n+  // Check if .tfmigrate.hcl already exists\n+  if (fs.existsSync(tfmigrateHclPath)) {\n+    return false;\n+  }\n+\n+  const installDir = process.env.TFACTION_INSTALL_DIR || \"\";\n+  let templatePath = \"\";\n+  let content = \"\";\n+\n+  // Generate from S3 template\n+  if (inputs.s3BucketNameTfmigrateHistory) {\n+    templatePath = path.join(installDir, \"tfmigrate.hcl\");\n+    content = fs.readFileSync(templatePath, \"utf8\");\n+    content = content.replace(/%%TARGET%%/g, inputs.target);\n+    content = content.replace(\n+      /%%S3_BUCKET_NAME_TFMIGRATE_HISTORY%%/g,\n+      inputs.s3BucketNameTfmigrateHistory,\n+    );\n+  }\n+  // Generate from GCS template\n+  else if (inputs.gcsBucketNameTfmigrateHistory) {\n+    templatePath = path.join(installDir, \"tfmigrate-gcs.hcl\");\n+    content = fs.readFileSync(templatePath, \"utf8\");\n+    content = content.replace(/%%TARGET%%/g, inputs.target);\n+    content = content.replace(\n+      /%%GCS_BUCKET_NAME_TFMIGRATE_HISTORY%%/g,\n+      inputs.gcsBucketNameTfmigrateHistory,\n+    );\n+  }\n+  // Error: neither S3 nor GCS bucket is configured\n+  else {\n+    const commentConfig = path.join(installDir, \"github-comment.yaml\");\n+    await exec.exec(\n+      \"github-comment\",\n+      [\n+        \"post\",\n+        \"--config\",\n+        commentConfig,\n+        \"-var\",\n+        `tfaction_target:${inputs.target}`,\n+        \"-k\",\n+        \"tfmigrate-hcl-not-found\",\n+      ],\n+      {\n+        env: {\n+          ...process.env,\n+          GITHUB_TOKEN: inputs.githubToken,\n+        },\n+      },\n+    );\n+    throw new Error(\n+      \".tfmigrate.hcl is required but neither S3 nor GCS bucket is configured\",\n+    );\n+  }\n+\n+  // Write .tfmigrate.hcl\n+  fs.writeFileSync(tfmigrateHclPath, content);\n+  return true;\n+};\n+\n+export const runTfmigratePlan = async (\n+  inputs: Inputs,\n+): Promise\u003cTfmigratePlanOutputs\u003e =\u003e {\n+  // Generate .tfmigrate.hcl if it doesn't exist\n+  const wasCreated = await generateTfmigrateHcl(inputs);\n+  if (wasCreated) {\n+    // Early exit: .tfmigrate.hcl was just created\n+    core.setOutput(\"changed\", \"true\");\n+    return { changed: true };\n+  }\n+\n+  // Create temp directory and copy plan files\n+  const tempDir = fs.mkdtempSync(path.join(os.tmpdir(), \"tfaction-\"));\n+  const tempPlanBinary = path.join(tempDir, \"tfplan.binary\");\n+  const tempPlanJson = path.join(tempDir, \"tfplan.json\");\n+\n+  // Run tfmigrate plan\n+  core.startGroup(\"tfmigrate plan\");\n+\n+  const env: { [key: string]: string } = {\n+    ...process.env,\n+    GITHUB_TOKEN: inputs.githubToken,\n+  };\n+  // Set TFMIGRATE_EXEC_PATH if TF_COMMAND is not \"terraform\"\n+  if (!process.env.TFMIGRATE_EXEC_PATH \u0026\u0026 inputs.tfCommand !== \"terraform\") {\n+    env.TFMIGRATE_EXEC_PATH = inputs.tfCommand;\n+  }\n+\n+  await exec.exec(\n+    \"github-comment\",\n+    [\n+      \"exec\",\n+      \"-var\",\n+      `tfaction_target:${inputs.target}`,\n+      \"-k\",\n+      \"tfmigrate-plan\",\n+      \"--\",\n+      \"tfmigrate\",\n+      \"plan\",\n+      \"--out\",\n+      tempPlanBinary,\n+    ],\n+    {\n+      cwd: inputs.workingDirectory,\n+      env: env,\n+    },\n+  );\n+  core.endGroup();\n+\n+  // Run terraform show to convert plan to JSON\n+  core.startGroup(`${inputs.tfCommand} show`);\n+  const planJsonPath = path.join(inputs.workingDirectory, \"tfplan.json\");\n+\n+  await exec.exec(\n+    \"github-comment\",\n+    [\"exec\", \"--\", inputs.tfCommand, \"show\", \"-json\", tempPlanBinary],\n+    {\n+      cwd: inputs.workingDirectory,\n+      env: {\n+        ...process.env,\n+        GITHUB_TOKEN: inputs.githubToken,\n+      },\n+      outStream: fs.createWriteStream(tempPlanJson),\n+    },\n+  );\n+  core.endGroup();\n+\n+  core.setOutput(\"plan_json\", tempPlanJson);\n+  core.setOutput(\"plan_binary\", tempPlanBinary);\n+\n+  return {\n+    planBinary: tempPlanBinary,\n+    planJson: tempPlanJson,\n+  };\n+};\n+\n+export const runTerraformPlan = async (\n+  inputs: Inputs,\n+): Promise\u003cTerraformPlanOutputs\u003e =\u003e {\n+  const installDir = process.env.TFACTION_INSTALL_DIR || \"\";\n+\n+  // Run terraform plan with tfcmt\n+  core.startGroup(`${inputs.tfCommand} plan`);\n+\n+  // Create temp directory and copy plan binary\n+  const tempDir = fs.mkdtempSync(path.join(os.tmpdir(), \"tfaction-\"));\n+  const tempPlanBinary = path.join(tempDir, \"tfplan.binary\");\n+  const tempPlanJson = path.join(tempDir, \"tfplan.json\");\n+\n+  const planArgs = [\n+    \"-var\",\n+    `target:${inputs.target}`,\n+    \"-var\",\n+    `destroy:${inputs.destroy}`,\n+  ];\n+  // Set TFCMT_CONFIG for drift detection mode\n+  if (inputs.driftIssueNumber) {\n+    planArgs.push(\"-config\", path.join(installDir, \"tfcmt-drift.yaml\"));\n+  }\n+  planArgs.push(\n+    \"plan\",\n+    \"--\",\n+    inputs.tfCommand,\n+    \"plan\",\n+    \"-no-color\",\n+    \"-detailed-exitcode\",\n+    \"-out\",\n+    tempPlanBinary,\n+    \"-input=false\",\n+  );\n+  if (inputs.destroy) {\n+    planArgs.push(\"-destroy\");\n+    core.warning(\"The destroy option is enabled\");\n+  }\n+\n+  const planResult = await exec.getExecOutput(\"tfcmt\", planArgs, {\n+    cwd: inputs.workingDirectory,\n+    ignoreReturnCode: true,\n+    env: {\n+      ...process.env,\n+      GITHUB_TOKEN: inputs.githubToken,\n+    },\n+  });\n+\n+  const detailedExitcode = planResult.exitCode;\n+  core.endGroup();\n+\n+  // Set detailed_exitcode output immediately\n+  core.setOutput(\"detailed_exitcode\", detailedExitcode);\n+\n+  core.setOutput(\"plan_binary\", tempPlanBinary);\n+\n+  // If terraform plan failed, exit immediately\n+  if (detailedExitcode === 1) {\n+    throw new Error(\"terraform plan failed\");\n+  }\n+\n+  // Run terraform show to convert plan to JSON\n+  core.startGroup(`${inputs.tfCommand} show`);\n+  const planJsonPath = path.join(inputs.workingDirectory, \"tfplan.json\");\n+\n+  await exec.exec(\n+    \"github-comment\",\n+    [\"exec\", \"--\", inputs.tfCommand, \"show\", \"-json\", tempPlanBinary],\n+    {\n+      cwd: inputs.workingDirectory,\n+      env: {\n+        ...process.env,\n+        GITHUB_TOKEN: inputs.githubToken,\n+      },\n+      outStream: fs.createWriteStream(tempPlanJson),\n+    },\n+  );\n+  core.endGroup();\n+\n+  core.setOutput(\"plan_json\", tempPlanJson);\n+\n+  // Upload plan files as artifact\n+  core.startGroup(\"upload plan artifacts\");\n+  const artifact = new DefaultArtifactClient();\n+  await artifact.uploadArtifact(\n+    `terraform_plan_file_${inputs.target.replaceAll(\"/\", \"__\")}`,\n+    [tempPlanBinary],\n+    tempDir,\n+  );\n+  await artifact.uploadArtifact(\n+    `terraform_plan_json_${inputs.target.replaceAll(\"/\", \"__\")}`,\n+    [tempPlanJson],\n+    tempDir,\n+  );\n+  core.endGroup();\n+\n+  // If no changes, exit successfully\n+  if (detailedExitcode === 0) {\n+    return {\n+      detailedExitcode,\n+      planBinary: tempPlanBinary,\n+      planJson: tempPlanJson,\n+    };\n+  }\n+\n+  // If not drift detection mode, validate renovate changes\n+  if (!inputs.driftIssueNumber) {\n+    await validateRenovateChange(inputs);\n+  }\n+\n+  // If drift detection mode and there are changes, fail\n+  if (inputs.driftIssueNumber) {\n+    throw new Error(\"Drift detected: terraform plan has changes\");\n+  }\n+\n+  return {\n+    detailedExitcode,\n+    planBinary: tempPlanBinary,\n+    planJson: tempPlanJson,\n+  };\n+};\n+\n+export const main = async (): Promise\u003cvoid\u003e =\u003e {\n+  const config = lib.getConfig();\n+  const targetConfig = await getTargetConfig.run(\n+    {\n+      isApply: false,\n+      jobType: lib.getJobType(),\n+      target: process.env.TFACTION_TARGET,\n+      workingDir: process.env.TFACTION_WORKING_DIR,\n+    },\n+    config,\n+  );\n+\n+  const inputs: Inputs = {\n+    githubToken: core.getInput(\"github_token\"),\n+    workingDirectory: lib.getWorkingDir() ?? \"\",\n+    renovateLogin: config.renovate_login || \"\",\n+    destroy: targetConfig.outputs.get(\"destroy\") || false,\n+    conftestPolicyDirectory: config.conftest_policy_directory,\n+    tfCommand: targetConfig.outputs.get(\"terraform_command\") || \"terraform\",\n+    target: process.env.TFACTION_TARGET || \"\",\n+    driftIssueNumber: process.env.TFACTION_DRIFT_ISSUE_NUMBER,\n+    prAuthor: process.env.CI_INFO_PR_AUTHOR,\n+    ciInfoTempDir: process.env.CI_INFO_TEMP_DIR,\n+    s3BucketNameTfmigrateHistory: targetConfig.outputs.get(\n+      \"s3_bucket_name_tfmigrate_history\",\n+    ),\n+    gcsBucketNameTfmigrateHistory: targetConfig.outputs.get(\n+      \"gcs_bucket_name_tfmigrate_history\",\n+    ),\n+  };\n+\n+  const jobType = process.env.TFACTION_JOB_TYPE;\n+\n+  switch (jobType) {\n+    case undefined:\n+      throw new Error(\"TFACTION_JOB_TYPE is not set\");\n+    case \"\":\n+      throw new Error(\"TFACTION_JOB_TYPE is not set\");\n+    case \"tfmigrate\":\n+      await runTfmigratePlan(inputs);\n+      break;\n+    case \"terraform\":\n+      await runTerraformPlan(inputs);\n+      break;\n+    default:\n+      throw new Error(`Unknown TFACTION_JOB_TYPE: ${jobType}`);\n+  }\n+};",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fplan%2Frun.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fplan%2Frun.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Fplan%2Frun.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "c4d05238b2960ca9455ccc89960e574b6f04d946",
    "filename": "js/src/run.ts",
    "additions": 18,
    "deletions": 0,
    "changes": 18,
    "status": "modified",
    "patch": "@@ -13,6 +13,15 @@ import * as getFollowupPRParam from \"./get-follow-up-pr-param\";\n import * as tfsec from \"./tfsec\";\n import * as trivy from \"./trivy\";\n import * as tflint from \"./tflint\";\n+import * as commit from \"./commit\";\n+import * as terraformDocs from \"./terraform-docs\";\n+import * as aquaUpdateChecksum from \"./aqua-update-checksum\";\n+import * as plan from \"./plan\";\n+import * as ciinfo from \"./ci-info\";\n+import * as listWorkingDirs from \"./list-working-dirs\";\n+import * as downloadPlan from \"./download-plan\";\n+import * as terraformApply from \"./terraform-apply\";\n+import * as tfmigrateApply from \"./tfmigrate-apply\";\n \n type Inputs = {\n   action: string;\n@@ -24,9 +33,11 @@ interface API {\n \n export const main = async (inputs: Inputs) =\u003e {\n   const actions = new Map\u003cstring, API\u003e([\n+    [\"aqua-update-checksum\", aquaUpdateChecksum],\n     [\"check-terraform-skip\", checkTerraformSkip],\n     [\"conftest\", conftest],\n     [\"create-drift-issues\", createDriftIssues],\n+    [\"download-plan\", downloadPlan],\n     [\"export-aws-secrets-manager\", exportAWSSecretsManager],\n     [\"export-secrets\", exportSecrets],\n     [\"get-follow-up-pr-param\", getFollowupPRParam],\n@@ -36,9 +47,16 @@ export const main = async (inputs: Inputs) =\u003e {\n     [\"list-changed-modules\", listChangeModules],\n     [\"list-module-callers\", listModuleCallers],\n     [\"list-targets-with-changed-files\", listTargetsWithChangedFiles],\n+    [\"list-working-dirs\", listWorkingDirs],\n+    [\"plan\", plan],\n+    [\"terraform-apply\", terraformApply],\n+    [\"terraform-docs\", terraformDocs],\n+    [\"tfmigrate-apply\", tfmigrateApply],\n     [\"tfsec\", tfsec],\n     [\"trivy\", trivy],\n     [\"tflint\", tflint],\n+    [\"commit\", commit],\n+    [\"ci-info\", ciinfo],\n   ]);\n   const action = actions.get(inputs.action);\n   if (action === undefined) {",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Frun.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Frun.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Frun.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "635ce76d5e74248e4467e574c4fa07d73262a55b",
    "filename": "js/src/terraform-apply/index.ts",
    "additions": 1,
    "deletions": 0,
    "changes": 1,
    "status": "added",
    "patch": "@@ -0,0 +1 @@\n+export { main } from \"./run\";",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fterraform-apply%2Findex.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fterraform-apply%2Findex.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Fterraform-apply%2Findex.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "f24f77c49d6ade760253fa84ac40cdfde56f5b87",
    "filename": "js/src/terraform-apply/run.ts",
    "additions": 400,
    "deletions": 0,
    "changes": 400,
    "status": "added",
    "patch": "@@ -0,0 +1,400 @@\n+import * as exec from \"@actions/exec\";\n+import * as core from \"@actions/core\";\n+import * as github from \"@actions/github\";\n+import * as fs from \"fs\";\n+import * as os from \"os\";\n+import * as path from \"path\";\n+import * as lib from \"../lib\";\n+import * as getGlobalConfig from \"../get-global-config\";\n+import * as getTargetConfig from \"../get-target-config\";\n+import * as updateBranchAction from \"@csm-actions/update-branch-action\";\n+import * as githubAppToken from \"@suzuki-shunsuke/github-app-token\";\n+import {\n+  DefaultArtifactClient,\n+  FindOptions,\n+  DownloadArtifactOptions,\n+} from \"@actions/artifact\";\n+\n+type WorkflowRun = {\n+  headSha: string;\n+  databaseId: number;\n+};\n+\n+export const listRelatedPullRequests = async (\n+  githubToken: string,\n+  target: string,\n+): Promise\u003cnumber[]\u003e =\u003e {\n+  const octokit = github.getOctokit(githubToken);\n+  const { owner, repo } = github.context.repo;\n+\n+  // Search pull requests using GraphQL\n+  const query = `repo:${owner}/${repo} is:pr is:open label:\"${target}\" -label:tfaction:disable-auto-update`;\n+\n+  const result: {\n+    search: {\n+      nodes: Array\u003c{ number: number }\u003e;\n+    };\n+  } = await octokit.graphql(\n+    `\n+    query($query: String!) {\n+      search(query: $query, type: ISSUE, first: 100) {\n+        nodes {\n+          ... on PullRequest {\n+            number\n+          }\n+        }\n+      }\n+    }\n+  `,\n+    { query },\n+  );\n+\n+  return result.search.nodes.map((pr) =\u003e pr.number);\n+};\n+\n+export const main = async (): Promise\u003cvoid\u003e =\u003e {\n+  const driftIssueNumber = process.env.TFACTION_DRIFT_ISSUE_NUMBER || \"\";\n+  const cfg = lib.getConfig();\n+  const globalConfig = await getGlobalConfig.main_(cfg, {\n+    drift_issue_number: driftIssueNumber,\n+  });\n+  const target = lib.getTarget();\n+  if (!target) {\n+    throw new Error(\"TFACTION_TARGET is not set\");\n+  }\n+  const workingDir = lib.getWorkingDir();\n+  const targetConfig = await getTargetConfig.run(\n+    {\n+      target: target,\n+      workingDir: workingDir,\n+      isApply: true,\n+      jobType: lib.getJobType(),\n+    },\n+    cfg,\n+  );\n+  const tfCommand =\n+    targetConfig.outputs.get(\"terraform_command\") || \"terraform\";\n+  const driftIssueRepoOwner = globalConfig.outputs.drift_issue_repo_owner;\n+  const driftIssueRepoName = globalConfig.outputs.drift_issue_repo_name;\n+  const ciInfoPrNumber = process.env.CI_INFO_PR_NUMBER || \"\";\n+  const disableUpdateRelatedPullRequests =\n+    globalConfig.outputs.disable_update_related_pull_requests;\n+  const installDir = process.env.TFACTION_INSTALL_DIR || \"\";\n+  const planFilePath = await downloadPlanFile();\n+  if (!planFilePath) {\n+    throw new Error(\"PLAN_FILE_PATH is not set\");\n+  }\n+\n+  // Create a temporary file for apply output\n+  const tempDir = fs.mkdtempSync(path.join(os.tmpdir(), \"tfaction-\"));\n+  const applyOutput = path.join(tempDir, \"apply_output.txt\");\n+  const outputStream = fs.createWriteStream(applyOutput);\n+\n+  core.startGroup(`${tfCommand} apply`);\n+\n+  // Run terraform apply with tfcmt\n+  let exitCode = 0;\n+  try {\n+    await exec\n+      .exec(\n+        \"tfcmt\",\n+        [\n+          \"-var\",\n+          `target:${target}`,\n+          \"apply\",\n+          \"--\",\n+          tfCommand,\n+          \"apply\",\n+          \"-auto-approve\",\n+          \"-no-color\",\n+          \"-input=false\",\n+          planFilePath,\n+        ],\n+        {\n+          cwd: workingDir,\n+          ignoreReturnCode: true,\n+          listeners: {\n+            stdout: (data: Buffer) =\u003e {\n+              process.stdout.write(data);\n+              outputStream.write(data);\n+            },\n+            stderr: (data: Buffer) =\u003e {\n+              process.stderr.write(data);\n+              outputStream.write(data);\n+            },\n+          },\n+        },\n+      )\n+      .then((code) =\u003e {\n+        exitCode = code;\n+      });\n+  } finally {\n+    outputStream.end();\n+  }\n+\n+  core.endGroup();\n+\n+  // If this is a drift issue, post the result to the drift issue\n+  if (driftIssueNumber) {\n+    const prUrl = `${github.context.serverUrl}/${github.context.repo.owner}/${github.context.repo.repo}/pull/${ciInfoPrNumber}`;\n+    const tfcmtConfig = path.join(installDir, \"tfcmt-drift.yaml\");\n+\n+    try {\n+      await exec.exec(\n+        \"tfcmt\",\n+        [\n+          \"-config\",\n+          tfcmtConfig,\n+          \"-owner\",\n+          driftIssueRepoOwner,\n+          \"-repo\",\n+          driftIssueRepoName,\n+          \"-pr\",\n+          driftIssueNumber,\n+          \"-var\",\n+          `pr_url:${prUrl}`,\n+          \"-var\",\n+          `target:${target}`,\n+          \"apply\",\n+          \"--\",\n+          \"bash\",\n+          \"-c\",\n+          `cat ${applyOutput} \u0026\u0026 exit ${exitCode}`,\n+        ],\n+        {\n+          ignoreReturnCode: true,\n+        },\n+      );\n+    } catch (error) {\n+      // Ignore the failure\n+      core.warning(`Failed to post to drift issue: ${error}`);\n+    }\n+  }\n+\n+  // Clean up temporary file\n+  try {\n+    fs.rmdirSync(tempDir);\n+  } catch (error) {\n+    // Ignore the failure\n+  }\n+\n+  if (disableUpdateRelatedPullRequests) {\n+    core.notice(\"Skip updating related pull requests\");\n+  } else {\n+    const githubToken = process.env.GITHUB_TOKEN || \"\";\n+    const prNumbers = await listRelatedPullRequests(githubToken, target);\n+    if (globalConfig.outputs.securefix_action_server_repository) {\n+      await updateBranchBySecurefix(globalConfig, prNumbers);\n+    } else {\n+      await updateBranchByCommit(githubToken, prNumbers);\n+    }\n+  }\n+\n+  if (exitCode !== 0) {\n+    throw new Error(\"terraform apply failed\");\n+  }\n+};\n+\n+export const updateBranchBySecurefix = async (\n+  globalConfig: getGlobalConfig.Result,\n+  prNumbers: number[],\n+): Promise\u003cvoid\u003e =\u003e {\n+  const serverRepoOwner =\n+    globalConfig.outputs.securefix_action_server_repository.split(\"/\")[0];\n+  const serverRepoName =\n+    globalConfig.outputs.securefix_action_server_repository.split(\"/\")[1];\n+  const token = await githubAppToken.create({\n+    appId: core.getInput(\"securefix_action_app_id\"),\n+    privateKey: core.getInput(\"securefix_action_app_private_key\"),\n+    owner: serverRepoOwner,\n+    repositories: [serverRepoName],\n+    permissions: {\n+      issues: \"write\",\n+    },\n+  });\n+  try {\n+    const octokit = github.getOctokit(token.token);\n+    for (const prNumber of prNumbers) {\n+      try {\n+        await updateBranchAction.update({\n+          octokit,\n+          owner: github.context.repo.owner,\n+          repo: github.context.repo.repo,\n+          pullRequestNumber: prNumber,\n+          serverRepositoryOwner: serverRepoOwner,\n+          serverRepositoryName: serverRepoName,\n+        });\n+        const { data } = await octokit.rest.pulls.updateBranch({\n+          owner: github.context.repo.owner,\n+          repo: github.context.repo.repo,\n+          pull_number: prNumber,\n+        });\n+        core.notice(`Updated a branch ${data.url}`);\n+      } catch (error) {\n+        core.warning(`Failed to update branch for PR #${prNumber}: ${error}`);\n+      }\n+    }\n+  } finally {\n+    if (!token) {\n+      return;\n+    }\n+    if (githubAppToken.hasExpired(token.expiresAt)) {\n+      core.info(\"GitHub App token has already expired\");\n+      return;\n+    }\n+    core.info(\"Revoking GitHub App token\");\n+    await githubAppToken.revoke(token.token);\n+  }\n+};\n+\n+export const updateBranchByCommit = async (\n+  githubToken: string,\n+  prNumbers: number[],\n+): Promise\u003cvoid\u003e =\u003e {\n+  const octokit = github.getOctokit(githubToken);\n+  for (const prNumber of prNumbers) {\n+    try {\n+      const { data } = await octokit.rest.pulls.updateBranch({\n+        owner: github.context.repo.owner,\n+        repo: github.context.repo.repo,\n+        pull_number: prNumber,\n+      });\n+      core.notice(`Updated a branch ${data.url}`);\n+    } catch (error) {\n+      core.warning(`Failed to update branch for PR #${prNumber}: ${error}`);\n+    }\n+  }\n+};\n+\n+const downloadArtifact = async (\n+  token: string,\n+  owner: string,\n+  repo: string,\n+  runId: number,\n+  artifactName: string,\n+  dest: string,\n+): Promise\u003cvoid\u003e =\u003e {\n+  // Download a GitHub Actions Artifact\n+  const artifact = new DefaultArtifactClient();\n+  core.info(`Getting an artifact`);\n+  const artifactOpts: DownloadArtifactOptions \u0026 FindOptions = {\n+    findBy: {\n+      token: token,\n+      repositoryOwner: owner,\n+      repositoryName: repo,\n+      workflowRunId: runId,\n+    },\n+    path: dest,\n+  };\n+  const { artifact: targetArtifact } = await artifact.getArtifact(\n+    artifactName,\n+    artifactOpts,\n+  );\n+  if (!targetArtifact) {\n+    core.setFailed(`Artifact '${artifactName}' not found`);\n+    return;\n+  }\n+  core.info(`Downloading an artifact`);\n+  await artifact.downloadArtifact(targetArtifact.id, artifactOpts);\n+};\n+\n+const downloadPlanFile = async (): Promise\u003cstring\u003e =\u003e {\n+  const cfg = lib.getConfig();\n+  const githubToken = core.getInput(\"github_token\");\n+  const target = process.env.TFACTION_TARGET || \"\";\n+  const planWorkflowName = cfg.plan_workflow_name;\n+  const ciInfoTempDir = process.env.CI_INFO_TEMP_DIR || \"\";\n+  const branch = process.env.CI_INFO_HEAD_REF || \"\";\n+\n+  const filename = \"tfplan.binary\";\n+  const artifactName = `terraform_plan_file_${target.replaceAll(\"/\", \"__\")}`;\n+\n+  // Get PR head SHA\n+  const prJsonPath = path.join(ciInfoTempDir, \"pr.json\");\n+  const prJson = JSON.parse(fs.readFileSync(prJsonPath, \"utf8\"));\n+  const prHeadSha = prJson.head.sha;\n+\n+  // Get workflow run\n+  const octokit = github.getOctokit(githubToken);\n+  const { data: workflowRuns } = await octokit.rest.actions.listWorkflowRuns({\n+    owner: github.context.repo.owner,\n+    repo: github.context.repo.repo,\n+    workflow_id: planWorkflowName,\n+    branch: branch,\n+    per_page: 1,\n+  });\n+\n+  if (workflowRuns.workflow_runs.length === 0) {\n+    await exec.exec(\n+      \"github-comment\",\n+      [\n+        \"post\",\n+        \"-var\",\n+        `tfaction_target:${target}`,\n+        \"-var\",\n+        `plan_workflow_name:${planWorkflowName}`,\n+        \"-var\",\n+        `branch:${branch}`,\n+        \"-k\",\n+        \"no-workflow-run-found\",\n+      ],\n+      {\n+        env: {\n+          ...process.env,\n+          GITHUB_TOKEN: githubToken,\n+        },\n+      },\n+    );\n+    throw new Error(\"No workflow run is found\");\n+  }\n+\n+  const latestRun = workflowRuns.workflow_runs[0];\n+  const workflowRun: WorkflowRun = {\n+    headSha: latestRun.head_sha,\n+    databaseId: latestRun.id,\n+  };\n+  const runId = workflowRun.databaseId;\n+  const headSha = workflowRun.headSha;\n+\n+  // Check if headSha matches\n+  if (headSha !== prHeadSha) {\n+    await exec.exec(\n+      \"github-comment\",\n+      [\n+        \"post\",\n+        \"-var\",\n+        `tfaction_target:${target}`,\n+        \"-var\",\n+        `wf_sha:${headSha}`,\n+        \"-var\",\n+        `pr_sha:${prHeadSha}`,\n+        \"-k\",\n+        \"invalid-workflow-sha\",\n+      ],\n+      {\n+        env: {\n+          ...process.env,\n+          GITHUB_TOKEN: githubToken,\n+        },\n+      },\n+    );\n+    throw new Error(\n+      `workflow run's headSha (${headSha}) is different from the associated pull request's head sha (${prHeadSha})`,\n+    );\n+  }\n+\n+  // Download artifact\n+  const tempDir = fs.mkdtempSync(path.join(os.tmpdir(), \"tfaction-\"));\n+\n+  await downloadArtifact(\n+    githubToken,\n+    github.context.repo.owner,\n+    github.context.repo.repo,\n+    runId,\n+    artifactName,\n+    tempDir,\n+  );\n+\n+  const sourcePath = path.join(tempDir, filename);\n+  return sourcePath;\n+};",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fterraform-apply%2Frun.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fterraform-apply%2Frun.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Fterraform-apply%2Frun.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "934b7186a9fcd60fdd6eef7a20b7e0a59d1fd06f",
    "filename": "js/src/terraform-docs/index.ts",
    "additions": 16,
    "deletions": 0,
    "changes": 16,
    "status": "added",
    "patch": "@@ -0,0 +1,16 @@\n+import * as core from \"@actions/core\";\n+import { run } from \"./run\";\n+\n+export const main = async (): Promise\u003cvoid\u003e =\u003e {\n+  await run({\n+    workingDirectory: core.getInput(\"working_directory\") || process.cwd(),\n+    githubToken: core.getInput(\"github_token\"),\n+    securefixActionAppId: core.getInput(\"securefix_action_app_id\"),\n+    securefixActionAppPrivateKey: core.getInput(\n+      \"securefix_action_app_private_key\",\n+    ),\n+    securefixActionServerRepository: core.getInput(\n+      \"securefix_action_server_repository\",\n+    ),\n+  });\n+};",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fterraform-docs%2Findex.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fterraform-docs%2Findex.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Fterraform-docs%2Findex.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "dbf183017eeb7a174965daafa8dc41878ca496c6",
    "filename": "js/src/terraform-docs/run.ts",
    "additions": 150,
    "deletions": 0,
    "changes": 150,
    "status": "added",
    "patch": "@@ -0,0 +1,150 @@\n+import * as exec from \"@actions/exec\";\n+import * as core from \"@actions/core\";\n+import * as github from \"@actions/github\";\n+import * as path from \"path\";\n+import * as fs from \"fs\";\n+import * as tmp from \"tmp\";\n+import * as commit from \"../commit\";\n+\n+type Inputs = {\n+  workingDirectory: string;\n+  githubToken: string;\n+  securefixActionAppId: string;\n+  securefixActionAppPrivateKey: string;\n+  securefixActionServerRepository: string;\n+};\n+\n+const findConfigFile = (\n+  workingDirectory: string,\n+  repositoryRoot: string,\n+): string =\u003e {\n+  const configFiles = [\n+    \".terraform-docs.yml\",\n+    \".terraform-docs.yaml\",\n+    \".config/.terraform-docs.yml\",\n+    \".config/.terraform-docs.yaml\",\n+  ];\n+\n+  // Search in working directory first\n+  for (const file of configFiles) {\n+    const configPath = path.join(workingDirectory, file);\n+    if (fs.existsSync(configPath)) {\n+      return file;\n+    }\n+  }\n+\n+  // If not found, search in repository root\n+  for (const file of configFiles) {\n+    const configPath = path.join(repositoryRoot, file);\n+    if (fs.existsSync(configPath)) {\n+      return configPath;\n+    }\n+  }\n+\n+  return \"\";\n+};\n+\n+export const run = async (inputs: Inputs): Promise\u003cvoid\u003e =\u003e {\n+  const pwd = process.env.GITHUB_WORKSPACE ?? process.cwd();\n+  const readmePath = path.join(inputs.workingDirectory, \"README.md\");\n+\n+  // Check if README.md exists\n+  const created = !fs.existsSync(readmePath);\n+\n+  // Create temporary file\n+  const tempFile = tmp.fileSync();\n+  try {\n+    // Check terraform-docs version\n+    await exec.exec(\"terraform-docs\", [\"-v\"], {\n+      cwd: inputs.workingDirectory,\n+    });\n+\n+    // Search for config file\n+    const config = findConfigFile(inputs.workingDirectory, pwd);\n+\n+    // Build terraform-docs arguments\n+    const opts = config ? [\"-c\", config] : [\"markdown\"];\n+\n+    const args = [\"exec\"];\n+    if (process.env.TFACTION_GITHUB_COMMENT_CONFIG) {\n+      args.push(\n+        \"-config\",\n+        process.env.TFACTION_GITHUB_COMMENT_CONFIG,\n+        \"-k\",\n+        \"terraform-docs\",\n+      );\n+    }\n+    if (process.env.TFACTION_TARGET) {\n+      args.push(\"-var\", `tfaction_target:${process.env.TFACTION_TARGET}`);\n+    }\n+    args.push(\"--\", \"terraform-docs\", ...opts, \".\");\n+\n+    // Execute terraform-docs via github-comment\n+    const result = await exec.getExecOutput(\"github-comment\", args, {\n+      cwd: inputs.workingDirectory,\n+      ignoreReturnCode: true,\n+      env: {\n+        ...process.env,\n+        GITHUB_TOKEN: inputs.githubToken,\n+      },\n+    });\n+\n+    // Write output to temp file\n+    fs.writeFileSync(tempFile.name, result.stdout);\n+\n+    // Check if command failed\n+    if (result.exitCode !== 0) {\n+      throw new Error(\n+        `terraform-docs failed with exit code ${result.exitCode}`,\n+      );\n+    }\n+\n+    // Check for error: .terraform-docs.yml is required\n+    const output = fs.readFileSync(tempFile.name, \"utf8\");\n+    if (output.includes(\"Available Commands:\")) {\n+      throw new Error(\".terraform-docs.yml is required\");\n+    }\n+\n+    // Check if README.md has the BEGIN_TF_DOCS marker\n+    // If not, write the entire output to README.md\n+    if (\n+      !fs.existsSync(readmePath) ||\n+      !fs.readFileSync(readmePath, \"utf8\").includes(\"\u003c!-- BEGIN_TF_DOCS --\u003e\")\n+    ) {\n+      fs.writeFileSync(readmePath, output);\n+    }\n+\n+    // Check if README.md has changed\n+    const diffResult = await exec.getExecOutput(\n+      \"git\",\n+      [\"diff\", \"--quiet\", \"README.md\"],\n+      {\n+        cwd: inputs.workingDirectory,\n+        ignoreReturnCode: true,\n+      },\n+    );\n+\n+    const changed = created || diffResult.exitCode !== 0;\n+\n+    if (changed) {\n+      const eventName = github.context.eventName;\n+      if (eventName !== \"pull_request\" \u0026\u0026 eventName !== \"pull_request_target\") {\n+        throw new Error(\n+          \"Please generate Module's README.md with terraform-docs.\",\n+        );\n+      }\n+      await commit.create({\n+        githubToken: inputs.githubToken,\n+        commitMessage: \"docs: generate document by terraform-docs\",\n+        appId: inputs.securefixActionAppId,\n+        appPrivateKey: inputs.securefixActionAppPrivateKey,\n+        serverRepository: inputs.securefixActionServerRepository,\n+        files: new Set([path.join(inputs.workingDirectory, \"README.md\")]),\n+      });\n+      throw new Error(\"document is generated by terraform-docs\");\n+    }\n+  } finally {\n+    // Clean up temporary file\n+    tempFile.removeCallback();\n+  }\n+};",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fterraform-docs%2Frun.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Fterraform-docs%2Frun.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Fterraform-docs%2Frun.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "54436d711392ed2a1284f05b275c2f295df40601",
    "filename": "js/src/tflint/index.ts",
    "additions": 7,
    "deletions": 5,
    "changes": 12,
    "status": "modified",
    "patch": "@@ -2,16 +2,18 @@ import * as core from \"@actions/core\";\n import { run } from \"./run\";\n \n export const main = async (): Promise\u003cvoid\u003e =\u003e {\n-  const githubToken = core.getInput(\"github_token\", { required: true });\n+  const githubToken = core.getInput(\"github_token\");\n   await run({\n-    workingDirectory: core.getInput(\"working_directory\", { required: false }),\n+    workingDirectory: core.getInput(\"working_directory\"),\n     githubToken: githubToken,\n     githubTokenForTflintInit: githubToken,\n     githubComment: true,\n     githubTokenForFix: githubToken,\n     fix: core.getBooleanInput(\"tflint_fix\", { required: true }),\n-    useSecurefixAction: core.getBooleanInput(\"use_securefix_action\", {\n-      required: true,\n-    }),\n+    serverRepository: core.getInput(\"securefix_action_server_repository\"),\n+    securefixActionAppId: core.getInput(\"securefix_action_app_id\"),\n+    securefixActionAppPrivateKey: core.getInput(\n+      \"securefix_action_app_private_key\",\n+    ),\n   });\n };",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Ftflint%2Findex.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Ftflint%2Findex.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Ftflint%2Findex.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "c03f59f088dc03daaff9805159143405e458eb34",
    "filename": "js/src/tflint/run.ts",
    "additions": 12,
    "deletions": 26,
    "changes": 38,
    "status": "modified",
    "patch": "@@ -2,6 +2,7 @@ import * as exec from \"@actions/exec\";\n import * as core from \"@actions/core\";\n import * as github from \"@actions/github\";\n import * as path from \"path\";\n+import * as commit from \"../commit\";\n \n type Inputs = {\n   workingDirectory: string;\n@@ -10,7 +11,9 @@ type Inputs = {\n   githubTokenForFix: string;\n   githubComment: boolean;\n   fix: boolean;\n-  useSecurefixAction: boolean;\n+  serverRepository: string;\n+  securefixActionAppId: string;\n+  securefixActionAppPrivateKey: string;\n };\n \n const getSeverity = (s: string): string =\u003e {\n@@ -179,31 +182,14 @@ export const run = async (inputs: Inputs): Promise\u003cvoid\u003e =\u003e {\n     const changedFiles = out.stdout.split(\"\\n\").filter((f) =\u003e f.length \u003e 0);\n     if (changedFiles.length !== 0) {\n       core.setOutput(\"fixed_files\", changedFiles.join(\"\\n\"));\n-      if (inputs.useSecurefixAction) {\n-        return;\n-      }\n-      const branch =\n-        process.env.GITHUB_HEAD_REF || process.env.GITHUB_REF || \"\";\n-      core.startGroup(\"ghcp commit\");\n-      await exec.exec(\n-        \"ghcp\",\n-        [\n-          \"commit\",\n-          \"-r\",\n-          `${github.context.repo.owner}/${github.context.repo.repo}`,\n-          \"-b\",\n-          branch,\n-          \"-m\",\n-          \"fix(tflint): auto fix\",\n-        ].concat(changedFiles),\n-        {\n-          env: {\n-            ...process.env,\n-            GITHUB_TOKEN: inputs.githubTokenForFix,\n-          },\n-        },\n-      );\n-      core.endGroup();\n+      await commit.create({\n+        commitMessage: \"fix(tflint): auto fix\",\n+        githubToken: inputs.githubTokenForFix,\n+        files: new Set(changedFiles),\n+        serverRepository: inputs.serverRepository,\n+        appId: inputs.securefixActionAppId,\n+        appPrivateKey: inputs.securefixActionAppPrivateKey,\n+      });\n       throw new Error(\"code is fixed by tflint --fix\");\n     }\n   }",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Ftflint%2Frun.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Ftflint%2Frun.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Ftflint%2Frun.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "635ce76d5e74248e4467e574c4fa07d73262a55b",
    "filename": "js/src/tfmigrate-apply/index.ts",
    "additions": 1,
    "deletions": 0,
    "changes": 1,
    "status": "added",
    "patch": "@@ -0,0 +1 @@\n+export { main } from \"./run\";",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Ftfmigrate-apply%2Findex.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Ftfmigrate-apply%2Findex.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Ftfmigrate-apply%2Findex.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "4c797c274e4f2fd6803f82a2fcf885c82f7cabb0",
    "filename": "js/src/tfmigrate-apply/run.ts",
    "additions": 162,
    "deletions": 0,
    "changes": 162,
    "status": "added",
    "patch": "@@ -0,0 +1,162 @@\n+import * as exec from \"@actions/exec\";\n+import * as core from \"@actions/core\";\n+import * as github from \"@actions/github\";\n+import * as fs from \"fs\";\n+import * as os from \"os\";\n+import * as path from \"path\";\n+import * as lib from \"../lib\";\n+import * as getGlobalConfig from \"../get-global-config\";\n+import * as getTargetConfig from \"../get-target-config\";\n+import {\n+  listRelatedPullRequests,\n+  updateBranchBySecurefix,\n+  updateBranchByCommit,\n+} from \"../terraform-apply/run\";\n+\n+export const main = async (): Promise\u003cvoid\u003e =\u003e {\n+  const driftIssueNumber = process.env.TFACTION_DRIFT_ISSUE_NUMBER || \"\";\n+  const cfg = lib.getConfig();\n+  const globalConfig = await getGlobalConfig.main_(cfg, {\n+    drift_issue_number: driftIssueNumber,\n+  });\n+  const target = lib.getTarget();\n+  if (!target) {\n+    throw new Error(\"TFACTION_TARGET is not set\");\n+  }\n+  const targetConfig = await getTargetConfig.run(\n+    {\n+      target: target,\n+      workingDir: lib.getWorkingDir(),\n+      isApply: true,\n+      jobType: lib.getJobType(),\n+    },\n+    cfg,\n+  );\n+  const tfCommand =\n+    targetConfig.outputs.get(\"terraform_command\") || \"terraform\";\n+  const driftIssueRepoOwner = globalConfig.outputs.drift_issue_repo_owner;\n+  const driftIssueRepoName = globalConfig.outputs.drift_issue_repo_name;\n+  const ciInfoPrNumber = process.env.CI_INFO_PR_NUMBER || \"\";\n+  const disableUpdateRelatedPullRequests =\n+    globalConfig.outputs.disable_update_related_pull_requests;\n+  const installDir = process.env.TFACTION_INSTALL_DIR || \"\";\n+\n+  // Set TFMIGRATE_EXEC_PATH if needed\n+  const tfmigrateExecPath = process.env.TFMIGRATE_EXEC_PATH || \"\";\n+  if (!tfmigrateExecPath \u0026\u0026 tfCommand !== \"terraform\") {\n+    process.env.TFMIGRATE_EXEC_PATH = tfCommand;\n+  }\n+\n+  // Create a temporary file for apply output\n+  const tempDir = fs.mkdtempSync(path.join(os.tmpdir(), \"tfaction-\"));\n+  const applyOutput = path.join(tempDir, \"apply_output.txt\");\n+  const outputStream = fs.createWriteStream(applyOutput);\n+\n+  core.startGroup(\"tfmigrate apply\");\n+\n+  // Run tfmigrate apply with github-comment\n+  let exitCode = 0;\n+  try {\n+    await exec\n+      .exec(\n+        \"github-comment\",\n+        [\n+          \"exec\",\n+          \"--config\",\n+          path.join(installDir, \"tfmigrate-apply/github-comment.yaml\"),\n+          \"-var\",\n+          `tfaction_target:${target}`,\n+          \"-k\",\n+          \"tfmigrate-apply\",\n+          \"--\",\n+          \"tfmigrate\",\n+          \"apply\",\n+        ],\n+        {\n+          ignoreReturnCode: true,\n+          listeners: {\n+            stdout: (data: Buffer) =\u003e {\n+              process.stdout.write(data);\n+              outputStream.write(data);\n+            },\n+            stderr: (data: Buffer) =\u003e {\n+              process.stderr.write(data);\n+              outputStream.write(data);\n+            },\n+          },\n+        },\n+      )\n+      .then((code) =\u003e {\n+        exitCode = code;\n+      });\n+  } finally {\n+    outputStream.end();\n+  }\n+\n+  core.endGroup();\n+\n+  // If this is a drift issue, post the result to the drift issue\n+  if (driftIssueNumber) {\n+    const prUrl = `${github.context.serverUrl}/${github.context.repo.owner}/${github.context.repo.repo}/pull/${ciInfoPrNumber}`;\n+    const githubCommentConfig = path.join(\n+      installDir,\n+      \"tfmigrate-apply/github-comment.yaml\",\n+    );\n+\n+    try {\n+      await exec.exec(\n+        \"github-comment\",\n+        [\n+          \"exec\",\n+          \"--config\",\n+          githubCommentConfig,\n+          \"-org\",\n+          driftIssueRepoOwner,\n+          \"-repo\",\n+          driftIssueRepoName,\n+          \"-pr\",\n+          driftIssueNumber,\n+          \"-var\",\n+          `pr_url:${prUrl}`,\n+          \"-var\",\n+          `tfaction_target:${target}`,\n+          \"-k\",\n+          \"drift-apply\",\n+          \"--\",\n+          \"bash\",\n+          \"-c\",\n+          `cat ${applyOutput} \u0026\u0026 exit ${exitCode}`,\n+        ],\n+        {\n+          ignoreReturnCode: true,\n+        },\n+      );\n+    } catch (error) {\n+      // Ignore the failure\n+      core.warning(`Failed to post to drift issue: ${error}`);\n+    }\n+  }\n+\n+  // Clean up temporary file\n+  try {\n+    fs.rmdirSync(tempDir);\n+  } catch (error) {\n+    // Ignore the failure\n+  }\n+\n+  if (disableUpdateRelatedPullRequests) {\n+    core.notice(\"Skip updating related pull requests\");\n+  } else {\n+    const githubToken = process.env.GITHUB_TOKEN || \"\";\n+    const prNumbers = await listRelatedPullRequests(githubToken, target);\n+    if (globalConfig.outputs.securefix_action_server_repository) {\n+      await updateBranchBySecurefix(globalConfig, prNumbers);\n+    } else {\n+      await updateBranchByCommit(githubToken, prNumbers);\n+    }\n+  }\n+\n+  if (exitCode !== 0) {\n+    throw new Error(\"tfmigrate apply failed\");\n+  }\n+};",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Ftfmigrate-apply%2Frun.ts",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/js%2Fsrc%2Ftfmigrate-apply%2Frun.ts",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/js%2Fsrc%2Ftfmigrate-apply%2Frun.ts?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "665b5547d157f5f482b8665f80a79d24dde659b2",
    "filename": "list-targets-with-changed-files/action.yaml",
    "additions": 3,
    "deletions": 6,
    "changes": 9,
    "status": "modified",
    "patch": "@@ -2,10 +2,10 @@ name: List targets with changed files\n description: List targets with changed files\n inputs:\n   changed_files:\n-    description: \"Changed Files\"\n+    description: \"Deprecated. This input is ignored\"\n     required: true\n   labels:\n-    description: \"Labels File\"\n+    description: \"Deprecated. This input is ignored\"\n     required: true\n   config_files:\n     description: \"config file paths\"\n@@ -14,7 +14,7 @@ inputs:\n     description: \"module file paths\"\n     required: true\n   pull_request:\n-    description: \"pull request file\"\n+    description: \"Deprecated. This input is ignored\"\n     required: false\n   module_callers:\n     description: \"A json file that describes module's direct and transitive callers\"\n@@ -40,9 +40,6 @@ runs:\n       id: main\n       with:\n         action: list-targets-with-changed-files\n-        changed_files: ${{inputs.changed_files}}\n-        labels: ${{inputs.labels}}\n         config_files: ${{inputs.config_files}}\n         module_files: ${{inputs.module_files}}\n-        pull_request: ${{inputs.pull_request}}\n         module_callers: ${{inputs.module_callers}}",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/list-targets-with-changed-files%2Faction.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/list-targets-with-changed-files%2Faction.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/list-targets-with-changed-files%2Faction.yaml?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "9974fe117ce01b88577a7708ccc59f663e7a36c2",
    "filename": "list-targets/action.yaml",
    "additions": 5,
    "deletions": 32,
    "changes": 37,
    "status": "modified",
    "patch": "@@ -20,12 +20,11 @@ runs:\n   steps:\n     - uses: suzuki-shunsuke/tfaction/install@main\n       id: install\n-    - run: github-comment exec -- ci-info run | sed \"s/^export //\" \u003e\u003e \"$GITHUB_ENV\"\n-      shell: bash\n-      if: |\n+    - if: |\n         ! contains(fromJSON('[\"workflow_dispatch\", \"schedule\"]'), github.event_name)\n-      env:\n-        GITHUB_TOKEN: ${{ inputs.github_token }}\n+      uses: suzuki-shunsuke/tfaction@main\n+      with:\n+        action: ci-info\n \n     - name: Check if the commit is latest\n       shell: bash\n@@ -41,36 +40,10 @@ runs:\n       env:\n         HEAD_SHA: ${{github.event.pull_request.head.sha}}\n \n-    - uses: suzuki-shunsuke/tfaction/list-working-dirs@main\n-      id: list-working-directory-configs\n-    - uses: suzuki-shunsuke/tfaction@main\n-      id: global-config\n-      with:\n-        action: get-global-config\n-    - uses: suzuki-shunsuke/tfaction@main\n-      id: list-module-callers\n-      if: steps.global-config.outputs.update_local_path_module_caller == 'true'\n-      with:\n-        action: list-module-callers\n-        config_files: ${{ steps.list-working-directory-configs.outputs.file }}\n-        module_files: ${{ steps.list-working-directory-configs.outputs.module_file }}\n-\n-    - id: gh_comment_config\n-      shell: bash\n-      run: echo \"value=${GITHUB_ACTION_PATH}/github-comment.yaml\" \u003e\u003e \"$GITHUB_OUTPUT\"\n-\n     - uses: suzuki-shunsuke/tfaction@main\n       id: list-targets\n       with:\n         action: list-targets-with-changed-files\n-        changed_files: ${{ env.CI_INFO_TEMP_DIR }}/pr_all_filenames.txt\n-        labels: ${{ env.CI_INFO_TEMP_DIR }}/labels.txt\n-        pull_request: ${{ env.CI_INFO_TEMP_DIR }}/pr.json\n-        config_files: ${{ steps.list-working-directory-configs.outputs.file }}\n-        module_callers: ${{ steps.list-module-callers.outputs.file }}\n-        module_files: ${{ steps.list-working-directory-configs.outputs.module_file }}\n-        max_changed_working_dirs: ${{ steps.global-config.outputs.max_changed_working_dirs }}\n-        max_changed_modules: ${{ steps.global-config.outputs.max_changed_modules }}\n         github_token: ${{ inputs.github_token }}\n       env:\n-        GH_COMMENT_CONFIG: ${{ steps.gh_comment_config.outputs.value }}\n+        GH_COMMENT_CONFIG: ${{ env.TFACTION_GITHUB_COMMENT_CONFIG }}",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/list-targets%2Faction.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/list-targets%2Faction.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/list-targets%2Faction.yaml?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "5247b02e29a9eee3876fd99eea2255cbd1f97368",
    "filename": "list-targets/github-comment.yaml",
    "additions": 0,
    "deletions": 25,
    "changes": 25,
    "status": "removed",
    "patch": "@@ -1,25 +0,0 @@\n-# https://github.com/suzuki-shunsuke/github-comment\n-post:\n-  too-many-changed-dirs:\n-    template: |\n-      ## :x: Too many working directories are changed\n-\n-      {{template \"link\" .}}\n-\n-      Too many working directories are changed in one pull request.\n-      You can change up to {{.Vars.max_changed_dirs}} working directories.\n-      This is configured in tfaction-root.yaml.\n-\n-      [For more details, please see the document](https://suzuki-shunsuke.github.io/tfaction/docs/codes/001).\n-\n-  too-many-changed-modules:\n-    template: |\n-      ## :x: Too many modules are changed\n-\n-      {{template \"link\" .}}\n-\n-      Too many modules are changed in one pull request.\n-      You can change up to {{.Vars.max_changed_modules}} modules.\n-      This is configured in tfaction-root.yaml.\n-\n-      [For more details, please see the document](https://suzuki-shunsuke.github.io/tfaction/docs/codes/001).",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/0fc0ced9de02901ebeaa991bce25770f6d2a8ec1/list-targets%2Fgithub-comment.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/0fc0ced9de02901ebeaa991bce25770f6d2a8ec1/list-targets%2Fgithub-comment.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/list-targets%2Fgithub-comment.yaml?ref=0fc0ced9de02901ebeaa991bce25770f6d2a8ec1"
  },
  {
    "sha": "93e3c9d4fa39e8cbba41e84a005da16337bd1d93",
    "filename": "list-working-dirs/action.yaml",
    "additions": 3,
    "deletions": 23,
    "changes": 26,
    "status": "modified",
    "patch": "@@ -6,31 +6,11 @@ outputs:\n     value: ${{ steps.main.outputs.file }}\n   module_file:\n     description: Module file path\n-    value: ${{ steps.module.outputs.module_file }}\n+    value: ${{ steps.main.outputs.module_file }}\n runs:\n   using: composite\n   steps:\n     - uses: suzuki-shunsuke/tfaction@main\n-      id: global-config\n-      with:\n-        action: get-global-config\n-    - run: |\n-        tempfile=$(mktemp)\n-        git ls-files \"$BASE_WD\" | grep -E \"/${WD_FILE}$\" \u003e \"$tempfile\" || :\n-        echo \"file=$tempfile\" \u003e\u003e \"$GITHUB_OUTPUT\"\n-        cat \"$tempfile\" \u003e\u00262\n-      shell: bash\n       id: main\n-      env:\n-        BASE_WD: ${{ steps.global-config.outputs.base_working_directory }}\n-        WD_FILE: ${{ steps.global-config.outputs.working_directory_file }}\n-    - run: |\n-        tempfile=$(mktemp)\n-        git ls-files \"$MODULE_BASE_DIR\" | grep -E \"/${MODULE_FILE}$\" \u003e \"$tempfile\" || :\n-        echo \"module_file=$tempfile\" \u003e\u003e \"$GITHUB_OUTPUT\"\n-        cat \"$tempfile\" \u003e\u00262\n-      shell: bash\n-      id: module\n-      env:\n-        MODULE_BASE_DIR: ${{ steps.global-config.outputs.module_base_directory }}\n-        MODULE_FILE: ${{ steps.global-config.outputs.module_file }}\n+      with:\n+        action: list-working-dirs",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/list-working-dirs%2Faction.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/list-working-dirs%2Faction.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/list-working-dirs%2Faction.yaml?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "dc09f725b91468dc770db970745abff8c92af058",
    "filename": "plan/action.yaml",
    "additions": 13,
    "deletions": 80,
    "changes": 93,
    "status": "modified",
    "patch": "@@ -61,104 +61,37 @@ runs:\n         ! env.TFACTION_DRIFT_ISSUE_NUMBER\n       with:\n         action: check-terraform-skip\n-        labels: ${{ env.CI_INFO_TEMP_DIR }}/labels.txt\n-        pr_author: ${{ env.CI_INFO_PR_AUTHOR }}\n-        skip_label_prefix: ${{ steps.global-config.outputs.label_prefix_skip }}\n \n-    - run: bash \"$GITHUB_ACTION_PATH/terraform.sh\"\n-      working-directory: ${{ steps.target-config.outputs.working_directory }}\n+    - uses: suzuki-shunsuke/tfaction@main\n       id: main\n-      shell: bash\n       if: |\n-        env.TFACTION_JOB_TYPE == 'terraform' \u0026\u0026\n-        (\n-          env.TFACTION_DRIFT_ISSUE_NUMBER ||\n-          !fromJSON(steps.check-terraform-skip.outputs.skip_terraform)\n-        )\n-      env:\n-        GITHUB_TOKEN: ${{ inputs.github_token }}\n-        ROOT_DIR: ${{ github.workspace }}\n-        PR_NUMBER: ${{ github.event.pull_request.number }}\n-        RENOVATE_LOGIN: ${{ steps.global-config.outputs.renovate_login }}\n-        HEAD_SHA: ${{github.event.pull_request.head.sha}}\n-        DESTROY: ${{ steps.target-config.outputs.destroy }}\n-        CONFTEST_POLICY_DIRECTORY: ${{ steps.global-config.outputs.conftest_policy_directory }}\n-        TF_COMMAND: ${{ steps.target-config.outputs.terraform_command }}\n-\n-    # tfmigrate plan\n-\n-    - if: env.TFACTION_JOB_TYPE == 'tfmigrate'\n-      run: bash \"$GITHUB_ACTION_PATH/tfmigrate.sh\"\n-      id: migrate\n-      working-directory: ${{ steps.target-config.outputs.working_directory }}\n-      shell: bash\n+        !fromJSON(steps.check-terraform-skip.outputs.skip_terraform)\n+      with:\n+        action: plan\n+        github_token: ${{ inputs.github_token }}\n       env:\n-        GITHUB_TOKEN: ${{ inputs.github_token }}\n-        WORKING_DIR: ${{ steps.target-config.outputs.working_directory }}\n-        ROOT_DIR: ${{ github.workspace }}\n-        PR_NUMBER: ${{ github.event.pull_request.number }}\n-        S3_BUCKET_NAME_TFMIGRATE_HISTORY: ${{ steps.target-config.outputs.s3_bucket_name_tfmigrate_history }}\n-        GCS_BUCKET_NAME_TFMIGRATE_HISTORY: ${{ steps.target-config.outputs.gcs_bucket_name_tfmigrate_history }}\n-        CONFTEST_POLICY_DIRECTORY: ${{ steps.global-config.outputs.conftest_policy_directory }}\n-        TF_COMMAND: ${{ steps.global-config.outputs.terraform_command }}\n+        GH_COMMENT_CONFIG: ${{ env.TFACTION_GITHUB_COMMENT_CONFIG }}\n \n     # Commit .tfmigrate.hcl if changed\n     - if: |\n         env.TFACTION_JOB_TYPE == 'tfmigrate' \u0026\u0026\n-        steps.migrate.outputs.changed == 'true' \u0026\u0026\n-        steps.global-config.outputs.securefix_action_server_repository == ''\n-      uses: suzuki-shunsuke/commit-action@87b297f0ce551411b43d1880f4fb3cbc60381055 # v0.0.14\n+        steps.main.outputs.changed == 'true'\n+      uses: suzuki-shunsuke/tfaction@main\n       with:\n+        action: commit\n         commit_message: \"chore(tfmigrate): add .tfmigrate.hcl\"\n         github_token: ${{ inputs.github_token }}\n         files: ${{ steps.target-config.outputs.working_directory }}/.tfmigrate.hcl\n-    - if: |\n-        env.TFACTION_JOB_TYPE == 'tfmigrate' \u0026\u0026\n-        steps.migrate.outputs.changed == 'true' \u0026\u0026\n-        steps.global-config.outputs.securefix_action_server_repository != ''\n-      uses: csm-actions/securefix-action@949d3cfb554abee10f695014674759978ba8ba34 # v0.4.1\n-      with:\n-        action: client\n-        app_id: ${{inputs.securefix_action_app_id}}\n-        app_private_key: ${{inputs.securefix_action_app_private_key}}\n-        server_repository: ${{ steps.global-config.outputs.securefix_action_server_repository }}\n-        commit_message: \"chore(tfmigrate): add .tfmigrate.hcl\"\n-        files: ${{ steps.target-config.outputs.working_directory }}/.tfmigrate.hcl\n+        securefix_action_app_id: ${{inputs.securefix_action_app_id}}\n+        securefix_action_app_private_key: ${{inputs.securefix_action_app_private_key}}\n+        securefix_action_server_repository: ${{ steps.global-config.outputs.securefix_action_server_repository }}\n \n     # Conftest\n-    - if: steps.migrate.outputs.changed != 'true'\n-      run: echo \"value=$GITHUB_ACTION_PATH\" \u003e\u003e \"$GITHUB_OUTPUT\"\n-      shell: bash\n-      id: action_path\n     - if: steps.migrate.outputs.changed != 'true'\n       uses: suzuki-shunsuke/tfaction@main\n       with:\n         action: conftest\n         plan: \"true\"\n         github_token: ${{inputs.github_token}}\n       env:\n-        GH_COMMENT_CONFIG: ${{ steps.action_path.outputs.value }}/github-comment.yaml\n-\n-    # terraform plan upload plan file and json\n-    - if: |\n-        env.TFACTION_JOB_TYPE == 'terraform' \u0026\u0026\n-        ! env.TFACTION_DRIFT_ISSUE_NUMBER \u0026\u0026 !fromJSON(steps.check-terraform-skip.outputs.skip_terraform)\n-      run: |\n-        echo \"plan_file=terraform_plan_file_${TFACTION_TARGET//\\//__}\" \u003e\u003e \"$GITHUB_OUTPUT\"\n-        echo \"plan_json=terraform_plan_json_${TFACTION_TARGET//\\//__}\" \u003e\u003e \"$GITHUB_OUTPUT\"\n-      id: artifact_name\n-      shell: bash\n-    - if: |\n-        env.TFACTION_JOB_TYPE == 'terraform' \u0026\u0026\n-        ! env.TFACTION_DRIFT_ISSUE_NUMBER \u0026\u0026 !fromJSON(steps.check-terraform-skip.outputs.skip_terraform)\n-      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0\n-      with:\n-        name: ${{ steps.artifact_name.outputs.plan_file }}\n-        path: ${{ steps.main.outputs.plan_binary }}\n-    - if: |\n-        env.TFACTION_JOB_TYPE == 'terraform' \u0026\u0026\n-        ! env.TFACTION_DRIFT_ISSUE_NUMBER \u0026\u0026 !fromJSON(steps.check-terraform-skip.outputs.skip_terraform)\n-      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0\n-      with:\n-        name: ${{ steps.artifact_name.outputs.plan_json }}\n-        path: ${{ steps.main.outputs.plan_json }}\n+        GH_COMMENT_CONFIG: ${{ env.TFACTION_GITHUB_COMMENT_CONFIG }}",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/plan%2Faction.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/plan%2Faction.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/plan%2Faction.yaml?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "0891337c3a32c6266fea55a7aea654474954fc3d",
    "filename": "plan/github-comment.yaml",
    "additions": 0,
    "deletions": 52,
    "changes": 52,
    "status": "removed",
    "patch": "@@ -1,52 +0,0 @@\n-# https://github.com/suzuki-shunsuke/github-comment\n-post:\n-  renovate-plan-change:\n-    template: |\n-      ## :x: {{if .Vars.tfaction_target}}{{.Vars.tfaction_target}}: {{end}}Renovate's PR must be `No change`\n-\n-      {{template \"link\" .}}\n-\n-      In the pull request created by Renovate, the result of `terraform plan` must be `No change` to enable automerge safely.\n-      If you allow changes, please set the pull request label `renovate-change` and rerun CI.\n-\n-  tfmigrate-hcl-not-found:\n-    template: |\n-      ## :x: {{if .Vars.tfaction_target}}{{.Vars.tfaction_target}}: {{end}}.tfmigrate.hcl isn't found\n-\n-      {{template \"link\" .}}\n-\n-      To run `tfmigrate plan`, `.tfmigrate.hcl` is required.\n-\n-exec:\n-  default:\n-    - when: ExitCode != 0\n-      template: |\n-        :x: {{.Vars.tfaction_target}}\n-\n-        {{template \"link\" .}}\n-\n-        {{template \"join_command\" .}}\n-\n-        {{template \"hidden_combined_output\" .}}\n-\n-  conftest:\n-    - when: ExitCode != 0\n-      template: |\n-        ## :x: {{if .Vars.tfaction_target}}{{.Vars.tfaction_target}}: {{end}}Violate Conftest Policy\n-\n-        {{template \"link\" .}} \n-\n-        {{template \"join_command\" .}}\n-\n-        {{.CombinedOutput | AvoidHTMLEscape}}\n-\n-  tfmigrate-plan:\n-    - when: true\n-      template: |\n-        ## {{template \"status\" .}} {{if .Vars.tfaction_target}}{{.Vars.tfaction_target}}: {{end}} tfmigrate plan\n-\n-        {{template \"link\" .}}\n-\n-        {{template \"join_command\" .}}\n-\n-        {{template \"hidden_combined_output\" .}}",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/0fc0ced9de02901ebeaa991bce25770f6d2a8ec1/plan%2Fgithub-comment.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/0fc0ced9de02901ebeaa991bce25770f6d2a8ec1/plan%2Fgithub-comment.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/plan%2Fgithub-comment.yaml?ref=0fc0ced9de02901ebeaa991bce25770f6d2a8ec1"
  },
  {
    "sha": "ac892a55365d8eb3dbd9b18957021c7b46d7e773",
    "filename": "plan/renovate_change.sh",
    "additions": 0,
    "deletions": 19,
    "changes": 19,
    "status": "removed",
    "patch": "@@ -1,19 +0,0 @@\n-#!/usr/bin/env bash\n-\n-set -euo pipefail\n-\n-if [ \"${TFACTION_DEBUG:-}\" = true ]; then\n-\tset -x\n-fi\n-\n-# In the pull request created by Renovate, the result of `terraform plan` must be `No change` to enable automerge safely.\n-# If you allow changes, please set the pull request label `renovate-change`.\n-if [ \"$CI_INFO_PR_AUTHOR\" = \"$RENOVATE_LOGIN\" ]; then\n-\tif ! grep -x renovate-change \"$CI_INFO_TEMP_DIR/labels.txt\" \u003e/dev/null 2\u003e\u00261; then\n-\t\tgithub-comment post \\\n-\t\t\t--config \"${GITHUB_ACTION_PATH}/github-comment.yaml\" \\\n-\t\t\t-var \"tfaction_target:$TFACTION_TARGET\" \\\n-\t\t\t-k renovate-plan-change\n-\t\texit 1\n-\tfi\n-fi",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/0fc0ced9de02901ebeaa991bce25770f6d2a8ec1/plan%2Frenovate_change.sh",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/0fc0ced9de02901ebeaa991bce25770f6d2a8ec1/plan%2Frenovate_change.sh",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/plan%2Frenovate_change.sh?ref=0fc0ced9de02901ebeaa991bce25770f6d2a8ec1"
  },
  {
    "sha": "f3e2bc412c52af995a0da51966a3fd842338a786",
    "filename": "plan/terraform.sh",
    "additions": 0,
    "deletions": 53,
    "changes": 53,
    "status": "removed",
    "patch": "@@ -1,53 +0,0 @@\n-#!/usr/bin/env bash\n-\n-set -euo pipefail\n-\n-if [ \"${TFACTION_DEBUG:-}\" = true ]; then\n-\tset -x\n-fi\n-\n-if [ -n \"${TFACTION_DRIFT_ISSUE_NUMBER:-}\" ]; then\n-\texport TFCMT_CONFIG=$GITHUB_ACTION_PATH/tfcmt-drift.yaml\n-fi\n-\n-opts=\"\"\n-if [ \"${DESTROY:-}\" = true ]; then\n-\topts=-destroy\n-\techo \"::warning::The destroy option is enabled\"\n-fi\n-\n-echo \"::group::$TF_COMMAND plan\"\n-set +e\n-tfcmt -var \"target:$TFACTION_TARGET\" -var \"destroy:${DESTROY:-}\" plan -- \\\n-\t\"$TF_COMMAND\" plan -no-color -detailed-exitcode -out \"${PWD}/tfplan.binary\" -input=false $opts\n-code=$?\n-set -e\n-echo \"::endgroup::\"\n-\n-echo \"detailed_exitcode=$code\" \u003e\u003e\"$GITHUB_OUTPUT\"\n-tempdir=$(mktemp -d)\n-cp tfplan.binary \"$tempdir/tfplan.binary\"\n-echo \"plan_binary=${tempdir}/tfplan.binary\" \u003e\u003e\"$GITHUB_OUTPUT\"\n-\n-if [ \"$code\" -eq 1 ]; then\n-\texit 1\n-fi\n-\n-echo \"::group::$TF_COMMAND show\"\n-github-comment exec -- \"$TF_COMMAND\" show -json tfplan.binary \u003etfplan.json\n-echo \"::endgroup::\"\n-cp tfplan.json \"$tempdir/tfplan.json\"\n-echo \"plan_json=${tempdir}/tfplan.json\" \u003e\u003e\"$GITHUB_OUTPUT\"\n-\n-if [ \"$code\" = \"0\" ]; then\n-\texit 0\n-fi\n-\n-if [ -z \"${TFACTION_DRIFT_ISSUE_NUMBER:-}\" ]; then\n-\tbash \"$GITHUB_ACTION_PATH/renovate_change.sh\"\n-fi\n-\n-if [ -n \"${TFACTION_DRIFT_ISSUE_NUMBER:-}\" ]; then\n-\t# If `terraform plan` has changes, drift is detected and the job fails.\n-\texit \"$code\"\n-fi",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/0fc0ced9de02901ebeaa991bce25770f6d2a8ec1/plan%2Fterraform.sh",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/0fc0ced9de02901ebeaa991bce25770f6d2a8ec1/plan%2Fterraform.sh",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/plan%2Fterraform.sh?ref=0fc0ced9de02901ebeaa991bce25770f6d2a8ec1"
  },
  {
    "sha": "27cd6e8944a123025e677e16c903fb51adb4fb36",
    "filename": "plan/tfcmt-drift.yaml",
    "additions": 0,
    "deletions": 12,
    "changes": 12,
    "status": "removed",
    "patch": "@@ -1,12 +0,0 @@\n-terraform:\n-  plan:\n-    disable_label: true\n-templates:\n-  plan_title: |\n-    {{if eq .ExitCode 0}}\n-    ## :white_check_mark: No drift is found\n-    {{else if eq .ExitCode 1}}\n-    ## :x: Failed to run `terraform plan`\n-    {{else}}\n-    ## :x: Drift is detected\n-    {{end}}",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/0fc0ced9de02901ebeaa991bce25770f6d2a8ec1/plan%2Ftfcmt-drift.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/0fc0ced9de02901ebeaa991bce25770f6d2a8ec1/plan%2Ftfcmt-drift.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/plan%2Ftfcmt-drift.yaml?ref=0fc0ced9de02901ebeaa991bce25770f6d2a8ec1"
  },
  {
    "sha": "9d4fcc60a2becf20a1b68355bb4e28ff6b2c85a2",
    "filename": "plan/tfmigrate.sh",
    "additions": 0,
    "deletions": 48,
    "changes": 48,
    "status": "removed",
    "patch": "@@ -1,48 +0,0 @@\n-#!/usr/bin/env bash\n-\n-set -euo pipefail\n-\n-if [ \"${TFACTION_DEBUG:-}\" = true ]; then\n-\tset -x\n-fi\n-\n-if [ -z \"${TFMIGRATE_EXEC_PATH:-}\" ] \u0026\u0026 [ \"$TF_COMMAND\" != terraform ]; then\n-\tTFMIGRATE_EXEC_PATH=$TF_COMMAND\n-fi\n-\n-if [ ! -f .tfmigrate.hcl ]; then\n-\tif [ -n \"${S3_BUCKET_NAME_TFMIGRATE_HISTORY:-}\" ]; then\n-\t\tsed \"s|%%TARGET%%|$TFACTION_TARGET|g\" \\\n-\t\t\t\"$GITHUB_ACTION_PATH/tfmigrate.hcl\" |\n-\t\t\tsed \"s|%%S3_BUCKET_NAME_TFMIGRATE_HISTORY%%|$S3_BUCKET_NAME_TFMIGRATE_HISTORY|g\" \u003e.tfmigrate.hcl\n-\telif [ -n \"${GCS_BUCKET_NAME_TFMIGRATE_HISTORY:-}\" ]; then\n-\t\tsed \"s|%%TARGET%%|$TFACTION_TARGET|g\" \\\n-\t\t\t\"$GITHUB_ACTION_PATH/tfmigrate-gcs.hcl\" |\n-\t\t\tsed \"s|%%GCS_BUCKET_NAME_TFMIGRATE_HISTORY%%|$GCS_BUCKET_NAME_TFMIGRATE_HISTORY|g\" \u003e.tfmigrate.hcl\n-\telse\n-\t\tgithub-comment post \\\n-\t\t\t--config \"${GITHUB_ACTION_PATH}/github-comment.yaml\" \\\n-\t\t\t-k tfmigrate-hcl-not-found -var \"tfaction_target:$TFACTION_TARGET\"\n-\t\texit 1\n-\tfi\n-\techo \"changed=true\" \u003e\u003e\"$GITHUB_OUTPUT\"\n-\texit 0\n-fi\n-\n-echo \"::group::tfmigrate plan\"\n-github-comment exec \\\n-\t--config \"${GITHUB_ACTION_PATH}/github-comment.yaml\" \\\n-\t-k tfmigrate-plan \\\n-\t-var \"tfaction_target:$TFACTION_TARGET\" \\\n-\t-- tfmigrate plan --out tfplan.binary\n-echo \"::endgroup::\"\n-\n-echo \"::group::$TF_COMMAND show\"\n-github-comment exec -- \"$TF_COMMAND\" show -json tfplan.binary \u003etfplan.json\n-echo \"::endgroup::\"\n-\n-tempdir=$(mktemp -d)\n-cp tfplan.binary \"$tempdir/tfplan.binary\"\n-cp tfplan.json \"$tempdir/tfplan.json\"\n-echo \"plan_json=${tempdir}/tfplan.json\" \u003e\u003e\"$GITHUB_OUTPUT\"\n-echo \"plan_binary=${tempdir}/tfplan.binary\" \u003e\u003e\"$GITHUB_OUTPUT\"",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/0fc0ced9de02901ebeaa991bce25770f6d2a8ec1/plan%2Ftfmigrate.sh",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/0fc0ced9de02901ebeaa991bce25770f6d2a8ec1/plan%2Ftfmigrate.sh",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/plan%2Ftfmigrate.sh?ref=0fc0ced9de02901ebeaa991bce25770f6d2a8ec1"
  },
  {
    "sha": "2bcc762cdca44060aab0e8c0945c6ef2fcef8a71",
    "filename": "setup/action.yaml",
    "additions": 11,
    "deletions": 17,
    "changes": 28,
    "status": "modified",
    "patch": "@@ -37,10 +37,9 @@ runs:\n     # ci-info\n     - if: |\n         ! contains(fromJSON('[\"workflow_dispatch\", \"schedule\"]'), github.event_name)\n-      shell: bash\n-      env:\n-        GITHUB_TOKEN: ${{ inputs.github_token }}\n-      run: github-comment exec -- ci-info run | sed \"s/^export //\" \u003e\u003e \"$GITHUB_ENV\"\n+      uses: suzuki-shunsuke/tfaction@main\n+      with:\n+        action: ci-info\n \n     # Check if the commit is latest\n     - if: github.event_name == 'pull_request' || startsWith(github.event_name, 'pull_request_')\n@@ -88,9 +87,10 @@ runs:\n       env:\n         TARGET_CONFIG: ${{toJSON(steps.target-config.outputs)}}\n \n-    - uses: aquaproj/update-checksum-action@c5df5a5c2a897a9b807068f062140506d092e7ac # v0.2.7\n+    - uses: suzuki-shunsuke/tfaction@main\n       if: steps.global-config.outputs.aqua_update_checksum_enabled == 'true'\n       with:\n+        action: aqua-update-checksum\n         skip_push: ${{ steps.global-config.outputs.aqua_update_checksum_skip_push }}\n         prune: ${{ steps.global-config.outputs.aqua_update_checksum_prune }}\n         working_directory: ${{ steps.target-config.outputs.working_directory }}\n@@ -192,22 +192,16 @@ runs:\n           exit 0\n         fi\n \n-    - if: steps.global-config.outputs.securefix_action_server_repository == '' \u0026\u0026 steps.terraform-init.outputs.changed_file != ''\n-      uses: suzuki-shunsuke/commit-action@87b297f0ce551411b43d1880f4fb3cbc60381055 # v0.0.14\n+    - if: steps.terraform-init.outputs.changed_file != ''\n+      uses: suzuki-shunsuke/tfaction@main\n       with:\n+        action: commit\n         commit_message: \"chore: update .terraform.lock.hcl\"\n         github_token: ${{ inputs.github_token }}\n         files: ${{ steps.terraform-init.outputs.changed_file }}\n-\n-    - if: steps.global-config.outputs.securefix_action_server_repository != '' \u0026\u0026 steps.terraform-init.outputs.changed_file != ''\n-      uses: csm-actions/securefix-action@949d3cfb554abee10f695014674759978ba8ba34 # v0.4.1\n-      with:\n-        action: client\n-        app_id: ${{inputs.securefix_action_app_id}}\n-        app_private_key: ${{inputs.securefix_action_app_private_key}}\n-        server_repository: ${{ steps.global-config.outputs.securefix_action_server_repository }}\n-        commit_message: \"chore: update .terraform.lock.hcl\"\n-        files: ${{ steps.terraform-init.outputs.changed_file }}\n+        securefix_action_app_id: ${{inputs.securefix_action_app_id}}\n+        securefix_action_app_private_key: ${{inputs.securefix_action_app_private_key}}\n+        securefix_action_server_repository: ${{ steps.global-config.outputs.securefix_action_server_repository }}\n \n     - run: |\n         \"$TF\" providers",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/setup%2Faction.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/setup%2Faction.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/setup%2Faction.yaml?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "00883f818870b9f4cbd7bbf214e5fabb1f4b3c4d",
    "filename": "setup/test/terragrunt/foo/.terraform.lock.hcl",
    "additions": 0,
    "deletions": 2,
    "changes": 2,
    "status": "modified",
    "patch": "@@ -7,8 +7,6 @@ provider \"registry.opentofu.org/hashicorp/null\" {\n   hashes = [\n     \"h1:LF8arSzHfhbyQSFtTMTYEqCM34klzrbAQBJMHYCs9d8=\",\n     \"h1:LN7WjQlMDIYGsXlum1kvMk5M8XzS2gzPTHmbEkxB6B0=\",\n-    \"h1:ZD7F/BQPzRy/smJgSwnDs0vrqstk71sx2p0qtUcc/iU=\",\n-    \"h1:nNa5j1vTtxcpdC2i61O2tRkZjdkBNsxzYXYIx0VNsjc=\",\n     \"zh:1d57d25084effd3fdfd902eca00020b34b1fb020253b84d7dd471301606015ac\",\n     \"zh:65b7f9799b88464d9c2ec529713b7f52ea744275b61a8dc86cdedab1b2dcb933\",\n     \"zh:80d3e9c95b7b4ae7c54005cd127cae82e5c53d2b7023ef24c147337bac9dadd9\",",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/setup%2Ftest%2Fterragrunt%2Ffoo%2F.terraform.lock.hcl",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/setup%2Ftest%2Fterragrunt%2Ffoo%2F.terraform.lock.hcl",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/setup%2Ftest%2Fterragrunt%2Ffoo%2F.terraform.lock.hcl?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "c303c7a6ff24bdb39cc5d9cf984d16554f8c4cc5",
    "filename": "terraform-apply/action.yaml",
    "additions": 7,
    "deletions": 66,
    "changes": 73,
    "status": "modified",
    "patch": "@@ -27,14 +27,13 @@ outputs:\n   issue_state:\n     description: Drift Issue state\n     value: ${{ steps.drift-issue.outputs.issue_state }}\n+  pr_numbers:\n+    description: Related pull request numbers\n+    value: ${{ steps.terraform-apply.outputs.pr_numbers }}\n \n runs:\n   using: composite\n   steps:\n-    - uses: suzuki-shunsuke/tfaction@main\n-      id: target-config\n-      with:\n-        action: get-target-config\n     - uses: suzuki-shunsuke/tfaction@main\n       id: global-config\n       with:\n@@ -43,68 +42,10 @@ runs:\n       id: check-terraform-skip\n       with:\n         action: check-terraform-skip\n-        labels: ${{ env.CI_INFO_TEMP_DIR }}/labels.txt\n-        pr_author: ${{ env.CI_INFO_PR_AUTHOR }}\n-        skip_label_prefix: ${{ steps.global-config.outputs.label_prefix_skip }}\n-\n-    - run: bash \"$GITHUB_ACTION_PATH/download_plan_file.sh\"\n-      working-directory: ${{ steps.target-config.outputs.working_directory }}\n-      shell: bash\n-      if: \"!fromJSON(steps.check-terraform-skip.outputs.skip_terraform)\"\n-      env:\n-        GITHUB_TOKEN: ${{ inputs.github_token }}\n-        PLAN_WORKFLOW_NAME: ${{ steps.global-config.outputs.plan_workflow_name }}\n \n-    - run: bash \"$GITHUB_ACTION_PATH/main.sh\"\n-      working-directory: ${{ steps.target-config.outputs.working_directory }}\n-      shell: bash\n+    - uses: suzuki-shunsuke/tfaction@main\n+      id: terraform-apply\n       if: \"!fromJSON(steps.check-terraform-skip.outputs.skip_terraform)\"\n-      env:\n-        GITHUB_TOKEN: ${{ inputs.github_token }}\n-        TFACTION_DRIFT_ISSUE_REPO_OWNER: ${{steps.global-config.outputs.drift_issue_repo_owner}}\n-        TFACTION_DRIFT_ISSUE_REPO_NAME: ${{steps.global-config.outputs.drift_issue_repo_name}}\n-        DISABLE_UPDATE_RELATED_PULL_REQUESTS: ${{ steps.global-config.outputs.disable_update_related_pull_requests }}\n-        TF_COMMAND: ${{ steps.target-config.outputs.terraform_command }}\n-\n-    - if: |\n-        always() \u0026\u0026\n-        steps.global-config.outputs.disable_update_related_pull_requests != 'true'\n-      id: update-branches\n-      shell: bash\n-      env:\n-        GITHUB_TOKEN: ${{ inputs.github_token }}\n-      run: |\n-        {\n-          echo \"value\u003c\u003cEOF\"\n-          github-comment exec \\\n-            -config \"${GITHUB_ACTION_PATH}/github-comment.yaml\" \\\n-            -var \"tfaction_target:$TFACTION_TARGET\" -- \\\n-            gh pr list \\\n-              --json number \\\n-              -L 100 \\\n-              -l \"$TFACTION_TARGET\" \\\n-              -S \"-label:tfaction:disable-auto-update\" \\\n-              -q \".[].number\"\n-          echo \"EOF\"\n-        } \u003e\u003e \"$GITHUB_OUTPUT\"\n-\n-    - if: |\n-        always() \u0026\u0026\n-        steps.global-config.outputs.disable_update_related_pull_requests != 'true' \u0026\u0026\n-        steps.global-config.outputs.securefix_action_server_repository == ''\n-      shell: bash\n-      env:\n-        GITHUB_TOKEN: ${{ inputs.github_token }}\n-        PR_NUMBERS: ${{ steps.update-branches.outputs.value }}\n-      run: bash \"$GITHUB_ACTION_PATH/update_branches.sh\"\n-\n-    - if: |\n-        always() \u0026\u0026\n-        steps.global-config.outputs.disable_update_related_pull_requests != 'true' \u0026\u0026\n-        steps.global-config.outputs.securefix_action_server_repository != ''\n-      uses: csm-actions/update-branch-action@a9203c8441eee4b478c8f2cfbe3c2d4bfa193d97 # v0.1.3\n       with:\n-        app_id: ${{inputs.securefix_action_app_id}}\n-        app_private_key: ${{inputs.securefix_action_app_private_key}}\n-        server_repository_name: ${{steps.global-config.outputs.securefix_action_server_repository}}\n-        pull_request_number: ${{ steps.update-branches.outputs.value }}\n+        action: terraform-apply\n+        github_token: ${{ inputs.github_token }}",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/terraform-apply%2Faction.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/terraform-apply%2Faction.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/terraform-apply%2Faction.yaml?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "233203fdd0915707ddfa5b26d069b8afb9f29581",
    "filename": "terraform-docs/action.yaml",
    "additions": 5,
    "deletions": 18,
    "changes": 23,
    "status": "modified",
    "patch": "@@ -28,27 +28,14 @@ runs:\n       id: global-config\n       with:\n         action: get-global-config\n-    - shell: bash\n+    - uses: suzuki-shunsuke/tfaction@main\n       id: fix\n-      working-directory: ${{ inputs.working_directory }}\n       env:\n-        GITHUB_TOKEN: ${{ inputs.github_token }}\n         TFACTION_WORKING_DIR: ${{ inputs.working_directory }}\n-      run: bash \"${GITHUB_ACTION_PATH}/terraform-docs.sh\"\n-\n-    - if: steps.global-config.outputs.securefix_action_server_repository == '' \u0026\u0026 steps.fix.outputs.changed == 'true'\n-      uses: suzuki-shunsuke/commit-action@87b297f0ce551411b43d1880f4fb3cbc60381055 # v0.0.14\n       with:\n-        commit_message: \"docs: generate document by terraform-docs\"\n+        action: terraform-docs\n+        working_directory: ${{ inputs.working_directory }}\n         github_token: ${{ inputs.github_token }}\n-        files: ${{ inputs.working_directory }}/README.md\n-\n-    - if: steps.global-config.outputs.securefix_action_server_repository != '' \u0026\u0026 steps.fix.outputs.changed == 'true'\n-      uses: csm-actions/securefix-action@949d3cfb554abee10f695014674759978ba8ba34 # v0.4.1\n-      with:\n-        action: client\n-        app_id: ${{inputs.securefix_action_app_id}}\n-        app_private_key: ${{inputs.securefix_action_app_private_key}}\n+        securefix_action_app_id: ${{inputs.securefix_action_app_id}}\n+        securefix_action_app_private_key: ${{inputs.securefix_action_app_private_key}}\n         server_repository: ${{ steps.global-config.outputs.securefix_action_server_repository }}\n-        commit_message: \"docs: generate document by terraform-docs\"\n-        files: ${{ inputs.working_directory }}/README.md",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/terraform-docs%2Faction.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/terraform-docs%2Faction.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/terraform-docs%2Faction.yaml?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "12f9c39fba9a2a1d2b0a929c392af3815748c0e6",
    "filename": "test-module/action.yaml",
    "additions": 1,
    "deletions": 5,
    "changes": 6,
    "status": "modified",
    "patch": "@@ -39,17 +39,13 @@ runs:\n         working_directory: ${{ env.TFACTION_TARGET }}\n         skip_install_aqua: \"true\"\n \n-    - shell: bash\n-      id: action-path\n-      run: echo \"value=$GITHUB_ACTION_PATH\" \u003e\u003e \"$GITHUB_OUTPUT\"\n-\n     - run: github-comment exec -var \"tfaction_target:$TFACTION_TARGET\" -- terraform init\n       # https://github.com/suzuki-shunsuke/tfaction/issues/1576\n       shell: bash\n       working-directory: ${{ env.TFACTION_TARGET }}\n       env:\n         GITHUB_TOKEN: ${{ inputs.github_token }}\n-        GH_COMMENT_CONFIG: ${{steps.action-path.outputs.value}}/github-comment.yaml\n+        GH_COMMENT_CONFIG: ${{ env.TFACTION_GITHUB_COMMENT_CONFIG }}\n \n     # trivy\n     - if: fromJSON(steps.global-config.outputs.enable_trivy)",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/test-module%2Faction.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/test-module%2Faction.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/test-module%2Faction.yaml?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "6dac53e72cfe9c7015b788b6378088f49f9026a9",
    "filename": "test/action.yaml",
    "additions": 16,
    "deletions": 36,
    "changes": 52,
    "status": "modified",
    "patch": "@@ -30,20 +30,16 @@ runs:\n         action: get-global-config\n \n     # Conftest\n-    - shell: bash\n-      id: action_path\n-      run: echo \"value=$GITHUB_ACTION_PATH\" \u003e\u003e \"$GITHUB_OUTPUT\"\n     - uses: suzuki-shunsuke/tfaction@main\n       with:\n         action: conftest\n         github_token: ${{inputs.github_token}}\n       env:\n-        GH_COMMENT_CONFIG: ${{ steps.action_path.outputs.value }}/github-comment.yaml\n+        GH_COMMENT_CONFIG: ${{ env.TFACTION_GITHUB_COMMENT_CONFIG }}\n \n     # terraform validate\n     - run: |\n         github-comment exec \\\n-          -config \"${GITHUB_ACTION_PATH}/github-comment.yaml\" \\\n           -k terraform-validate \\\n           -var \"tfaction_target:${TFACTION_TARGET}\" \\\n           -- \"$TF_COMMAND\" validate\n@@ -53,6 +49,7 @@ runs:\n       env:\n         GITHUB_TOKEN: ${{ inputs.github_token }}\n         TF_COMMAND: ${{ steps.target-config.outputs.terraform_command }}\n+        GH_COMMENT_CONFIG: ${{ env.TFACTION_GITHUB_COMMENT_CONFIG }}\n \n     # trivy\n     - uses: suzuki-shunsuke/tfaction@main\n@@ -81,22 +78,12 @@ runs:\n         working_directory: ${{ steps.target-config.outputs.working_directory }}\n         tflint_fix: ${{ steps.target-config.outputs.tflint_fix == 'true' }}\n         use_securefix_action: ${{ steps.global-config.outputs.securefix_action_server_repository != '' }}\n+        securefix_action_app_id: ${{inputs.securefix_action_app_id}}\n+        securefix_action_app_private_key: ${{inputs.securefix_action_app_private_key}}\n+        securefix_action_server_repository: ${{ steps.global-config.outputs.securefix_action_server_repository }}\n         # github_token_for_tflint_init\n         # github_token_for_fix\n \n-    # tflint --fix with Securefix Action\n-    - if: |\n-        steps.target-config.outputs.enable_tflint == 'true' \u0026\u0026 steps.target-config.outputs.destroy != 'true' \u0026\u0026\n-        steps.global-config.outputs.securefix_action_server_repository != '' \u0026\u0026 steps.tflint.outputs.fixed_files != ''\n-      uses: csm-actions/securefix-action@949d3cfb554abee10f695014674759978ba8ba34 # v0.4.1\n-      with:\n-        app_id: ${{inputs.securefix_action_app_id}}\n-        app_private_key: ${{inputs.securefix_action_app_private_key}}\n-        server_repository: ${{ steps.global-config.outputs.securefix_action_server_repository }}\n-        commit_message: \"fix(tflint): auto fix\"\n-        files: |\n-          ${{ steps.tflint.outputs.fixed_files }}\n-\n     # terraform fmt\n     - if: steps.target-config.outputs.destroy != 'true'\n       shell: bash\n@@ -120,34 +107,27 @@ runs:\n           echo EOF\n         } \u003e\u003e \"$GITHUB_OUTPUT\"\n \n-    # terraform fmt \u0026 commit action\n+    # terraform fmt \u0026 commit\n     - if: |\n         steps.target-config.outputs.destroy != 'true' \u0026\u0026\n-        steps.global-config.outputs.securefix_action_server_repository == '' \u0026\u0026 steps.fmt-files.outputs.value != ''\n-      uses: suzuki-shunsuke/commit-action@87b297f0ce551411b43d1880f4fb3cbc60381055 # v0.0.14\n-      with:\n-        commit_message: \"style: ${{ steps.target-config.outputs.terraform_command }} fmt -recursive\"\n-        github_token: ${{ inputs.github_token }}\n-        files: ${{ steps.fmt-files.outputs.value }}\n-\n-    # terraform fmt \u0026 securefix action\n-    - if: |\n-        steps.target-config.outputs.destroy != 'true' \u0026\u0026\n-        steps.global-config.outputs.securefix_action_server_repository != '' \u0026\u0026 steps.fmt-files.outputs.value != ''\n-      uses: csm-actions/securefix-action@949d3cfb554abee10f695014674759978ba8ba34 # v0.4.1\n+        steps.fmt-files.outputs.value != ''\n+      uses: suzuki-shunsuke/tfaction@main\n       with:\n-        action: client\n-        app_id: ${{inputs.securefix_action_app_id}}\n-        app_private_key: ${{inputs.securefix_action_app_private_key}}\n-        server_repository: ${{ steps.global-config.outputs.securefix_action_server_repository }}\n+        action: commit\n         commit_message: \"style: ${{ steps.target-config.outputs.terraform_command }} fmt -recursive\"\n         files: ${{ steps.fmt-files.outputs.value }}\n+        github_token: ${{ inputs.github_token }}\n+        securefix_action_app_id: ${{inputs.securefix_action_app_id}}\n+        securefix_action_app_private_key: ${{inputs.securefix_action_app_private_key}}\n+        securefix_action_server_repository: ${{ steps.global-config.outputs.securefix_action_server_repository }}\n \n     # terraform-docs\n-    - uses: suzuki-shunsuke/tfaction/terraform-docs@main\n+    - uses: suzuki-shunsuke/tfaction@main\n       if: steps.target-config.outputs.enable_terraform_docs == 'true' \u0026\u0026 steps.target-config.outputs.destroy != 'true'\n       with:\n+        action: terraform-docs\n         github_token: ${{ inputs.github_token }}\n         securefix_action_app_id: ${{ inputs.securefix_action_app_id }}\n         securefix_action_app_private_key: ${{ inputs.securefix_action_app_private_key }}\n+        securefix_action_server_repository: ${{ steps.global-config.outputs.securefix_action_server_repository }}\n         working_directory: ${{ steps.target-config.outputs.working_directory }}",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/test%2Faction.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/test%2Faction.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/test%2Faction.yaml?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  },
  {
    "sha": "932de347260d6f7a0c41037dd711c996aa44ca6a",
    "filename": "test/github-comment.yaml",
    "additions": 0,
    "deletions": 33,
    "changes": 33,
    "status": "removed",
    "patch": "@@ -1,33 +0,0 @@\n-# https://github.com/suzuki-shunsuke/github-comment\n-exec:\n-  default:\n-    - when: ExitCode != 0\n-      template: |\n-        :x: {{.Vars.tfaction_target}}\n-\n-        {{template \"link\" .}}\n-\n-        {{template \"join_command\" .}}\n-\n-        {{template \"hidden_combined_output\" .}}\n-  terraform-validate:\n-    - when: ExitCode != 0\n-      template: |\n-        ## :x: {{.Vars.tfaction_target}}: terraform validate\n-\n-        {{template \"link\" .}}\n-\n-        {{template \"join_command\" .}}\n-\n-        {{template \"hidden_combined_output\" .}}\n-\n-  conftest:\n-    - when: ExitCode != 0\n-      template: |\n-        ## :x: {{if .Vars.tfaction_target}}{{.Vars.tfaction_target}}: {{end}}Violate Conftest Policy\n-\n-        {{template \"link\" .}} \n-\n-        {{template \"join_command\" .}}\n-\n-        {{.CombinedOutput | AvoidHTMLEscape}}",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/0fc0ced9de02901ebeaa991bce25770f6d2a8ec1/test%2Fgithub-comment.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/0fc0ced9de02901ebeaa991bce25770f6d2a8ec1/test%2Fgithub-comment.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/test%2Fgithub-comment.yaml?ref=0fc0ced9de02901ebeaa991bce25770f6d2a8ec1"
  },
  {
    "sha": "698680849bd325b7aa9a3a99e1078846b0f0eea0",
    "filename": "tfmigrate-apply/action.yaml",
    "additions": 6,
    "deletions": 49,
    "changes": 55,
    "status": "modified",
    "patch": "@@ -31,55 +31,12 @@ runs:\n       with:\n         action: get-target-config\n \n-    - run: bash \"$GITHUB_ACTION_PATH/main.sh\"\n+    - uses: suzuki-shunsuke/tfaction@main\n+      id: tfmigrate-apply\n       working-directory: ${{ steps.target-config.outputs.working_directory }}\n-      shell: bash\n-      env:\n-        GITHUB_TOKEN: ${{ inputs.github_token }}\n-        TFACTION_DRIFT_ISSUE_REPO_OWNER: ${{steps.global-config.outputs.drift_issue_repo_owner}}\n-        TFACTION_DRIFT_ISSUE_REPO_NAME: ${{steps.global-config.outputs.drift_issue_repo_name}}\n-        DISABLE_UPDATE_RELATED_PULL_REQUESTS: ${{ steps.global-config.outputs.disable_update_related_pull_requests }}\n-        TF_COMMAND: ${{ steps.global-config.outputs.terraform_command }}\n-\n-    - if: |\n-        always() \u0026\u0026\n-        steps.global-config.outputs.disable_update_related_pull_requests != 'true'\n-      id: update-branches\n-      shell: bash\n-      env:\n-        GITHUB_TOKEN: ${{ inputs.github_token }}\n-      run: |\n-        {\n-          echo \"value\u003c\u003cEOF\"\n-          github-comment exec \\\n-            -config \"${GITHUB_ACTION_PATH}/github-comment.yaml\" \\\n-            -var \"tfaction_target:$TFACTION_TARGET\" -- \\\n-            gh pr list \\\n-              --json number \\\n-              -L 100 \\\n-              -l \"$TFACTION_TARGET\" \\\n-              -S \"-label:tfaction:disable-auto-update\" \\\n-              -q \".[].number\"\n-          echo \"EOF\"\n-        } \u003e\u003e \"$GITHUB_OUTPUT\"\n-\n-    - if: |\n-        always() \u0026\u0026\n-        steps.global-config.outputs.disable_update_related_pull_requests != 'true' \u0026\u0026\n-        steps.global-config.outputs.securefix_action_server_repository == ''\n-      shell: bash\n+      with:\n+        action: tfmigrate-apply\n+        securefix_action_app_id: ${{ inputs.securefix_action_app_id }}\n+        securefix_action_app_private_key: ${{ inputs.securefix_action_app_private_key }}\n       env:\n         GITHUB_TOKEN: ${{ inputs.github_token }}\n-        PR_NUMBERS: ${{ steps.update-branches.outputs.value }}\n-      run: bash \"$GITHUB_ACTION_PATH/update_branches.sh\"\n-\n-    - if: |\n-        always() \u0026\u0026\n-        steps.global-config.outputs.disable_update_related_pull_requests != 'true' \u0026\u0026\n-        steps.global-config.outputs.securefix_action_server_repository != ''\n-      uses: csm-actions/update-branch-action@a9203c8441eee4b478c8f2cfbe3c2d4bfa193d97 # v0.1.3\n-      with:\n-        app_id: ${{inputs.securefix_action_app_id}}\n-        app_private_key: ${{inputs.securefix_action_app_private_key}}\n-        server_repository_name: ${{steps.global-config.outputs.securefix_action_server_repository}}\n-        pull_request_number: ${{ steps.update-branches.outputs.value }}",
    "blob_url": "https://github.com/suzuki-shunsuke/tfaction/blob/b563e88c9df0528b43b45881dc8c1e14fe030145/tfmigrate-apply%2Faction.yaml",
    "raw_url": "https://github.com/suzuki-shunsuke/tfaction/raw/b563e88c9df0528b43b45881dc8c1e14fe030145/tfmigrate-apply%2Faction.yaml",
    "contents_url": "https://api.github.com/repos/suzuki-shunsuke/tfaction/contents/tfmigrate-apply%2Faction.yaml?ref=b563e88c9df0528b43b45881dc8c1e14fe030145"
  }
]
