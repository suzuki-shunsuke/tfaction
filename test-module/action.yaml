name: Test Module
description: Test Module
inputs:
  github_token:
    description: |
      GitHub Access Token
      pull-requests:write - Create pull request comments and reviews
      contents:write - Push commits
    required: false
    default: ${{ github.token }}
  securefix_action_app_id:
    description: |
      GitHub App ID for Securefix Action
      issues:write
    required: false
  securefix_action_app_private_key:
    description: |
      GitHub App Private Key for Securefix Action
    required: false
runs:
  using: composite
  steps:
    - uses: suzuki-shunsuke/tfaction/js@44761f88e35581b334045b36532f532825b53893
      id: global-config
      with:
        action: get-global-config

    # TODO Run conftest on modules
    # https://github.com/suzuki-shunsuke/tfaction/issues/1908#issuecomment-2415572321
    # - uses: suzuki-shunsuke/tfaction/conftest@main
    #   with:
    #     github_token: ${{ inputs.github_token }}

    - uses: suzuki-shunsuke/tfaction/install@44761f88e35581b334045b36532f532825b53893
    - uses: aquaproj/aqua-installer@11dd79b4e498d471a9385aa9fb7f62bb5f52a73c # v4.0.4
      with:
        aqua_version: v2.55.2
        aqua_opts: -l -a
        working_directory: ${{ env.TFACTION_TARGET }}
        skip_install_aqua: "true"

    - shell: bash
      id: action-path
      run: echo "value=$GITHUB_ACTION_PATH" >> "$GITHUB_OUTPUT"

    - run: github-comment exec -var "tfaction_target:$TFACTION_TARGET" -- terraform init
      # https://github.com/suzuki-shunsuke/tfaction/issues/1576
      shell: bash
      working-directory: ${{ env.TFACTION_TARGET }}
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
        GH_COMMENT_CONFIG: ${{steps.action-path.outputs.value}}/github-comment.yaml

    # trivy
    - if: fromJSON(steps.global-config.outputs.enable_trivy)
      uses: suzuki-shunsuke/tfaction/js@44761f88e35581b334045b36532f532825b53893
      with:
        action: trivy
        github_token: ${{ inputs.github_token }}
        working_directory: ${{ env.TFACTION_TARGET }}

    # tfsec
    - if: fromJSON(steps.global-config.outputs.enable_tfsec)
      uses: suzuki-shunsuke/tfaction/js@44761f88e35581b334045b36532f532825b53893
      with:
        action: tfsec
        github_token: ${{ inputs.github_token }}
        working_directory: ${{ env.TFACTION_TARGET }}

    # tflint
    - if: fromJSON(steps.global-config.outputs.enable_tflint)
      id: tflint
      uses: suzuki-shunsuke/tfaction/js@44761f88e35581b334045b36532f532825b53893
      with:
        action: tflint
        github_token: ${{ inputs.github_token }}
        working_directory: ${{ env.TFACTION_TARGET }}
        tflint_fix: ${{ steps.global-config.outputs.tflint_fix == 'true' }}
        use_securefix_action: ${{ steps.global-config.outputs.securefix_action_server_repository != '' }}
        # github_token_for_tflint_init
        # github_token_for_fix

    # tflint --fix with Securefix Action
    - if: |
        steps.target-config.outputs.enable_tflint == 'true' && steps.target-config.outputs.destroy != 'true' &&
        steps.global-config.outputs.securefix_action_server_repository != '' && steps.tflint.outputs.fixed_files != ''
      uses: csm-actions/securefix-action@949d3cfb554abee10f695014674759978ba8ba34 # v0.4.1
      with:
        app_id: ${{inputs.securefix_action_app_id}}
        app_private_key: ${{inputs.securefix_action_app_private_key}}
        server_repository: ${{ steps.global-config.outputs.securefix_action_server_repository }}
        commit_message: "fix(tflint): auto fix"
        files: |
          ${{ steps.tflint.outputs.fixed_files }}

    # Remove .terraform.lock.hcl created by `terraform init` before running terraform-docs
    - run: "! test -f .terraform.lock.hcl || rm .terraform.lock.hcl"
      shell: bash
      working-directory: ${{ env.TFACTION_TARGET }}

    # terraform-docs
    - uses: suzuki-shunsuke/tfaction/terraform-docs@main
      with:
        github_token: ${{ inputs.github_token }}
        securefix_action_app_id: ${{ inputs.securefix_action_app_id }}
        securefix_action_app_private_key: ${{ inputs.securefix_action_app_private_key }}
        working_directory: ${{ env.TFACTION_TARGET }}

    # terraform fmt
    - shell: bash
      working-directory: ${{ env.TFACTION_TARGET }}
      id: fmt-files
      env:
        TF_COMMAND: ${{ steps.global-config.outputs.terraform_command }}
        DIR: ${{ env.TFACTION_TARGET }}
      run: |
        if [ -z "$DIR" ]; then
          {
            echo 'value<<EOF'
            "$TF_COMMAND" fmt -recursive
            echo EOF
          } >> "$GITHUB_OUTPUT"
          exit 0
        fi
        {
          echo 'value<<EOF'
          "$TF_COMMAND" fmt -recursive | sed "s|^|${DIR}/|"
          echo EOF
        } >> "$GITHUB_OUTPUT"

    # terraform fmt & commit action
    - if: |
        steps.global-config.outputs.securefix_action_server_repository == '' && steps.fmt-files.outputs.value != ''
      uses: suzuki-shunsuke/commit-action@87b297f0ce551411b43d1880f4fb3cbc60381055 # v0.0.14
      with:
        commit_message: "style: ${{ steps.global-config.outputs.terraform_command }} fmt -recursive"
        github_token: ${{ inputs.github_token }}
        files: ${{ steps.fmt-files.outputs.value }}

    # terraform fmt & securefix action
    - if: |
        steps.global-config.outputs.securefix_action_server_repository != '' && steps.fmt-files.outputs.value != ''
      uses: csm-actions/securefix-action@949d3cfb554abee10f695014674759978ba8ba34 # v0.4.1
      with:
        action: client
        app_id: ${{inputs.securefix_action_app_id}}
        app_private_key: ${{inputs.securefix_action_app_private_key}}
        server_repository: ${{ steps.global-config.outputs.securefix_action_server_repository }}
        commit_message: "style: ${{ steps.global-config.outputs.terraform_command }} fmt -recursive"
        files: ${{ steps.fmt-files.outputs.value }}
