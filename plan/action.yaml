name: plan
description: plan
inputs:
  github_token:
    description: "GitHub Access Token"
    required: false
    default: ${{ github.token }}

  github_app_id_for_securefix_action:
    description: |
      GitHub App ID for Securefix Action
      issues:write
    required: false
  github_app_private_key_for_securefix_action:
    description: |
      GitHub App Private Key for Securefix Action
    required: false
outputs:
  plan_binary:
    description: "Path to the plan binary file"
    value: ${{ steps.output.outputs.plan_binary }}
  plan_json:
    description: "Path to the plan json file"
    value: ${{ steps.output.outputs.plan_json }}
  detailed_exitcode:
    description: Detailed exit code of `terraform plan`
    value: ${{ steps.output.outputs.detailed_exitcode }}
runs:
  using: composite
  steps:
    - uses: suzuki-shunsuke/tfaction/terraform-plan@main
      id: terraform
      if: env.TFACTION_JOB_TYPE == 'terraform'
      with:
        github_token: ${{inputs.github_token}}

    - uses: suzuki-shunsuke/tfaction/tfmigrate-plan@main
      id: tfmigrate
      if: env.TFACTION_JOB_TYPE == 'tfmigrate'
      with:
        github_token: ${{inputs.github_token}}
        github_app_id_for_securefix_action: ${{inputs.github_app_id_for_securefix_action}}
        github_app_private_key_for_securefix_action: ${{inputs.github_app_private_key_for_securefix_action}}

    - shell: bash
      id: output
      env:
        TERRAFORM_PLAN_BINARY: ${{ steps.terraform.outputs.plan_binary }}
        TERRAFORM_PLAN_JSON: ${{ steps.terraform.outputs.plan_json }}
        TERRAFORM_PLAN_DETAILED_EXITCODE: ${{ steps.terraform.outputs.detailed_exitcode }}
        TFMIGRATE_PLAN_BINARY: ${{ steps.tfmigrate.outputs.plan_binary }}
        TFMIGRATE_PLAN_JSON: ${{ steps.tfmigrate.outputs.plan_json }}
      run: |
        if [ "$TFACTION_JOB_TYPE" = "tfmigrate" ]; then
          echo "plan_binary=$TFMIGRATE_PLAN_BINARY" >> "$GITHUB_OUTPUT"
          echo "plan_json=$TFMIGRATE_PLAN_JSON" >> "$GITHUB_OUTPUT"
          echo "detailed_exitcode=0" >> "$GITHUB_OUTPUT"
          exit 0
        fi
        echo "plan_binary=$TERRAFORM_PLAN_BINARY" >> "$GITHUB_OUTPUT"
        echo "plan_json=$TERRAFORM_PLAN_JSON" >> "$GITHUB_OUTPUT"
        echo "detailed_exitcode=$TERRAFORM_PLAN_DETAILED_EXITCODE" >> "$GITHUB_OUTPUT"
