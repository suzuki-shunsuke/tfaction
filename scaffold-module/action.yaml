name: Scaffold Terraform Module
description: Scaffold Terraform Module
inputs:
  github_token:
    description: |
      GitHub Access Token
      contents:write - Create branches
      If skip_create_pr is false
      pull-requests:write - Create pull requests
    required: true

  module_path:
    description: 'Module path'
    required: true

runs:
  using: composite
  steps:
    - run: |
        echo "::error ::github_token is required"
        exit 1
      shell: bash
      if: inputs.github_token == ''
    - run: |
        echo "::error ::module_path is required"
        exit 1
      shell: bash
      if: inputs.module_path == ''

    - run: |
        if [ -e "${MODULE_PATH}" ]; then
          echo "::error ::file exists"
          exit 1
        fi
      shell: bash
      env:
        MODULE_PATH: ${{inputs.module_path}}

    - uses: suzuki-shunsuke/tfaction/get-global-config@main
      id: global-config

    - run: |
        mkdir -p "$(dirname "$MODULE_PATH")"
      shell: bash
      env:
        MODULE_PATH: ${{inputs.module_path}}

    - run: cp -R "${GITHUB_ACTION_PATH}/template" "$MODULE_PATH"
      shell: bash
      env:
        MODULE_PATH: ${{inputs.module_path}}

    - run: |
        sed -i "s|%%MODULE_NAME%%|$(basename "$MODULE_PATH")|g" "${MODULE_PATH}/docs/header.md"
      shell: bash
      env:
        MODULE_PATH: ${{inputs.module_path}}

    - run: |
        sed -i "s|%%MODULE_PATH%%|$MODULE_PATH|g" "${MODULE_PATH}/docs/header.md"
      shell: bash
      env:
        MODULE_PATH: ${{inputs.module_path}}

    - run: |
        sed -i "s|%%GITHUB_REPOSITORY%%|$GITHUB_REPOSITORY|g" "${MODULE_PATH}/docs/header.md"
      shell: bash
      env:
        MODULE_PATH: ${{inputs.module_path}}

    - run: |
        sed -i "s|%%REF%%|module_${MODULE_PATH/\//_}_v0.1.0|g" "${MODULE_PATH}/docs/header.md"
      shell: bash
      env:
        MODULE_PATH: ${{inputs.module_path}}

    - run: aqua init
      shell: bash
      working-directory: ${{inputs.module_path}}
      if: env.TFACTION_SKIP_ADDING_AQUA_PACKAGES != 'true'

    - run: aqua g -i hashicorp/terraform
      shell: bash
      working-directory: ${{inputs.module_path}}
      if: env.TFACTION_SKIP_ADDING_AQUA_PACKAGES != 'true'

    - run: aqua g -i aquasecurity/tfsec
      shell: bash
      working-directory: ${{inputs.module_path}}
      if: env.TFACTION_SKIP_ADDING_AQUA_PACKAGES != 'true' && fromJSON(steps.global-config.outputs.enable_tfsec)

    - run: aqua g -i aquasecurity/trivy
      shell: bash
      working-directory: ${{inputs.module_path}}
      if: env.TFACTION_SKIP_ADDING_AQUA_PACKAGES != 'true' && fromJSON(steps.global-config.outputs.enable_trivy)

    - run: aqua g -i terraform-linters/tflint
      shell: bash
      working-directory: ${{inputs.module_path}}
      if: env.TFACTION_SKIP_ADDING_AQUA_PACKAGES != 'true' && fromJSON(steps.global-config.outputs.enable_tflint)

    - run: aqua i -l -a
      shell: bash
      working-directory: ${{inputs.module_path}}

    - run: terraform-docs . > README.md
      shell: bash
      working-directory: ${{inputs.module_path}}
