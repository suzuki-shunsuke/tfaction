name: Scaffold Terraform Module
description: Scaffold Terraform Module
inputs:
  module_path:
    description: 'Module path'
    required: true

runs:
  using: composite
  steps:
    - run: |
        echo "::error ::module_path is required"
        exit 1
      shell: bash
      if: inputs.module_path == ''

    - run: |
        if [ -e "${MODULE_PATH}" ]; then
          echo "::error ::file exists"
          exit 1
        fi
      shell: bash
      env:
        MODULE_PATH: ${{inputs.module_path}}

    - run: |
        mkdir -p "$(dirname "$MODULE_PATH")"
      shell: bash
      env:
        MODULE_PATH: ${{inputs.module_path}}

    - run: cp -R "${GITHUB_ACTION_PATH}/template" "$MODULE_PATH"
      shell: bash
      env:
        MODULE_PATH: ${{inputs.module_path}}

    - run: |
        sed -i "s|%%MODULE_NAME%%|$(basename "$MODULE_PATH")|g" "${MODULE_PATH}/docs/header.md"
      shell: bash
      env:
        MODULE_PATH: ${{inputs.module_path}}

    - run: |
        sed -i "s|%%MODULE_PATH%%|$MODULE_PATH|g" "${MODULE_PATH}/docs/header.md"
      shell: bash
      env:
        MODULE_PATH: ${{inputs.module_path}}

    - run: |
        sed -i "s|%%GITHUB_REPOSITORY%%|$GITHUB_REPOSITORY|g" "${MODULE_PATH}/docs/header.md"
      shell: bash
      env:
        MODULE_PATH: ${{inputs.module_path}}

    - run: |
        sed -i "s|%%REF%%|module_${MODULE_PATH/\//_}_v0.1.0|g" "${MODULE_PATH}/docs/header.md"
      shell: bash
      env:
        MODULE_PATH: ${{inputs.module_path}}

    - run: aqua init
      shell: bash
      working-directory: ${{inputs.module_path}}
    - run: aqua g -i aquasecurity/tfsec terraform-linters/tflint hashicorp/terraform
      shell: bash
      working-directory: ${{inputs.module_path}}

    - run: aqua i -l -a
      shell: bash
      working-directory: ${{inputs.module_path}}

    - run: terraform-docs . > README.md
      shell: bash
      working-directory: ${{inputs.module_path}}
