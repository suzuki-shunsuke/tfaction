"use strict";(globalThis.webpackChunktfaction=globalThis.webpackChunktfaction||[]).push([[3033],{5405(e,n,t){t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>u,frontMatter:()=>s,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"unreleased/lint","title":"Linting and Formatting","description":"You can perform linting and formatting using the test action.","source":"@site/docs/unreleased/lint.md","sourceDirName":"unreleased","slug":"/unreleased/lint","permalink":"/tfaction/docs/unreleased/lint","draft":false,"unlisted":false,"editUrl":"https://github.com/suzuki-shunsuke/tfaction-docs/edit/main/docs/unreleased/lint.md","tags":[],"version":"current","sidebarPosition":900,"frontMatter":{"sidebar_position":900},"sidebar":"tutorialSidebar","previous":{"title":"Run Terraform When a Dependent Local-Path Module is Updated","permalink":"/tfaction/docs/unreleased/detect-module-dependency"},"next":{"title":"Creating a Root Module from a Template","permalink":"/tfaction/docs/unreleased/scaffold-working-directory"}}');var r=t(4848),a=t(8453);const s={sidebar_position:900},l="Linting and Formatting",o={},c=[{value:"terraform fmt",id:"terraform-fmt",level:2},{value:"terraform-docs",id:"terraform-docs",level:2},{value:"tflint",id:"tflint",level:2},{value:"trivy",id:"trivy",level:2},{value:"reviewdog",id:"reviewdog",level:3},{value:"conftest",id:"conftest",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"linting-and-formatting",children:"Linting and Formatting"})}),"\n",(0,r.jsxs)(n.p,{children:["You can perform linting and formatting using the ",(0,r.jsx)(n.code,{children:"test"})," action."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"terraform fmt"}),"\n",(0,r.jsx)(n.li,{children:"terraform validate"}),"\n",(0,r.jsxs)(n.li,{children:["Optional","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"tflint"}),"\n",(0,r.jsx)(n.li,{children:"trivy"}),"\n",(0,r.jsx)(n.li,{children:"conftest"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Run it after ",(0,r.jsx)(n.code,{children:"terraform-init"})," and before ",(0,r.jsx)(n.code,{children:"plan"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"- name: terraform init\n  uses: suzuki-shunsuke/tfaction@latest\n  with:\n    action: terraform-init\n    github_token: ${{ steps.token.outputs.token }}\n\n- name: Lint\n  uses: suzuki-shunsuke/tfaction@latest\n  with:\n    action: test\n    github_token: ${{ steps.token.outputs.token }}\n\n- name: Plan\n  uses: suzuki-shunsuke/tfaction@latest\n  with:\n    action: plan\n    github_token: ${{ steps.token.outputs.token }}\n"})}),"\n",(0,r.jsx)(n.p,{children:"For now, let's disable tflint and trivy."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml:tfaction-root.yaml",children:"tflint:\n  enabled: false\ntrivy:\n  enabled: false\n"})}),"\n",(0,r.jsx)(n.p,{children:"This enables validation with terraform validate and automatic formatting with terraform fmt."}),"\n",(0,r.jsx)(n.h2,{id:"terraform-fmt",children:"terraform fmt"}),"\n",(0,r.jsx)(n.p,{children:"If the code is not formatted, terraform fmt will format it and automatically push a commit."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://storage.googleapis.com/zenn-user-upload/a54a142fb196-20260208.png",alt:"terraform fmt"})}),"\n",(0,r.jsx)(n.h2,{id:"terraform-docs",children:"terraform-docs"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://terraform-docs.io/",children:"terraform-docs"})," is disabled by default, so let's enable it."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml:tfaction-root.yaml",children:"terraform_docs:\n  enabled: true\n"})}),"\n",(0,r.jsx)(n.p,{children:"Documentation is automatically generated and updated.\ntfaction installs terraform-docs automatically."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://storage.googleapis.com/zenn-user-upload/80fbdc39621f-20260208.png",alt:""})}),"\n",(0,r.jsx)(n.p,{children:"terraform-docs works without configuration, but if you want to write a configuration file, create it at one of the following paths (listed in order of priority):"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:".terraform-docs.ya?ml"})," in the root module"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:".config/.terraform-docs.ya?ml"})," in the root module"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:".terraform-docs.ya?ml"})," in the repository root"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:".config/.terraform-docs.ya?ml"})," in the repository root"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"tflint",children:"tflint"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://github.com/terraform-linters/tflint",children:"tflint"})," is enabled by default, but you can also explicitly enable it in the configuration."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml:tfaction-root.yaml",children:"tflint:\n  enabled: true\n"})}),"\n",(0,r.jsx)(n.p,{children:"You need to install tflint.\nLet's add it to aqua.yaml."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"aqua g -i terraform-linters/tflint\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml:aqua.yaml",children:"packages:\n  - name: terraform-linters/tflint@v0.61.0\n"})}),"\n",(0,r.jsx)(n.p,{children:"tflint performs linting and reviewdog creates reviews."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://storage.googleapis.com/zenn-user-upload/49d868efb665-20260208.png",alt:""})}),"\n",(0,r.jsx)(n.p,{children:"Automatic fixes with tflint --fix are also supported.\nThis is enabled by default, but can be disabled."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"tflint:\n  fix: false\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://github.com/terraform-linters/tflint/blob/master/docs/user-guide/config.md",children:"Refer to tflint's official documentation for configuration file details."}),"\nIf you want to share a common configuration file, create one in the repository root and set the ",(0,r.jsx)(n.code,{children:"TFLINT_CONFIG_FILE"})," environment variable."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"env:\n  TFLINT_CONFIG_FILE: ${{github.workspace}}/.tflint.hcl\n"})}),"\n",(0,r.jsx)(n.h2,{id:"trivy",children:"trivy"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://trivy.dev/",children:"trivy"})," is enabled by default, but you can also explicitly enable it in the configuration."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml:tfaction-root.yaml",children:"trivy:\n  enabled: true\n"})}),"\n",(0,r.jsx)(n.p,{children:"You need to install trivy.\nLet's add it to aqua.yaml."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"aqua g -i aquasecurity/trivy\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml:aqua.yaml",children:"packages:\n  - name: aquasecurity/trivy@v0.69.1\n"})}),"\n",(0,r.jsx)(n.p,{children:"trivy performs linting and reviewdog creates reviews."}),"\n",(0,r.jsx)(n.h3,{id:"reviewdog",children:"reviewdog"}),"\n",(0,r.jsx)(n.p,{children:"trivy and tflint results are reflected in PRs through reviewdog.\nYou can configure reviewdog's command-line options."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml:tfaction-root.yaml",children:"tflint:\n  reviewdog:\n    filter_mode: added # Default is nofilter\n    fail_level: error # Default is any\ntrivy:\n  reviewdog:\n    filter_mode: added # Default is nofilter\n    fail_level: error # Default is any\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The important setting is ",(0,r.jsx)(n.code,{children:"filter_mode"}),".\nThe default is ",(0,r.jsx)(n.code,{children:"nofilter"}),", which targets all files in the root module.\nOn the other hand, ",(0,r.jsx)(n.code,{children:"added"})," targets only changed files.\nWhich is better depends on your situation.\nIf you want to strictly enforce policies, ",(0,r.jsx)(n.code,{children:"nofilter"})," is appropriate.\nHowever, it is often difficult to retroactively apply policies to existing code.\nIn that case, it may be more practical to give up on applying policies to existing code and use ",(0,r.jsx)(n.code,{children:"added"})," to apply policies only to new code."]}),"\n",(0,r.jsx)(n.h2,{id:"conftest",children:"conftest"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://www.conftest.dev/",children:"conftest"})," is executed in the test and plan actions.\nIn test, it runs against HCL; in plan, it runs against plan files.\nUsually, running against plan files is preferable."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["You can apply policies based on plan results (create, update, destroy)","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"For example, you can apply policies only to new resources or apply policies on destroy"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"You can apply policies based on terraform's computed results"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"On the other hand, there are cases where running against HCL is better."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Settings like backend configuration are not included in plan files, so policies can only be applied against HCL"}),"\n",(0,r.jsx)(n.li,{children:"Since terraform plan carries risks such as arbitrary code execution and credential exfiltration, you can apply policies against HCL before running terraform plan to check for dangerous code"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://zenn.dev/shunsuke_suzuki/scraps/53d7f5e954f90d",children:"https://zenn.dev/shunsuke_suzuki/scraps/53d7f5e954f90d"})}),"\n",(0,r.jsxs)(n.p,{children:["To run against HCL, specify ",(0,r.jsx)(n.code,{children:"tf: true"}),".\nTo run against plan files, specify ",(0,r.jsx)(n.code,{children:"plan: true"}),".\nIf neither is specified, conftest can also run against non-Terraform files such as YAML or Dockerfiles."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml:tfaction-root.yaml",children:'conftest:\n  policies:\n    - policy: policy/tf\n      tf: true\n      id: tf\n    - policy: policy/plan\n      plan: true\n      id: plan\n    - policy: policy/yaml\n      paths:\n        - "*.yml"\n        - "*.yaml"\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:".conftest.policies[]"})," supports many options of the ",(0,r.jsx)(n.code,{children:"conftest test"})," command."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml:tfaction-root.yaml",children:"conftest:\n  policies:\n    - policy: # array or string\n        - policy/terraform\n      data: # array or string\n        - data/data.yaml\n      fail_on_warn: true\n      no_fail: true\n      all_namespaces: true\n      quiet: true\n      trace: true\n      strict: true\n      show_builtin_errors: true\n      junit_hide_message: true\n      suppress_exceptions: true\n      tls: true\n      parser: hcl\n      output: json\n      namespaces:\n        - main\n"})}),"\n",(0,r.jsx)(n.p,{children:"In addition, there are several tfaction-specific settings."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"id: Optional. An ID to identify the policy. Required when you want to override a policy."}),"\n",(0,r.jsx)(n.li,{children:"plan: Set to true to run against plan files. Default is false."}),"\n",(0,r.jsx)(n.li,{children:"tf: Set to true to run against _.tf and _.tf.json files. Default is false."}),"\n",(0,r.jsx)(n.li,{children:"enabled: Default is true. Useful when you want to override and disable a setting."}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453(e,n,t){t.d(n,{R:()=>s,x:()=>l});var i=t(6540);const r={},a=i.createContext(r);function s(e){const n=i.useContext(a);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);