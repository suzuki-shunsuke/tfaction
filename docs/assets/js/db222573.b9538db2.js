"use strict";(globalThis.webpackChunktfaction=globalThis.webpackChunktfaction||[]).push([[2460],{6270(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>a,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"unreleased/v2-upgrade-guide","title":"v2 Upgrade Guide","description":"The v2 upgrade includes several breaking changes.","source":"@site/docs/unreleased/v2-upgrade-guide.md","sourceDirName":"unreleased","slug":"/unreleased/v2-upgrade-guide","permalink":"/tfaction/docs/unreleased/v2-upgrade-guide","draft":false,"unlisted":false,"editUrl":"https://github.com/suzuki-shunsuke/tfaction-docs/edit/main/docs/unreleased/v2-upgrade-guide.md","tags":[],"version":"current","sidebarPosition":3700,"frontMatter":{"sidebar_position":3700},"sidebar":"tutorialSidebar","previous":{"title":"v2 Release Note","permalink":"/tfaction/docs/unreleased/v2-release-note"}}');var r=t(4848),s=t(8453);const a={sidebar_position:3700},i="v2 Upgrade Guide",l={},c=[{value:"Let a coding agent handle the upgrade",id:"let-a-coding-agent-handle-the-upgrade",level:2},{value:"Summary",id:"summary",level:2},{value:"Migrate <code>suzuki-shunsuke/tfaction/*</code> to <code>suzuki-shunsuke/tfaction</code> and add the <code>action</code> input",id:"migrate-suzuki-shunsuketfaction-to-suzuki-shunsuketfaction-and-add-the-action-input",level:2},{value:"Explicitly run <code>aws-actions/configure-aws-credentials</code> or <code>google-github-actions/auth</code> if AWS or Google Cloud authentication is required",id:"explicitly-run-aws-actionsconfigure-aws-credentials-or-google-github-actionsauth-if-aws-or-google-cloud-authentication-is-required",level:2},{value:"Remove the export-secrets and export-aws-secrets-manager environment variable export feature",id:"remove-the-export-secrets-and-export-aws-secrets-manager-environment-variable-export-feature",level:2},{value:"Migrate tfaction-go to <code>suzuki-shunsuke/tfaction/*</code>",id:"migrate-tfaction-go-to-suzuki-shunsuketfaction",level:2},{value:"Add the <code>TFACTION_SKIP_TERRAFORM</code> environment variable to jobs",id:"add-the-tfaction_skip_terraform-environment-variable-to-jobs",level:2},{value:"Remove module testing jobs that use <code>test-module</code>",id:"remove-module-testing-jobs-that-use-test-module",level:2},{value:"Remove workflows that use scaffold-module or create-scaffold-module-pr",id:"remove-workflows-that-use-scaffold-module-or-create-scaffold-module-pr",level:2},{value:"Remove SSH Key configuration",id:"remove-ssh-key-configuration",level:2},{value:"Add update-pr-branch action after apply action",id:"add-update-pr-branch-action-after-apply-action",level:2},{value:"Change <code>plan_workflow_name</code> from workflow name to file name (e.g., <code>test</code> to <code>test.yaml</code>)",id:"change-plan_workflow_name-from-workflow-name-to-file-name-eg-test-to-testyaml",level:2},{value:"Remove <code>skip_terraform_by_renovate</code> and <code>renovate_terraform_labels</code>. Add <code>skip_terraform_files</code> if needed",id:"remove-skip_terraform_by_renovate-and-renovate_terraform_labels-add-skip_terraform_files-if-needed",level:2},{value:"Change target_groups <code>working_directory</code> to glob patterns",id:"change-target_groups-working_directory-to-glob-patterns",level:2},{value:"Change file paths in tfaction-root.yaml to paths relative to the repository root",id:"change-file-paths-in-tfaction-rootyaml-to-paths-relative-to-the-repository-root",level:2},{value:"Remove tfsec support",id:"remove-tfsec-support",level:2},{value:"Migrate <code>conftest_policy_directory</code> to <code>conftest</code>",id:"migrate-conftest_policy_directory-to-conftest",level:2},{value:"Remove automatic Conftest execution when a <code>policy</code> directory exists",id:"remove-automatic-conftest-execution-when-a-policy-directory-exists",level:2},{value:"Migrate target_groups <code>target</code> to <code>replace_target</code>",id:"migrate-target_groups-target-to-replace_target",level:2},{value:"Remove <code>target</code> from <code>label_prefixes</code>",id:"remove-target-from-label_prefixes",level:2},{value:"Change <code>follow_up_pr_group_label</code> to <code>follow_up_pr.group_label</code>",id:"change-follow_up_pr_group_label-to-follow_up_prgroup_label",level:2},{value:"Change <code>renovate_login</code> to <code>auto_apps.logins</code>",id:"change-renovate_login-to-auto_appslogins",level:2},{value:"Remove <code>update_related_pull_requests</code>",id:"remove-update_related_pull_requests",level:2},{value:"Template changes",id:"template-changes",level:2},{value:"<code>renovate.json</code> changes",id:"renovatejson-changes",level:2},{value:"Remove target label feature",id:"remove-target-label-feature",level:2},{value:"Disable auto-merge instead of failing CI when a Renovate PR is not &quot;No Change&quot;",id:"disable-auto-merge-instead-of-failing-ci-when-a-renovate-pr-is-not-no-change",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"v2-upgrade-guide",children:"v2 Upgrade Guide"})}),"\n",(0,r.jsx)(n.p,{children:"The v2 upgrade includes several breaking changes.\nAll tfaction users need to address these changes."}),"\n",(0,r.jsx)(n.h2,{id:"let-a-coding-agent-handle-the-upgrade",children:"Let a coding agent handle the upgrade"}),"\n",(0,r.jsx)(n.p,{children:"You can have a coding agent such as Claude Code perform the upgrade by providing the official upgrade guide."}),"\n",(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsx)(n.p,{children:"Accuracy depends on the model, and LLMs may make incorrect changes.\nAlways review the changes manually."})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Upgrade tfaction to v2 according to the guide.\n"})}),"\n",(0,r.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["GitHub Actions Workflow changes","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Migrate ",(0,r.jsx)(n.code,{children:"suzuki-shunsuke/tfaction/*"})," to ",(0,r.jsx)(n.code,{children:"suzuki-shunsuke/tfaction"})," and add the ",(0,r.jsx)(n.code,{children:"action"})," input"]}),"\n",(0,r.jsxs)(n.li,{children:["If AWS or Google Cloud authentication is required, explicitly run ",(0,r.jsx)(n.code,{children:"aws-actions/configure-aws-credentials"})," or ",(0,r.jsx)(n.code,{children:"google-github-actions/auth"})]}),"\n",(0,r.jsx)(n.li,{children:"Remove the feature that exports secrets as environment variables via export-secrets or export-aws-secrets-manager"}),"\n",(0,r.jsxs)(n.li,{children:["Migrate tfaction-go to ",(0,r.jsx)(n.code,{children:"suzuki-shunsuke/tfaction/*"})]}),"\n",(0,r.jsxs)(n.li,{children:["Add the ",(0,r.jsx)(n.code,{children:"TFACTION_SKIP_TERRAFORM"})," environment variable to jobs"]}),"\n",(0,r.jsxs)(n.li,{children:["Remove module testing jobs that use ",(0,r.jsx)(n.code,{children:"test-module"})]}),"\n",(0,r.jsx)(n.li,{children:"Remove workflows that use scaffold-module or create-scaffold-module-pr"}),"\n",(0,r.jsx)(n.li,{children:"Remove SSH Key configuration"}),"\n",(0,r.jsx)(n.li,{children:"Add update-pr-branch action after apply action"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["tfaction-root.yaml changes","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["If ",(0,r.jsx)(n.code,{children:"plan_workflow_name"})," specifies a workflow name, change it to a file name (e.g., ",(0,r.jsx)(n.code,{children:"test"})," to ",(0,r.jsx)(n.code,{children:"test.yaml"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:["Remove ",(0,r.jsx)(n.code,{children:"skip_terraform_by_renovate"})," and ",(0,r.jsx)(n.code,{children:"renovate_terraform_labels"}),". Add ",(0,r.jsx)(n.code,{children:"skip_terraform_files"})," if needed"]}),"\n",(0,r.jsxs)(n.li,{children:["Remove tfsec support","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Migration to trivy is recommended"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Migrate ",(0,r.jsx)(n.code,{children:"conftest_policy_directory"})," to ",(0,r.jsx)(n.code,{children:"conftest"})]}),"\n",(0,r.jsxs)(n.li,{children:["Remove automatic Conftest execution when a ",(0,r.jsx)(n.code,{children:"policy"})," directory exists","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Explicit configuration in tfaction-root.yaml is now required"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Migrate target_groups ",(0,r.jsx)(n.code,{children:"target"})," to ",(0,r.jsx)(n.code,{children:"replace_target"})]}),"\n",(0,r.jsxs)(n.li,{children:["Change target_groups ",(0,r.jsx)(n.code,{children:"working_directory"})," to glob patterns","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Trailing ",(0,r.jsx)(n.code,{children:"/"})," is no longer needed"]}),"\n",(0,r.jsx)(n.li,{children:"Changed from prefix matching to exact matching"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Remove ",(0,r.jsx)(n.code,{children:"target"})," from ",(0,r.jsx)(n.code,{children:"label_prefixes"})]}),"\n",(0,r.jsxs)(n.li,{children:["Change file paths in tfaction-root.yaml (",(0,r.jsx)(n.code,{children:"working_directory"}),", ",(0,r.jsx)(n.code,{children:"template_dir"}),", ",(0,r.jsx)(n.code,{children:"conftest.policy"}),") to ",(0,r.jsx)(n.strong,{children:"paths relative to the repository root where tfaction-root.yaml is located"})]}),"\n",(0,r.jsxs)(n.li,{children:["Change ",(0,r.jsx)(n.code,{children:"follow_up_pr_group_label"})," to ",(0,r.jsx)(n.code,{children:"follow_up_pr.group_label"})]}),"\n",(0,r.jsxs)(n.li,{children:["Change ",(0,r.jsx)(n.code,{children:"renovate_login"})," to ",(0,r.jsx)(n.code,{children:"auto_apps.logins"})]}),"\n",(0,r.jsxs)(n.li,{children:["Remove ",(0,r.jsx)(n.code,{children:"update_related_pull_requests"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Template changes","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Update placeholders to use ",(0,r.jsx)(n.a,{href:"https://handlebarsjs.com/",children:"Handlebars"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"renovate.json"})," changes","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Remove the ",(0,r.jsx)(n.code,{children:"renovate-change"})," label"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Remove target label feature","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Removed because applying without codeowner review is a governance concern"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:'When a Renovate PR is not "No Change", disable auto-merge instead of failing CI'}),"\n"]}),"\n",(0,r.jsxs)(n.h2,{id:"migrate-suzuki-shunsuketfaction-to-suzuki-shunsuketfaction-and-add-the-action-input",children:["Migrate ",(0,r.jsx)(n.code,{children:"suzuki-shunsuke/tfaction/*"})," to ",(0,r.jsx)(n.code,{children:"suzuki-shunsuke/tfaction"})," and add the ",(0,r.jsx)(n.code,{children:"action"})," input"]}),"\n",(0,r.jsx)(n.p,{children:"Before:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"uses: suzuki-shunsuke/tfaction/plan@latest\n"})}),"\n",(0,r.jsx)(n.p,{children:"After:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"uses: suzuki-shunsuke/tfaction@latest\nwith:\n  action: plan\n"})}),"\n",(0,r.jsx)(n.p,{children:"The following actions are supported:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"apply"}),"\n",(0,r.jsx)(n.li,{children:"create-drift-issues"}),"\n",(0,r.jsx)(n.li,{children:"create-follow-up-pr"}),"\n",(0,r.jsx)(n.li,{children:"create-scaffold-module-pr"}),"\n",(0,r.jsx)(n.li,{children:"create-scaffold-pr"}),"\n",(0,r.jsx)(n.li,{children:"export-aws-secrets-manager"}),"\n",(0,r.jsx)(n.li,{children:"export-secrets"}),"\n",(0,r.jsx)(n.li,{children:"generate-config-out"}),"\n",(0,r.jsx)(n.li,{children:"get-global-config"}),"\n",(0,r.jsx)(n.li,{children:"get-or-create-drift-issue"}),"\n",(0,r.jsx)(n.li,{children:"get-target-config"}),"\n",(0,r.jsx)(n.li,{children:"list-targets"}),"\n",(0,r.jsx)(n.li,{children:"pick-out-drift-issues"}),"\n",(0,r.jsx)(n.li,{children:"plan"}),"\n",(0,r.jsx)(n.li,{children:"release-module"}),"\n",(0,r.jsx)(n.li,{children:"scaffold-module"}),"\n",(0,r.jsx)(n.li,{children:"scaffold-tfmigrate"}),"\n",(0,r.jsx)(n.li,{children:"scaffold-working-dir"}),"\n",(0,r.jsx)(n.li,{children:"set-drift-env"}),"\n",(0,r.jsx)(n.li,{children:"setup"}),"\n",(0,r.jsx)(n.li,{children:"sync-drift-issue-description"}),"\n",(0,r.jsx)(n.li,{children:"terraform-init"}),"\n",(0,r.jsx)(n.li,{children:"test"}),"\n",(0,r.jsx)(n.li,{children:"test-module"}),"\n",(0,r.jsx)(n.li,{children:"update-drift-issue"}),"\n"]}),"\n",(0,r.jsxs)(n.h2,{id:"explicitly-run-aws-actionsconfigure-aws-credentials-or-google-github-actionsauth-if-aws-or-google-cloud-authentication-is-required",children:["Explicitly run ",(0,r.jsx)(n.code,{children:"aws-actions/configure-aws-credentials"})," or ",(0,r.jsx)(n.code,{children:"google-github-actions/auth"})," if AWS or Google Cloud authentication is required"]}),"\n",(0,r.jsxs)(n.p,{children:["In v1, the setup action ran ",(0,r.jsx)(n.code,{children:"aws-actions/configure-aws-credentials"})," or ",(0,r.jsx)(n.code,{children:"google-github-actions/auth"})," internally.\nIn v2, this is no longer done automatically.\nUsers need to run these actions themselves as needed.\nThe ",(0,r.jsx)(n.code,{children:"setup"})," action outputs the IAM Role ARN and other values based on tfaction-root.yaml and tfaction.yaml configuration."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"- name: Set up\n  uses: suzuki-shunsuke/tfaction@latest\n  id: setup\n  with:\n    action: setup\n    github_token: ${{steps.token.outputs.token}}\n    securefix_action_app_id: ${{vars.SECUREFIX_ACTION_CLIENT_APP_ID}}\n    securefix_action_app_private_key: ${{secrets.SECUREFIX_ACTION_CLIENT_APP_PRIVATE_KEY}}\n\n- uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5.1.1\n  if: steps.setup.outputs.aws_assume_role_arn != ''\n  with:\n    role-to-assume: ${{ steps.setup.outputs.aws_assume_role_arn }}\n    role-session-name: ${{ steps.setup.outputs.aws_role_session_name }}\n    aws-region: ${{ steps.setup.outputs.aws_region }}\n\n- name: terraform init\n  uses: suzuki-shunsuke/tfaction@latest\n  with:\n    action: terraform-init\n"})}),"\n",(0,r.jsx)(n.h2,{id:"remove-the-export-secrets-and-export-aws-secrets-manager-environment-variable-export-feature",children:"Remove the export-secrets and export-aws-secrets-manager environment variable export feature"}),"\n",(0,r.jsxs)(n.h2,{id:"migrate-tfaction-go-to-suzuki-shunsuketfaction",children:["Migrate tfaction-go to ",(0,r.jsx)(n.code,{children:"suzuki-shunsuke/tfaction/*"})]}),"\n",(0,r.jsx)(n.p,{children:"If you are not using Drift Detection, you can ignore this."}),"\n",(0,r.jsx)(n.p,{children:"Before:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"- run: tfaction create-drift-issues\n"})}),"\n",(0,r.jsx)(n.p,{children:"After:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"- uses: suzuki-shunsuke/tfaction@latest\n  with:\n    action: create-drift-issues\n"})}),"\n",(0,r.jsxs)(n.h2,{id:"add-the-tfaction_skip_terraform-environment-variable-to-jobs",children:["Add the ",(0,r.jsx)(n.code,{children:"TFACTION_SKIP_TERRAFORM"})," environment variable to jobs"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'jobs:\n  plan:\n    env:\n      TFACTION_SKIP_TERRAFORM: "${{matrix.target.skip_terraform}}"\n'})}),"\n",(0,r.jsxs)(n.h2,{id:"remove-module-testing-jobs-that-use-test-module",children:["Remove module testing jobs that use ",(0,r.jsx)(n.code,{children:"test-module"})]}),"\n",(0,r.jsx)(n.p,{children:"If your plan workflow has a job that uses the test-module action to test modules, remove that job.\nIt has been integrated into the job for testing root modules."}),"\n",(0,r.jsx)(n.h2,{id:"remove-workflows-that-use-scaffold-module-or-create-scaffold-module-pr",children:"Remove workflows that use scaffold-module or create-scaffold-module-pr"}),"\n",(0,r.jsx)(n.p,{children:"Remove workflows for creating modules.\nThey have been integrated into the workflow for creating root modules."}),"\n",(0,r.jsx)(n.h2,{id:"remove-ssh-key-configuration",children:"Remove SSH Key configuration"}),"\n",(0,r.jsxs)(n.p,{children:["The feature that configured SSH Keys via the ",(0,r.jsx)(n.code,{children:"ssh_key"})," input of the setup action has been removed.\nConfigure SSH Keys yourself if needed."]}),"\n",(0,r.jsx)(n.h2,{id:"add-update-pr-branch-action-after-apply-action",children:"Add update-pr-branch action after apply action"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"- name: Apply\n  uses: suzuki-shunsuke/tfaction@latest\n  with:\n    action: apply\n    github_token: ${{ steps.token.outputs.token }}\n\n# Add this after apply\n- name: Update related PR branches\n  uses: suzuki-shunsuke/tfaction@latest\n  if: always()\n  with:\n    action: update-pr-branch\n    github_token: ${{ steps.token.outputs.token }}\n"})}),"\n",(0,r.jsxs)(n.h2,{id:"change-plan_workflow_name-from-workflow-name-to-file-name-eg-test-to-testyaml",children:["Change ",(0,r.jsx)(n.code,{children:"plan_workflow_name"})," from workflow name to file name (e.g., ",(0,r.jsx)(n.code,{children:"test"})," to ",(0,r.jsx)(n.code,{children:"test.yaml"}),")"]}),"\n",(0,r.jsx)(n.p,{children:"Before:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"plan_workflow_name: test\n"})}),"\n",(0,r.jsx)(n.p,{children:"After:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"plan_workflow_name: test.yaml\n"})}),"\n",(0,r.jsxs)(n.h2,{id:"remove-skip_terraform_by_renovate-and-renovate_terraform_labels-add-skip_terraform_files-if-needed",children:["Remove ",(0,r.jsx)(n.code,{children:"skip_terraform_by_renovate"})," and ",(0,r.jsx)(n.code,{children:"renovate_terraform_labels"}),". Add ",(0,r.jsx)(n.code,{children:"skip_terraform_files"})," if needed"]}),"\n",(0,r.jsx)(n.p,{children:"Remove:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"skip_terraform_by_renovate: true\nrenovate_terraform_labels:\n  - terraform\n"})}),"\n",(0,r.jsx)(n.p,{children:"Add (optional):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'skip_terraform_files:\n  - "**/*.md" # Skip terraform plan and apply for markdown changes\n'})}),"\n",(0,r.jsxs)(n.h2,{id:"change-target_groups-working_directory-to-glob-patterns",children:["Change target_groups ",(0,r.jsx)(n.code,{children:"working_directory"})," to glob patterns"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Trailing ",(0,r.jsx)(n.code,{children:"/"})," is no longer needed"]}),"\n",(0,r.jsx)(n.li,{children:"Changed from prefix matching to exact matching"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/isaacs/minimatch",children:"minimatch"})," is used"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Before:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"target_groups:\n  - working_directory: foo/\n"})}),"\n",(0,r.jsx)(n.p,{children:"After:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"target_groups:\n  - working_directory: foo/**\n"})}),"\n",(0,r.jsx)(n.h2,{id:"change-file-paths-in-tfaction-rootyaml-to-paths-relative-to-the-repository-root",children:"Change file paths in tfaction-root.yaml to paths relative to the repository root"}),"\n",(0,r.jsxs)(n.p,{children:["File paths in tfaction-root.yaml (",(0,r.jsx)(n.code,{children:"working_directory"}),", ",(0,r.jsx)(n.code,{children:"template_dir"}),", ",(0,r.jsx)(n.code,{children:"conftest.policy"}),") are now ",(0,r.jsx)(n.strong,{children:"relative to the repository root where tfaction-root.yaml is located"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["Previously, paths were relative to ",(0,r.jsx)(n.code,{children:"GITHUB_WORKSPACE"}),", meaning they depended on the checkout path. This is no longer the case."]}),"\n",(0,r.jsx)(n.h2,{id:"remove-tfsec-support",children:"Remove tfsec support"}),"\n",(0,r.jsx)(n.p,{children:"Migration to trivy is recommended.\nRemove tfsec configuration from tfaction-root.yaml:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"tfsec: # Remove this\n  enabled: true\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://github.com/aquasecurity/tfsec",children:"tfsec"})," has officially recommended migrating to trivy.\nTherefore, tfaction will no longer support it."]}),"\n",(0,r.jsxs)(n.h2,{id:"migrate-conftest_policy_directory-to-conftest",children:["Migrate ",(0,r.jsx)(n.code,{children:"conftest_policy_directory"})," to ",(0,r.jsx)(n.code,{children:"conftest"})]}),"\n",(0,r.jsx)(n.p,{children:"Before:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"conftest_policy_directory: policy\n"})}),"\n",(0,r.jsx)(n.p,{children:"After:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"conftest:\n  policies:\n    - policy: policy\n      plan: true\n"})}),"\n",(0,r.jsxs)(n.h2,{id:"remove-automatic-conftest-execution-when-a-policy-directory-exists",children:["Remove automatic Conftest execution when a ",(0,r.jsx)(n.code,{children:"policy"})," directory exists"]}),"\n",(0,r.jsxs)(n.p,{children:["In v1, Conftest was automatically executed when a ",(0,r.jsx)(n.code,{children:"policy"})," directory existed. This has been removed.\nTo run Conftest, you need to explicitly configure it in tfaction-root.yaml:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"conftest:\n  policies:\n    - policy: policy\n      plan: true\n"})}),"\n",(0,r.jsxs)(n.h2,{id:"migrate-target_groups-target-to-replace_target",children:["Migrate target_groups ",(0,r.jsx)(n.code,{children:"target"})," to ",(0,r.jsx)(n.code,{children:"replace_target"})]}),"\n",(0,r.jsx)(n.p,{children:"Before:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"target_groups:\n  - working_directory: github/services/\n    target: github/\n"})}),"\n",(0,r.jsx)(n.p,{children:"After:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"replace_target:\n  patterns:\n    - regexp: /services/\n      replace: /\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Also, ",(0,r.jsx)(n.code,{children:"replace"})," has been renamed to ",(0,r.jsx)(n.code,{children:"replace_target"}),"."]}),"\n",(0,r.jsxs)(n.h2,{id:"remove-target-from-label_prefixes",children:["Remove ",(0,r.jsx)(n.code,{children:"target"})," from ",(0,r.jsx)(n.code,{children:"label_prefixes"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'label_prefixes:\n  target: "target:" # Remove this\n'})}),"\n",(0,r.jsxs)(n.h2,{id:"change-follow_up_pr_group_label-to-follow_up_prgroup_label",children:["Change ",(0,r.jsx)(n.code,{children:"follow_up_pr_group_label"})," to ",(0,r.jsx)(n.code,{children:"follow_up_pr.group_label"})]}),"\n",(0,r.jsx)(n.p,{children:"Before:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'follow_up_pr_group_label:\n  enabled: true\n  prefix: "tfaction:follow-up-pr-group/"\n'})}),"\n",(0,r.jsx)(n.p,{children:"After:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'follow_up_pr:\n  group_label:\n    enabled: true\n    prefix: "tfaction:follow-up-pr-group/"\n'})}),"\n",(0,r.jsxs)(n.h2,{id:"change-renovate_login-to-auto_appslogins",children:["Change ",(0,r.jsx)(n.code,{children:"renovate_login"})," to ",(0,r.jsx)(n.code,{children:"auto_apps.logins"})]}),"\n",(0,r.jsx)(n.p,{children:"Before:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'renovate_login: "renovate[bot]"\n'})}),"\n",(0,r.jsx)(n.p,{children:"After:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'auto_apps:\n  logins:\n    - "renovate[bot]"\n'})}),"\n",(0,r.jsxs)(n.p,{children:["You can now specify multiple GitHub accounts.\nBy default, both ",(0,r.jsx)(n.code,{children:"renovate[bot]"})," and ",(0,r.jsx)(n.code,{children:"dependabot[bot]"})," are included.\nIf you want to exclude ",(0,r.jsx)(n.code,{children:"dependabot[bot]"})," and only target ",(0,r.jsx)(n.code,{children:"renovate[bot]"})," as before, explicitly specify only ",(0,r.jsx)(n.code,{children:"renovate[bot]"})," as shown above."]}),"\n",(0,r.jsxs)(n.h2,{id:"remove-update_related_pull_requests",children:["Remove ",(0,r.jsx)(n.code,{children:"update_related_pull_requests"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"update_related_pull_requests: # Remove this\n  enabled: false\n"})}),"\n",(0,r.jsx)(n.p,{children:"PRs are no longer updated unless you run the update-pr-branch action in the apply workflow."}),"\n",(0,r.jsx)(n.h2,{id:"template-changes",children:"Template changes"}),"\n",(0,r.jsxs)(n.p,{children:["Update placeholders to use ",(0,r.jsx)(n.a,{href:"https://handlebarsjs.com/",children:"Handlebars"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Change ",(0,r.jsx)(n.code,{children:"%%...%%"})," to ",(0,r.jsx)(n.code,{children:"{{...}}"})]}),"\n",(0,r.jsx)(n.li,{children:"Variable names use snake_case"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Before:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"%%MODULE_NAME%%\n"})}),"\n",(0,r.jsx)(n.p,{children:"After:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"{{module_name}}\n"})}),"\n",(0,r.jsxs)(n.h2,{id:"renovatejson-changes",children:[(0,r.jsx)(n.code,{children:"renovate.json"})," changes"]}),"\n",(0,r.jsxs)(n.p,{children:["Remove the ",(0,r.jsx)(n.code,{children:"renovate-change"})," label."]}),"\n",(0,r.jsx)(n.h2,{id:"remove-target-label-feature",children:"Remove target label feature"}),"\n",(0,r.jsxs)(n.p,{children:["The feature that ran CI for a specified target by adding a ",(0,r.jsx)(n.code,{children:"target:<target>"})," label to a PR -- even without code changes -- has been removed.\nWhile this feature was convenient and occasionally used, allowing ",(0,r.jsx)(n.code,{children:"terraform apply"})," (i.e., infrastructure changes) without codeowner review was a governance concern."]}),"\n",(0,r.jsx)(n.h2,{id:"disable-auto-merge-instead-of-failing-ci-when-a-renovate-pr-is-not-no-change",children:'Disable auto-merge instead of failing CI when a Renovate PR is not "No Change"'}),"\n",(0,r.jsxs)(n.p,{children:["In v1, CI failed when a Renovate PR's ",(0,r.jsx)(n.code,{children:"terraform plan"}),' result was not "No Change".\nThis was to prevent unexpected changes from being applied automatically when auto-merging Renovate PRs.\nTo prevent CI failure, you had to add the ',(0,r.jsx)(n.code,{children:"renovate-change"})," label.\nHowever, failing CI had several issues:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Poor experience","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["To accept the changes, you had to add the ",(0,r.jsx)(n.code,{children:"renovate-change"})," label and then rerun CI"]}),"\n",(0,r.jsxs)(n.li,{children:['It was difficult to distinguish between failures due to "not No Change" and other reasons (e.g., ',(0,r.jsx)(n.code,{children:"terraform validate"})," failing)"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Risk","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["After adding the ",(0,r.jsx)(n.code,{children:"renovate-change"})," label, CI would pass even if there were changes, so with auto-merge enabled, apply would run without anyone reviewing the plan results"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"In v2, auto-merge is disabled to prevent automatic merging."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://storage.googleapis.com/zenn-user-upload/a9426176ff50-20260211.png",alt:""})}),"\n",(0,r.jsxs)(n.p,{children:["Setting ",(0,r.jsx)(n.code,{children:"accept_change_by_renovate: true"})," in tfaction.yaml prevents auto-merge from being disabled.\nThis is intended for root modules used to test whether workflows work correctly when PRs modify them."]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453(e,n,t){t.d(n,{R:()=>a,x:()=>i});var o=t(6540);const r={},s=o.createContext(r);function a(e){const n=o.useContext(s);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),o.createElement(s.Provider,{value:n},e.children)}}}]);