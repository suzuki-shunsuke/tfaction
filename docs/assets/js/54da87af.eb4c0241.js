"use strict";(globalThis.webpackChunktfaction=globalThis.webpackChunktfaction||[]).push([[9167],{1374(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>i,metadata:()=>o,toc:()=>d});const o=JSON.parse('{"id":"unreleased/monorepo","title":"Monorepo","description":"In Getting Started, there was only one root module. Now let\'s set up a monorepo.","source":"@site/docs/unreleased/monorepo.md","sourceDirName":"unreleased","slug":"/unreleased/monorepo","permalink":"/tfaction/docs/unreleased/monorepo","draft":false,"unlisted":false,"editUrl":"https://github.com/suzuki-shunsuke/tfaction-docs/edit/main/docs/unreleased/monorepo.md","tags":[],"version":"current","sidebarPosition":700,"frontMatter":{"sidebar_position":700},"sidebar":"tutorialSidebar","previous":{"title":"tfaction v2 is a Single Action","permalink":"/tfaction/docs/unreleased/single-action"},"next":{"title":"Trigger Terraform When Dependent Local-path Modules Are Updated","permalink":"/tfaction/docs/unreleased/detect-module-dependency"}}');var s=t(4848),r=t(8453);const i={sidebar_position:700},a="Monorepo",l={},d=[];function c(e){const n={a:"a",code:"code",h1:"h1",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"monorepo",children:"Monorepo"})}),"\n",(0,s.jsxs)(n.p,{children:["In ",(0,s.jsx)(n.a,{href:"./getting-started",children:"Getting Started"}),", there was only one root module. Now let's set up a monorepo."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"foo/\n  tfaction.yaml\n  main.tf\n  # ...\nbar/\n  tfaction.yaml\n  main.tf\n  # ...\n"})}),"\n",(0,s.jsxs)(n.p,{children:["In a monorepo, you typically want to run ",(0,s.jsx)(n.code,{children:"terraform plan"})," and ",(0,s.jsx)(n.code,{children:"apply"})," only for the root modules changed in a PR.\nThis is easily achieved using GitHub Actions matrix builds and tfaction's ",(0,s.jsx)(n.code,{children:"list-targets"})," action."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"list-targets"})," outputs a list of root modules changed in the PR.\nIt depends on git, so the repository must be checked out before running it.\nA shallow clone is sufficient."]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Add a ",(0,s.jsx)(n.code,{children:"list"})," job"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Run ",(0,s.jsx)(n.code,{children:"list-targets"})," to get the list of target root modules and output it."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"jobs:\n  list:\n    timeout-minutes: 10\n    runs-on: ubuntu-24.04\n    permissions:\n      contents: read\n    outputs:\n      targets: ${{steps.list-targets.outputs.targets}}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1\n        with:\n          persist-credentials: false\n\n      - name: List Targets\n        uses: suzuki-shunsuke/tfaction@latest\n        id: list-targets\n        with:\n          action: list-targets\n"})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Run plan using matrix builds after the ",(0,s.jsx)(n.code,{children:"list"})," job"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'plan:\n  name: "plan (${{matrix.target.target}})" # Different job name per root module\n  timeout-minutes: 30\n  runs-on: ubuntu-24.04\n  needs: [list] # Run after list\n  permissions:\n    contents: read\n  env:\n    # Set environment variables per root module\n    TFACTION_TARGET: "${{matrix.target.target}}"\n    TFACTION_WORKING_DIR: ${{matrix.target.working_directory}}\n    TFACTION_JOB_TYPE: ${{matrix.target.job_type}}\n  if: "join(fromJSON(needs.list.outputs.targets), \'\') != \'\'" # Skip if no root modules changed\n  strategy:\n    fail-fast: false # Continue other root modules even if one fails\n    matrix:\n      target: ${{fromJSON(needs.list.outputs.targets)}}\n'})}),"\n",(0,s.jsx)(n.p,{children:"This runs CI via matrix builds only for the root modules changed in the PR."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://storage.googleapis.com/zenn-user-upload/738ba40e1d0b-20260208.png",alt:""})}),"\n",(0,s.jsx)(n.p,{children:"PR comments and labels include the root module path, making it easy to identify which root module each comment or label belongs to."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://storage.googleapis.com/zenn-user-upload/84d4951d11b1-20260208.png",alt:""})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://storage.googleapis.com/zenn-user-upload/e2c3f6bc17ba-20260208.png",alt:""})})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453(e,n,t){t.d(n,{R:()=>i,x:()=>a});var o=t(6540);const s={},r=o.createContext(s);function i(e){const n=o.useContext(r);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),o.createElement(r.Provider,{value:n},e.children)}}}]);