"use strict";(globalThis.webpackChunktfaction=globalThis.webpackChunktfaction||[]).push([[8749],{8020(e,t,n){n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>r,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"unreleased/drift-detection","title":"Drift Detection","description":"image","source":"@site/docs/unreleased/drift-detection.md","sourceDirName":"unreleased","slug":"/unreleased/drift-detection","permalink":"/tfaction/docs/unreleased/drift-detection","draft":false,"unlisted":false,"editUrl":"https://github.com/suzuki-shunsuke/tfaction-docs/edit/main/docs/unreleased/drift-detection.md","tags":[],"version":"current","sidebarPosition":2800,"frontMatter":{"sidebar_position":2800},"sidebar":"tutorialSidebar","previous":{"title":"Secure Commits and PR Creation with CSM Actions","permalink":"/tfaction/docs/unreleased/csm-actions"},"next":{"title":"Using OpenTofu or Terragrunt","permalink":"/tfaction/docs/unreleased/opentofu-terragrunt"}}');var i=n(4848),o=n(8453);const a={sidebar_position:2800},r="Drift Detection",c={},d=[{value:"What is Drift Detection?",id:"what-is-drift-detection",level:2},{value:"tfaction&#39;s Drift Detection",id:"tfactions-drift-detection",level:2},{value:"Warning: Do not change the issue title",id:"warning-do-not-change-the-issue-title",level:2},{value:"Enable in tfaction-root.yaml",id:"enable-in-tfaction-rootyaml",level:2},{value:"Create a workflow to periodically detect drift",id:"create-a-workflow-to-periodically-detect-drift",level:2},{value:"Create a workflow to periodically create drift issues",id:"create-a-workflow-to-periodically-create-drift-issues",level:2},{value:"Modify the apply workflow",id:"modify-the-apply-workflow",level:2},{value:"Operational recommendations",id:"operational-recommendations",level:2}];function l(e){const t={code:"code",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"drift-detection",children:"Drift Detection"})}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{src:"https://user-images.githubusercontent.com/13323303/233079963-68765f2e-1efd-4278-b6c3-145eae9ef9c0.png",alt:"image"})}),"\n",(0,i.jsx)(t.p,{children:"tfaction's Drift Detection checks whether the infrastructure definition in code diverges from the actual infrastructure state for each root module, and manages the results by creating a GitHub Issue per root module.\nBy managing drift as issues, you can visualize drift status and handle it at your own pace.\nThis feature is disabled by default. You can enable or disable it per root module, allowing gradual adoption starting with specific root modules or disabling it for particular ones."}),"\n",(0,i.jsx)(t.h2,{id:"what-is-drift-detection",children:"What is Drift Detection?"}),"\n",(0,i.jsx)(t.p,{children:'Here, "Drift" refers to a divergence between the infrastructure definition in code and the actual infrastructure state in IaC. "Drift Detection" is the process of detecting such drift.'}),"\n",(0,i.jsx)(t.p,{children:"Drift Detection is an important topic in IaC, not just Terraform. When drift becomes the norm, the reliability of code is lost.\nWhen making changes, unrelated diffs are detected, requiring you to investigate what the diff is and whether it is safe to apply, which reduces productivity.\nQuickly detecting and resolving drift is essential in IaC."}),"\n",(0,i.jsx)(t.h2,{id:"tfactions-drift-detection",children:"tfaction's Drift Detection"}),"\n",(0,i.jsx)(t.p,{children:"tfaction's Drift Detection only detects drift; it does not automatically resolve it.\nYou need to resolve drift yourself."}),"\n",(0,i.jsx)(t.p,{children:"tfaction manages drift by creating a GitHub Issue for each root module."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{src:"https://github.com/suzuki-shunsuke/tfaction-docs/assets/13323303/2e95f528-8c5d-410c-8dec-fe0dabd3e85a",alt:"image"})}),"\n",(0,i.jsx)(t.p,{children:"When drift is detected, the issue is reopened. When drift is resolved, the issue is closed."}),"\n",(0,i.jsx)(t.p,{children:"Only one issue is created per root module, and it is reused continuously.\nIn other words, when drift occurs again after being resolved, tfaction reopens the existing issue rather than creating a new one."}),"\n",(0,i.jsx)(t.p,{children:"Drift Detection runs at the following times:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["During apply execution (",(0,i.jsx)(t.code,{children:"terraform apply"}),", ",(0,i.jsx)(t.code,{children:"tfmigrate apply"}),")"]}),"\n",(0,i.jsxs)(t.li,{children:["During scheduled execution of the ",(0,i.jsx)(t.code,{children:"schedule-detect-drifts"})," GitHub Actions Workflow"]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:'Drift is detected by running plan or apply on each root module.\nIf the plan result is "No change" or apply succeeds, drift is considered absent and the issue is closed.\nConversely, if the plan result is not "No change" or apply fails, drift is considered present and the issue is reopened.'}),"\n",(0,i.jsx)(t.p,{children:"The plan and apply results are posted as comments on the issue.\nComments include links to the workflow run and pull request."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{src:"https://user-images.githubusercontent.com/13323303/232356803-e1c7298f-362c-4f00-96f0-20f2ac8720f7.png",alt:"image"})}),"\n",(0,i.jsx)(t.p,{children:"Since plan and apply results are recorded as comment history on the issue, you can easily track when drift occurred by looking at the issue.\nYou can also reflect the latest comment into the issue description, so you can see the latest results without scrolling through all comments."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{src:"https://github.com/suzuki-shunsuke/tfaction-docs/assets/13323303/2e95f528-8c5d-410c-8dec-fe0dabd3e85a",alt:"image"})}),"\n",(0,i.jsx)(t.p,{children:"During scheduled plan execution, plans are run for up to n root modules whose issues have the oldest last-updated timestamps.\nSince results are commented on issues during plan and apply execution, the issue's last-updated timestamp gets updated.\nTherefore, an older last-updated timestamp means drift detection has not been run for a while."}),"\n",(0,i.jsx)(t.p,{children:"When Drift Detection is enabled, it is enabled for all root modules by default, but you can also enable or disable it for specific root modules."}),"\n",(0,i.jsx)(t.h2,{id:"warning-do-not-change-the-issue-title",children:"Warning: Do not change the issue title"}),"\n",(0,i.jsxs)(t.p,{children:["tfaction searches for issues by their title, so do not change the title.\nDo not create issues for other purposes that start with ",(0,i.jsx)(t.code,{children:"Terraform Drift"}),".\nTitles must be unique."]}),"\n",(0,i.jsx)(t.p,{children:"If a root module's target name is changed, tfaction automatically creates a new issue for that root module.\nIf you want to keep the same issue, update its title to match the new target name.\nIf you want to recreate an issue for any reason, rename or delete the old issue."}),"\n",(0,i.jsx)(t.p,{children:"If a root module corresponding to an issue is no longer found (e.g., because it was deleted), tfaction automatically renames and closes the issue."}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{src:"https://user-images.githubusercontent.com/13323303/232516561-66cd8dbf-7617-4527-9544-47166e8d6cf6.png",alt:"archive-issue"})}),"\n",(0,i.jsx)(t.h2,{id:"enable-in-tfaction-rootyaml",children:"Enable in tfaction-root.yaml"}),"\n",(0,i.jsx)(t.p,{children:"Drift Detection is disabled by default."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",children:"drift_detection: {}\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",children:"drift_detection:\n  enabled: true\n  # Repository where issues are created. Defaults to the repository where tfaction runs.\n  issue_repo_owner: suzuki-shunsuke\n  issue_repo_name: tfaction-example\n  # Maximum number of drift issues processed per scheduled job run. Default is 1.\n  num_of_issues: 1\n  minimum_detection_interval: 1\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Once drift detection is performed for a directory, it will not be checked again for the same directory for a period defined by ",(0,i.jsx)(t.code,{children:"minimum_detection_interval"}),".\nThis prevents excessive drift checks on the same directory.\nThe default is 168 hours (7 days)."]}),"\n",(0,i.jsx)(t.p,{children:"You can enable or disable drift detection per target group or root module."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",children:'target_groups:\n  - working_directory: "**"\n    drift_detection:\n      enabled: true\n'})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",children:"drift_detection:\n  enabled: true\n"})}),"\n",(0,i.jsx)(t.h2,{id:"create-a-workflow-to-periodically-detect-drift",children:"Create a workflow to periodically detect drift"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",children:'name: Detect drift\non:\n  workflow_dispatch:\n    inputs: {}\n  schedule:\n    # hourly\n    - cron: "*/5 * * * *"\njobs:\n  pick-out:\n    timeout-minutes: 10\n    runs-on: ubuntu-24.04\n    outputs:\n      issues: ${{steps.pick-out.outputs.issues}}\n      has_issues: ${{steps.pick-out.outputs.has_issues}}\n    permissions:\n      contents: read\n      issues: read\n    steps:\n      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1\n        with:\n          persist-credentials: false\n      - uses: suzuki-shunsuke/tfaction@latest\n        id: pick-out\n        with:\n          action: pick-out-drift-issues\n\n  detect:\n    timeout-minutes: 60\n    name: "detect (${{matrix.issue.target}})"\n    runs-on: ${{matrix.issue.runs_on}}\n    needs: pick-out\n    permissions:\n      issues: write\n      contents: read\n    if: fromJSON(needs.pick-out.outputs.has_issues)\n    strategy:\n      fail-fast: false\n      matrix:\n        issue: ${{fromJSON(needs.pick-out.outputs.issues)}}\n    steps:\n      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1\n        with:\n          persist-credentials: false\n\n      - uses: suzuki-shunsuke/tfaction@latest\n        with:\n          action: set-drift-env\n          issue: ${{toJSON(matrix.issue)}}\n\n      - uses: suzuki-shunsuke/tfaction@latest\n        with:\n          action: setup\n\n      - uses: suzuki-shunsuke/tfaction@latest\n        with:\n          action: test\n\n      - uses: suzuki-shunsuke/tfaction@latest\n        with:\n          action: plan\n\n      - uses: suzuki-shunsuke/tfaction@latest\n        if: always()\n        with:\n          action: update-drift-issue\n          status: ${{job.status}}\n'})}),"\n",(0,i.jsx)(t.h2,{id:"create-a-workflow-to-periodically-create-drift-issues",children:"Create a workflow to periodically create drift issues"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",children:'name: Create drift issues\non:\n  workflow_dispatch:\n    inputs: {}\n  schedule:\n    # daily\n    - cron: "0 0 * * *"\njobs:\n  create-drift-issues:\n    timeout-minutes: 30\n    runs-on: ubuntu-24.04\n    permissions: {}\n    steps:\n      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1\n        with:\n          persist-credentials: false\n\n      - uses: suzuki-shunsuke/tfaction@latest\n        with:\n          action: create-drift-issues\n'})}),"\n",(0,i.jsx)(t.h2,{id:"modify-the-apply-workflow",children:"Modify the apply workflow"}),"\n",(0,i.jsx)(t.p,{children:"Add a step at the beginning of the job to get or create a drift issue:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",children:"- uses: suzuki-shunsuke/tfaction@latest\n  with:\n    action: get-or-create-drift-issue\n"})}),"\n",(0,i.jsx)(t.p,{children:"Add a step at the end of the job to update the drift issue:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",children:"- uses: suzuki-shunsuke/tfaction@latest\n  if: always()\n  with:\n    action: update-drift-issue\n    status: ${{job.status}}\n"})}),"\n",(0,i.jsx)(t.h2,{id:"operational-recommendations",children:"Operational recommendations"}),"\n",(0,i.jsx)(t.p,{children:"Enabling Drift Detection and having issues created is meaningless unless you actually resolve the drift based on them.\nHow you resolve drift is of course up to you and depends on team/organization size, structure, and policies.\nHere are some ideas for how to operate it (assuming a relatively large organization):"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsx)(t.li,{children:"Add issues to a GitHub Project"}),"\n",(0,i.jsx)(t.li,{children:"Regularly check the Project (Kanban) board (e.g., every morning), assign people to open issues, and handle them"}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"Running this as a one-person effort is unsustainable, so rotating within the team is recommended.\nIf each root module has a product team with ownership, it is ideal to have the product team handle the issues (although this can be difficult in practice)."}),"\n",(0,i.jsx)(t.p,{children:"If you want real-time notifications, tfaction's Drift Detection itself does not have a real-time notification mechanism, but you can integrate Slack with GitHub to send notifications, or trigger a workflow on issue events in GitHub Actions.\nHowever, real-time notifications can generate a lot of noise and cause unnecessary fatigue, so they are not personally recommended."})]})}function u(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},8453(e,t,n){n.d(t,{R:()=>a,x:()=>r});var s=n(6540);const i={},o=s.createContext(i);function a(e){const t=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),s.createElement(o.Provider,{value:t},e.children)}}}]);