"use strict";(globalThis.webpackChunktfaction=globalThis.webpackChunktfaction||[]).push([[9167],{1374(e,t,n){n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>i,metadata:()=>o,toc:()=>d});const o=JSON.parse('{"id":"unreleased/monorepo","title":"Monorepo","description":"In Getting Started, there was only one root module, but now let\'s set up a monorepo.","source":"@site/docs/unreleased/monorepo.md","sourceDirName":"unreleased","slug":"/unreleased/monorepo","permalink":"/tfaction/docs/unreleased/monorepo","draft":false,"unlisted":false,"editUrl":"https://github.com/suzuki-shunsuke/tfaction-docs/edit/main/docs/unreleased/monorepo.md","tags":[],"version":"current","sidebarPosition":700,"frontMatter":{"sidebar_position":700},"sidebar":"tutorialSidebar","previous":{"title":"tfaction v2 is a Single Action","permalink":"/tfaction/docs/unreleased/single-action"},"next":{"title":"Run Terraform When a Dependent Local-Path Module is Updated","permalink":"/tfaction/docs/unreleased/detect-module-dependency"}}');var s=n(4848),r=n(8453);const i={sidebar_position:700},a="Monorepo",l={},d=[];function c(e){const t={code:"code",h1:"h1",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"monorepo",children:"Monorepo"})}),"\n",(0,s.jsx)(t.p,{children:"In Getting Started, there was only one root module, but now let's set up a monorepo."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"foo/\n  tfaction.yaml\n  main.tf\n  # ...\nbar/\n  tfaction.yaml\n  main.tf\n  # ...\n"})}),"\n",(0,s.jsx)(t.p,{children:"In a monorepo, you likely want to run terraform plan and apply only for the root modules changed in a PR.\nYou can easily achieve this using GitHub Actions matrix builds and tfaction's list-targets action.\nlist-targets outputs a list of root modules changed in the PR.\nSince list-targets depends on git, you need to checkout the repository before running it.\nHowever, a shallow clone is sufficient."}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["Add a ",(0,s.jsx)(t.code,{children:"list"})," job"]}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["Run ",(0,s.jsx)(t.code,{children:"list-targets"})," to get the list of target root modules and output it."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-yaml:.github/workflows/test.yaml",children:"jobs:\n  list:\n    timeout-minutes: 10\n    runs-on: ubuntu-24.04\n    permissions:\n      contents: read\n    outputs:\n      targets: ${{steps.list-targets.outputs.targets}}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1\n        with:\n          persist-credentials: false\n\n      - name: List Targets\n        uses: suzuki-shunsuke/tfaction@latest\n        id: list-targets\n        with:\n          action: list-targets\n"})}),"\n",(0,s.jsxs)(t.ol,{start:"2",children:["\n",(0,s.jsx)(t.li,{children:"Run plan with matrix builds after the list job"}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-yaml:.github/workflows/test.yaml",children:'  plan:\n    name: "plan (${{matrix.target.target}})" # Use a different job name for each root module\n    timeout-minutes: 60\n    runs-on: ubuntu-24.04\n    needs: [list] # Run after list\n    permissions:\n      contents: read\n    env:\n      # Set environment variables for each root module\n      TFACTION_TARGET: "${{matrix.target.target}}"\n      TFACTION_WORKING_DIR: ${{matrix.target.working_directory}}\n      TFACTION_JOB_TYPE: ${{matrix.target.job_type}}\n    if: "join(fromJSON(needs.list.outputs.targets), \'\') != \'\'" # Skip if no root modules were changed\n    strategy:\n      fail-fast: false # Continue running other root modules even if one fails\n      matrix:\n        target: ${{fromJSON(needs.list.outputs.targets)}}\n'})}),"\n",(0,s.jsx)(t.p,{children:"This way, CI runs only for the root modules changed in the PR using matrix builds."}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:"https://storage.googleapis.com/zenn-user-upload/738ba40e1d0b-20260208.png",alt:""})}),"\n",(0,s.jsx)(t.p,{children:"PR comments and labels also include the root module path, making it easy to distinguish which root module they relate to."}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:"https://storage.googleapis.com/zenn-user-upload/84d4951d11b1-20260208.png",alt:""})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:"https://storage.googleapis.com/zenn-user-upload/e2c3f6bc17ba-20260208.png",alt:""})})]})}function u(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453(e,t,n){n.d(t,{R:()=>i,x:()=>a});var o=n(6540);const s={},r=o.createContext(s);function i(e){const t=o.useContext(r);return o.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),o.createElement(r.Provider,{value:t},e.children)}}}]);