"use strict";(globalThis.webpackChunktfaction=globalThis.webpackChunktfaction||[]).push([[4071],{1470(e,t,n){n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>u,frontMatter:()=>s,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"unreleased/tfmigrate","title":"tfmigrate","description":"Run tfmigrate through GitHub Actions to perform state migrations as code.","source":"@site/docs/unreleased/tfmigrate.md","sourceDirName":"unreleased","slug":"/unreleased/tfmigrate","permalink":"/tfaction/docs/unreleased/tfmigrate","draft":false,"unlisted":false,"editUrl":"https://github.com/suzuki-shunsuke/tfaction-docs/edit/main/docs/unreleased/tfmigrate.md","tags":[],"version":"current","sidebarPosition":3300,"frontMatter":{"sidebar_position":3300},"sidebar":"tutorialSidebar","previous":{"title":"Actions","permalink":"/tfaction/docs/unreleased/actions"},"next":{"title":"Testing Workflow Changes","permalink":"/tfaction/docs/unreleased/test-workflow"}}');var o=n(4848),i=n(8453);const s={sidebar_position:3300},a="tfmigrate",c={},d=[{value:"Creating the Workflow",id:"creating-the-workflow",level:2},{value:"tfaction-root.yaml",id:"tfaction-rootyaml",level:2},{value:"Moving Resources Across States",id:"moving-resources-across-states",level:2}];function l(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.header,{children:(0,o.jsx)(t.h1,{id:"tfmigrate",children:"tfmigrate"})}),"\n",(0,o.jsxs)(t.p,{children:["Run ",(0,o.jsx)(t.a,{href:"https://github.com/minamijoyo/tfmigrate",children:"tfmigrate"})," through GitHub Actions to perform state migrations as code.\nWhile the need for tfmigrate has decreased since Terraform added official support for moved blocks, removed blocks, and import blocks, it remains useful for cases such as moving resources between states."]}),"\n",(0,o.jsx)(t.p,{children:"To run tfmigrate with tfaction, create tfmigrate configuration files and migration files, then add a label to the PR.\ntfaction provides a workflow to simplify this process."}),"\n",(0,o.jsx)(t.h2,{id:"creating-the-workflow",children:"Creating the Workflow"}),"\n",(0,o.jsxs)(t.p,{children:["Running this workflow creates a PR with tfmigrate configuration files and migration files for a specified directory.\nIf you specify the ",(0,o.jsx)(t.code,{children:"pr_number"})," input, it commits to an existing PR instead of creating a new one."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-yaml",metastring:'title=".github/workflows/scaffold_tfmigrate.yaml"',children:'name: Scaffold tfmigrate\non:\n  workflow_dispatch:\n    inputs:\n      working_directory:\n        description: working directory\n        required: true\n      migration_name:\n        description: \'migration name. e.g. "import_foo"\'\n        required: true\n      pr_number:\n        description: "PR number"\n        required: false\nenv:\n  TFACTION_WORKING_DIR: ${{inputs.working_directory}}\njobs:\n  scaffold:\n    timeout-minutes: 10\n    permissions:\n      contents: read\n    runs-on: ubuntu-24.04\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1\n        with:\n          persist-credentials: false\n\n      - name: Create GitHub App installation access token\n        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1\n        id: token\n        with:\n          app-id: ${{ vars.APP_ID }}\n          private-key: ${{ secrets.PRIVATE_KEY }}\n          permission-contents: write\n          permission-pull-requests: write\n\n      - name: Create PR\n        uses: suzuki-shunsuke/tfaction@latest\n        with:\n          action: scaffold-tfmigrate\n          github_token: ${{steps.token.outputs.token}}\n          migration_name: ${{inputs.migration_name}}\n          pr_number: ${{inputs.pr_number}}\n'})}),"\n",(0,o.jsx)(t.h2,{id:"tfaction-rootyaml",children:"tfaction-root.yaml"}),"\n",(0,o.jsx)(t.p,{children:"When using the AWS Provider, configure the IAM Role for tfmigrate.\nAlso configure the S3 Bucket for storing tfmigrate history."}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-yaml",metastring:'title="tfaction-root.yaml"',children:'target_groups:\n  - working_directory: ""\n    aws_region: ap-northeast-1\n    s3_bucket_name_tfmigrate_history: <bucket name>\n    tfmigrate_plan_config:\n      aws_assume_role_arn: arn:aws:iam::000000000000:role/GitHubActions_Terraform_AWS_tfmigrate_plan\n    tfmigrate_apply_config:\n      aws_assume_role_arn: arn:aws:iam::000000000000:role/GitHubActions_Terraform_AWS_tfmigrate_apply\n'})}),"\n",(0,o.jsx)(t.h2,{id:"moving-resources-across-states",children:"Moving Resources Across States"}),"\n",(0,o.jsx)(t.p,{children:"tfmigrate supports moving resources between different states.\nWhen doing this with tfaction, use an ignore label to prevent terraform plan from running."}),"\n",(0,o.jsxs)(t.p,{children:["For example, suppose you are moving resources from working directory ",(0,o.jsx)(t.code,{children:"foo"})," to ",(0,o.jsx)(t.code,{children:"bar"})," and running tfmigrate in ",(0,o.jsx)(t.code,{children:"foo"}),".\nBoth ",(0,o.jsx)(t.code,{children:"foo"})," and ",(0,o.jsx)(t.code,{children:"bar"})," require code changes, so CI runs in both directories.\nIn ",(0,o.jsx)(t.code,{children:"foo"}),", tfmigrate moves the resources from ",(0,o.jsx)(t.code,{children:"foo"})," to ",(0,o.jsx)(t.code,{children:"bar"}),", but in ",(0,o.jsx)(t.code,{children:"bar"}),", terraform plan and apply would also run.\nBy adding an ",(0,o.jsx)(t.code,{children:"ignore:bar"})," label, you can prevent terraform plan and apply from running in ",(0,o.jsx)(t.code,{children:"bar"}),"."]})]})}function u(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},8453(e,t,n){n.d(t,{R:()=>s,x:()=>a});var r=n(6540);const o={},i=r.createContext(o);function s(e){const t=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),r.createElement(i.Provider,{value:t},e.children)}}}]);