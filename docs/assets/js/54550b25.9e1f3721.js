"use strict";(globalThis.webpackChunktfaction=globalThis.webpackChunktfaction||[]).push([[7951],{9202(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"unreleased/getting-started","title":"Getting Started","description":"We will build a simple workflow using the minimum configuration required for tfaction.","source":"@site/docs/unreleased/getting-started.md","sourceDirName":"unreleased","slug":"/unreleased/getting-started","permalink":"/tfaction/docs/unreleased/getting-started","draft":false,"unlisted":false,"editUrl":"https://github.com/suzuki-shunsuke/tfaction-docs/edit/main/docs/unreleased/getting-started.md","tags":[],"version":"current","sidebarPosition":200,"frontMatter":{"sidebar_position":200},"sidebar":"tutorialSidebar","previous":{"title":"tfaction","permalink":"/tfaction/docs/unreleased/overview"},"next":{"title":"Hide Old PR Comments","permalink":"/tfaction/docs/unreleased/hide-old-comment"}}');var i=t(4848),r=t(8453);const o={sidebar_position:200},a="Getting Started",l={},c=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Create a Root Module",id:"create-a-root-module",level:2},{value:"tfaction.yaml",id:"tfactionyaml",level:2},{value:"tfaction-root.yaml",id:"tfaction-rootyaml",level:2},{value:"Install Terraform",id:"install-terraform",level:2},{value:"Create a GitHub App",id:"create-a-github-app",level:2},{value:"Create the Workflow for PRs",id:"create-the-workflow-for-prs",level:2},{value:"Create a PR",id:"create-a-pr",level:2},{value:"Create the Workflow for Apply",id:"create-the-workflow-for-apply",level:2},{value:"Next",id:"next",level:2}];function u(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"getting-started",children:"Getting Started"})}),"\n",(0,i.jsx)(n.p,{children:"We will build a simple workflow using the minimum configuration required for tfaction."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Create ",(0,i.jsx)(n.code,{children:"tfaction.yaml"})]}),"\n",(0,i.jsxs)(n.li,{children:["Create ",(0,i.jsx)(n.code,{children:"tfaction-root.yaml"})]}),"\n",(0,i.jsx)(n.li,{children:"Install Terraform"}),"\n",(0,i.jsx)(n.li,{children:"Create a GitHub App"}),"\n",(0,i.jsx)(n.li,{children:"Create a GitHub Actions workflow"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsx)(n.p,{children:"Create a GitHub repository."}),"\n",(0,i.jsx)(n.p,{children:"In this guide, you will set up tfaction and learn by running GitHub Actions.\nOnce you\u2019re done, you can safely archive the repository."}),"\n",(0,i.jsx)(n.h2,{id:"create-a-root-module",children:"Create a Root Module"}),"\n",(0,i.jsxs)(n.p,{children:["Create a simple root module using ",(0,i.jsx)(n.code,{children:"null_resource"}),".\nFor this example, we use Terraform\u2019s Local Backend.\nIn real-world use cases, you would typically use something like the S3 backend to persist state, but we will omit that here for simplicity."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tf",children:'resource "null_resource" "foo" {}\n'})}),"\n",(0,i.jsx)(n.p,{children:"Although tfaction supports monorepos, in this chapter we create a single root module at the repository root."}),"\n",(0,i.jsx)(n.h2,{id:"tfactionyaml",children:"tfaction.yaml"}),"\n",(0,i.jsxs)(n.p,{children:["Create ",(0,i.jsx)(n.code,{children:"tfaction.yaml"})," in the root module directory."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"tfaction.yaml"})," defines settings specific to each root module.\nFor now, an empty object ",(0,i.jsx)(n.code,{children:"{}"})," is sufficient."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"{}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["tfaction recognizes directories containing ",(0,i.jsx)(n.code,{children:"tfaction.yaml"})," as root modules.\nIn other words, CI will not run in directories that do not contain ",(0,i.jsx)(n.code,{children:"tfaction.yaml"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"tfaction-rootyaml",children:"tfaction-root.yaml"}),"\n",(0,i.jsxs)(n.p,{children:["Create ",(0,i.jsx)(n.code,{children:"tfaction-root.yaml"})," at the repository root."]}),"\n",(0,i.jsx)(n.p,{children:"This file defines global tfaction settings.\nBelow is the minimum required configuration:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'plan_workflow_name: test.yaml\ntarget_groups:\n  - working_directory: "**"\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"plan_workflow_name"})," is required and specifies the file name (not the workflow name) of the GitHub Actions workflow that runs ",(0,i.jsx)(n.code,{children:"terraform plan"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"target_groups"})," is required and defines root module groups and their specific settings. In this example, we do not apply any special configuration."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"install-terraform",children:"Install Terraform"}),"\n",(0,i.jsx)(n.p,{children:"Terraform must be installed."}),"\n",(0,i.jsxs)(n.p,{children:["tfaction internally uses ",(0,i.jsx)(n.a,{href:"https://aquaproj.github.io/",children:"aqua"}),".\nIf you create an ",(0,i.jsx)(n.code,{children:"aqua.yaml"})," file and manage Terraform with aqua, tfaction will automatically install it."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"# yaml-language-server: $schema=https://raw.githubusercontent.com/aquaproj/aqua/main/json-schema/aqua-yaml.json\nregistries:\n  - type: standard\n    ref: v4.467.0 # renovate: depName=aquaproj/aqua-registry\npackages:\n  - name: hashicorp/terraform@v1.14.4\n"})}),"\n",(0,i.jsx)(n.p,{children:"You may also install required tools using methods other than aqua."}),"\n",(0,i.jsxs)(n.p,{children:["If you use ",(0,i.jsx)(n.code,{children:"hashicorp/setup-terraform"}),", note that due to a known bug, you must set ",(0,i.jsx)(n.code,{children:"terraform_wrapper"})," to ",(0,i.jsx)(n.code,{children:"false"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"- uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2\n  with:\n    terraform_wrapper: false\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/hashicorp/setup-terraform/issues/9",children:"https://github.com/hashicorp/setup-terraform/issues/9"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/hashicorp/setup-terraform/issues/328",children:"https://github.com/hashicorp/setup-terraform/issues/328"})}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Using aqua also allows you to install tools such as ",(0,i.jsx)(n.code,{children:"tflint"})," and ",(0,i.jsx)(n.code,{children:"trivy"}),".\nSince Terraform is typically executed locally as well, it is recommended to use a version manager like aqua to keep versions consistent between local environments and CI."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://github.com/suzuki-shunsuke/tfaction/tree/main/install/aqua/imports",children:"Some tools used internally by tfaction are version-managed within tfaction itself, so users do not need to install them manually."})}),"\n",(0,i.jsx)(n.h2,{id:"create-a-github-app",children:"Create a GitHub App"}),"\n",(0,i.jsx)(n.p,{children:"Create a GitHub App that tfaction will use to create commits and PRs."}),"\n",(0,i.jsxs)(n.p,{children:["Although you can use GitHub Actions' ",(0,i.jsx)(n.code,{children:"GITHUB_TOKEN"}),", it does not trigger new workflow runs when pushing commits, which can be inconvenient.\nPersonal Access Tokens are also less recommended due to user management overhead, lack of commit signing, and token rotation complexity."]}),"\n",(0,i.jsx)(n.p,{children:"A GitHub App is recommended instead.\nCreate the GitHub App with the following settings:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"GitHub App name: Must be globally unique. Prefixing it with the GitHub App owner name helps ensure uniqueness."}),"\n",(0,i.jsxs)(n.li,{children:["Homepage URL: Any value is fine. For example: ",(0,i.jsx)(n.a,{href:"https://github.com/suzuki-shunsuke/tfaction",children:"https://github.com/suzuki-shunsuke/tfaction"})]}),"\n",(0,i.jsxs)(n.li,{children:["Webhook: Disable (uncheck ",(0,i.jsx)(n.code,{children:"Active"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:["Permissions:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Repository Permissions:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Actions: Read"}),"\n",(0,i.jsx)(n.li,{children:"Contents: Write"}),"\n",(0,i.jsx)(n.li,{children:"Pull requests: Write"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"After creating the GitHub App, install it in the repository where tfaction will run."}),"\n",(0,i.jsx)(n.p,{children:"From the App Settings page, generate a Private Key.\nDownload it and register it as a Repository Secret."}),"\n",(0,i.jsx)(n.p,{children:"Also register the App ID as a Repository Variable."}),"\n",(0,i.jsx)(n.h2,{id:"create-the-workflow-for-prs",children:"Create the Workflow for PRs"}),"\n",(0,i.jsxs)(n.p,{children:["Create a workflow that runs ",(0,i.jsx)(n.code,{children:"terraform plan"})," on the ",(0,i.jsx)(n.code,{children:"pull_request"})," event."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"name: test\non: pull_request\njobs:\n  plan:\n    timeout-minutes: 60\n    runs-on: ubuntu-24.04\n    permissions:\n      contents: read\n    env:\n      TFACTION_JOB_TYPE: terraform\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1\n        with:\n          persist-credentials: false\n\n      - name: Create GitHub App installation access token\n        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1\n        id: token\n        with:\n          app-id: ${{ vars.APP_ID }}\n          private-key: ${{ secrets.PRIVATE_KEY }}\n          permission-contents: write\n          permission-pull-requests: write\n\n      - name: Set up\n        uses: suzuki-shunsuke/tfaction@latest\n        with:\n          action: setup\n          github_token: ${{ steps.token.outputs.token }}\n\n      - name: terraform init\n        uses: suzuki-shunsuke/tfaction@latest\n        with:\n          action: terraform-init\n          github_token: ${{ steps.token.outputs.token }}\n\n      - name: Plan\n        uses: suzuki-shunsuke/tfaction@latest\n        with:\n          action: plan\n          github_token: ${{ steps.token.outputs.token }}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"create-a-pr",children:"Create a PR"}),"\n",(0,i.jsx)(n.p,{children:"Create a pull request and let the workflow run."}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:".terraform.lock.hcl"})," will be generated.\nThe result of ",(0,i.jsx)(n.code,{children:"terraform plan"})," will be commented on the PR using tfcmt.\nLabels are also added to the PR based on the result."]}),"\n",(0,i.jsxs)(n.p,{children:["Review the comment, and if everything looks good, merge the PR.\nAfter merging, ",(0,i.jsx)(n.code,{children:"terraform init"})," and ",(0,i.jsx)(n.code,{children:"apply"})," will run, and the results will be posted as a PR comment."]}),"\n",(0,i.jsx)(n.h2,{id:"create-the-workflow-for-apply",children:"Create the Workflow for Apply"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"name: apply\non:\n  push:\n    branches:\n      - main\njobs:\n  apply:\n    timeout-minutes: 60\n    runs-on: ubuntu-24.04\n    permissions:\n      contents: read\n    env:\n      TFACTION_JOB_TYPE: terraform\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1\n        with:\n          persist-credentials: false\n\n      - name: Create GitHub App installation access token\n        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1\n        id: token\n        with:\n          app-id: ${{ vars.APP_ID }}\n          private-key: ${{ secrets.PRIVATE_KEY }}\n          permission-actions: read\n          permission-contents: write\n          permission-pull-requests: write\n\n      - name: Set up\n        uses: suzuki-shunsuke/tfaction@latest\n        with:\n          action: setup\n          github_token: ${{ steps.token.outputs.token }}\n\n      - name: terraform init\n        uses: suzuki-shunsuke/tfaction@latest\n        with:\n          action: terraform-init\n          github_token: ${{ steps.token.outputs.token }}\n\n      - name: Apply\n        uses: suzuki-shunsuke/tfaction@latest\n        with:\n          action: apply\n          github_token: ${{ steps.token.outputs.token }}\n\n      - name: Create follow up PR\n        uses: suzuki-shunsuke/tfaction@latest\n        if: failure()\n        with:\n          action: create-follow-up-pr\n          github_token: ${{ steps.token.outputs.token }}\n"})}),"\n",(0,i.jsx)(n.p,{children:"After adding this workflow, merge the PR."}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"terraform apply"})," will run, and the results will be posted as a PR comment."]}),"\n",(0,i.jsx)(n.h2,{id:"next",children:"Next"}),"\n",(0,i.jsx)(n.p,{children:"At this point, you have successfully built a simple workflow using tfaction."}),"\n",(0,i.jsx)(n.p,{children:"For a workflow of this simplicity, you could implement it without tfaction, so its advantages may not yet be fully apparent.\nIn the next chapters, we will explore the more advanced features of tfaction."})]})}function d(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},8453(e,n,t){t.d(n,{R:()=>o,x:()=>a});var s=t(6540);const i={},r=s.createContext(i);function o(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);