"use strict";(globalThis.webpackChunktfaction=globalThis.webpackChunktfaction||[]).push([[3033],{5405(e,n,t){t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"unreleased/lint","title":"Linting and Formatting","description":"The test action provides linting and formatting capabilities:","source":"@site/docs/unreleased/lint.md","sourceDirName":"unreleased","slug":"/unreleased/lint","permalink":"/tfaction/docs/unreleased/lint","draft":false,"unlisted":false,"editUrl":"https://github.com/suzuki-shunsuke/tfaction-docs/edit/main/docs/unreleased/lint.md","tags":[],"version":"current","sidebarPosition":900,"frontMatter":{"sidebar_position":900},"sidebar":"tutorialSidebar","previous":{"title":"Trigger Terraform When Dependent Local-path Modules Are Updated","permalink":"/tfaction/docs/unreleased/detect-module-dependency"},"next":{"title":"Follow-up PR","permalink":"/tfaction/docs/unreleased/follow-up-pr"}}');var r=t(4848),s=t(8453);const l={sidebar_position:900},a="Linting and Formatting",o={},c=[{value:"terraform fmt",id:"terraform-fmt",level:2},{value:"terraform-docs",id:"terraform-docs",level:2},{value:"tflint",id:"tflint",level:2},{value:"trivy",id:"trivy",level:2},{value:"reviewdog",id:"reviewdog",level:3},{value:"conftest",id:"conftest",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"linting-and-formatting",children:"Linting and Formatting"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"test"})," action provides linting and formatting capabilities:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"terraform fmt"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"terraform validate"})}),"\n",(0,r.jsxs)(n.li,{children:["Optional:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"tflint"}),"\n",(0,r.jsx)(n.li,{children:"trivy"}),"\n",(0,r.jsx)(n.li,{children:"conftest"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Run it after ",(0,r.jsx)(n.code,{children:"terraform-init"})," and before ",(0,r.jsx)(n.code,{children:"plan"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"- name: terraform init\n  uses: suzuki-shunsuke/tfaction@latest\n  with:\n    action: terraform-init\n    github_token: ${{ steps.token.outputs.token }}\n\n- name: Lint\n  uses: suzuki-shunsuke/tfaction@latest\n  with:\n    action: test\n    github_token: ${{ steps.token.outputs.token }}\n\n- name: Plan\n  uses: suzuki-shunsuke/tfaction@latest\n  with:\n    action: plan\n    github_token: ${{ steps.token.outputs.token }}\n"})}),"\n",(0,r.jsx)(n.p,{children:"To start, let's disable tflint and trivy:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"tflint:\n  enabled: false\ntrivy:\n  enabled: false\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This enables ",(0,r.jsx)(n.code,{children:"terraform validate"})," for validation and ",(0,r.jsx)(n.code,{children:"terraform fmt"})," for automatic formatting."]}),"\n",(0,r.jsx)(n.h2,{id:"terraform-fmt",children:"terraform fmt"}),"\n",(0,r.jsxs)(n.p,{children:["If the code is not formatted, ",(0,r.jsx)(n.code,{children:"terraform fmt"})," will format it and automatically push a commit to the PR."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://storage.googleapis.com/zenn-user-upload/a54a142fb196-20260208.png",alt:"terraform fmt"})}),"\n",(0,r.jsx)(n.h2,{id:"terraform-docs",children:"terraform-docs"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://terraform-docs.io/",children:"terraform-docs"})," is disabled by default. To enable it:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"terraform_docs:\n  enabled: true\n"})}),"\n",(0,r.jsx)(n.p,{children:"Documentation will be automatically generated and updated.\nterraform-docs is installed automatically by tfaction."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://storage.googleapis.com/zenn-user-upload/80fbdc39621f-20260208.png",alt:""})}),"\n",(0,r.jsx)(n.p,{children:"terraform-docs works without configuration, but if you want to customize it, create a configuration file at one of the following paths (in order of priority):"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:".terraform-docs.ya?ml"})," in the root module"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:".config/.terraform-docs.ya?ml"})," in the root module"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:".terraform-docs.ya?ml"})," at the repository root"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:".config/.terraform-docs.ya?ml"})," at the repository root"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"tflint",children:"tflint"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://github.com/terraform-linters/tflint",children:"tflint"})," is enabled by default. You can also explicitly enable it in configuration:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"tflint:\n  enabled: true\n"})}),"\n",(0,r.jsxs)(n.p,{children:["tflint must be installed. Add it to ",(0,r.jsx)(n.code,{children:"aqua.yaml"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"aqua g -i terraform-linters/tflint\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"packages:\n  - name: terraform-linters/tflint@v0.61.0\n"})}),"\n",(0,r.jsx)(n.p,{children:"tflint results are reported via reviewdog reviews."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://storage.googleapis.com/zenn-user-upload/49d868efb665-20260208.png",alt:""})}),"\n",(0,r.jsxs)(n.p,{children:["Automatic fixes via ",(0,r.jsx)(n.code,{children:"tflint --fix"})," are also enabled by default. To disable them:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"tflint:\n  fix: false\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://github.com/terraform-linters/tflint/blob/master/docs/user-guide/config.md",children:"Refer to the official tflint documentation for configuration file details."}),"\nIf you want to share a tflint configuration across root modules, place the configuration file at the repository root and set the ",(0,r.jsx)(n.code,{children:"TFLINT_CONFIG_FILE"})," environment variable:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"env:\n  TFLINT_CONFIG_FILE: ${{github.workspace}}/.tflint.hcl\n"})}),"\n",(0,r.jsx)(n.h2,{id:"trivy",children:"trivy"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://trivy.dev/",children:"trivy"})," is enabled by default. You can also explicitly enable it in configuration:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"trivy:\n  enabled: true\n"})}),"\n",(0,r.jsxs)(n.p,{children:["trivy must be installed. Add it to ",(0,r.jsx)(n.code,{children:"aqua.yaml"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"aqua g -i aquasecurity/trivy\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"packages:\n  - name: aquasecurity/trivy@v0.69.1\n"})}),"\n",(0,r.jsx)(n.p,{children:"trivy results are reported via reviewdog reviews."}),"\n",(0,r.jsx)(n.h3,{id:"reviewdog",children:"reviewdog"}),"\n",(0,r.jsx)(n.p,{children:"Both trivy and tflint results are reported to the PR via reviewdog.\nYou can configure reviewdog's command-line options:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"tflint:\n  reviewdog:\n    filter_mode: added # Default is nofilter\n    fail_level: error # Default is any\ntrivy:\n  reviewdog:\n    filter_mode: added # Default is nofilter\n    fail_level: error # Default is any\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The key setting is ",(0,r.jsx)(n.code,{children:"filter_mode"}),".\nThe default ",(0,r.jsx)(n.code,{children:"nofilter"})," targets all files in the root module.\nOn the other hand, ",(0,r.jsx)(n.code,{children:"added"})," targets only changed files.\nWhich is better depends on your situation.\nIf you want strict policy enforcement, ",(0,r.jsx)(n.code,{children:"nofilter"})," is appropriate.\nHowever, retroactively applying policies to existing code can be difficult.\nIn that case, it may be more practical to use ",(0,r.jsx)(n.code,{children:"added"})," and apply policies only to new code."]}),"\n",(0,r.jsx)(n.h2,{id:"conftest",children:"conftest"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://www.conftest.dev/",children:"conftest"})," runs in both the ",(0,r.jsx)(n.code,{children:"test"})," and ",(0,r.jsx)(n.code,{children:"plan"})," actions.\nIn ",(0,r.jsx)(n.code,{children:"test"}),", it runs against HCL files. In ",(0,r.jsx)(n.code,{children:"plan"}),", it runs against plan files.\nTypically, running against plan files is preferable:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["You can apply policies based on the plan result (create, update, destroy)","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"For example, apply a policy only to new resources, or apply a policy on destroy"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"You can apply policies based on Terraform's computed values"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"However, running against HCL files can also be useful:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Backend configuration is not included in plan files, so policies for it must be applied against HCL"}),"\n",(0,r.jsxs)(n.li,{children:["Since ",(0,r.jsx)(n.code,{children:"terraform plan"})," carries risks such as arbitrary code execution and credential exfiltration, you may want to validate HCL before running ",(0,r.jsx)(n.code,{children:"terraform plan"})," to catch dangerous code"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://engineering.mercari.com/en/blog/entry/20230706-bucket-full-of-secrets-terraform-exfiltration/",children:"https://engineering.mercari.com/en/blog/entry/20230706-bucket-full-of-secrets-terraform-exfiltration/"})}),"\n",(0,r.jsxs)(n.p,{children:["To run against HCL files, specify ",(0,r.jsx)(n.code,{children:"tf: true"}),".\nTo run against plan files, specify ",(0,r.jsx)(n.code,{children:"plan: true"}),".\nIf neither is specified, you can run conftest against non-Terraform files such as YAML or Dockerfiles."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'conftest:\n  policies:\n    - policy: policy/tf\n      tf: true\n      id: tf\n    - policy: policy/plan\n      plan: true\n      id: plan\n    - policy: policy/yaml\n      paths:\n        - "*.yml"\n        - "*.yaml"\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:".conftest.policies[]"})," supports most options of the ",(0,r.jsx)(n.code,{children:"conftest test"})," command:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"conftest:\n  policies:\n    - policy: # array or string\n        - policy/terraform\n      data: # array or string\n        - data/data.yaml\n      fail_on_warn: true\n      no_fail: true\n      all_namespaces: true\n      quiet: true\n      trace: true\n      strict: true\n      show_builtin_errors: true\n      junit_hide_message: true\n      suppress_exceptions: true\n      tls: true\n      parser: hcl\n      output: json\n      namespaces:\n        - main\n"})}),"\n",(0,r.jsx)(n.p,{children:"In addition, there are several tfaction-specific settings:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"id"}),": Optional. An identifier for the policy. Required when you want to override a policy."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"plan"}),": Set to ",(0,r.jsx)(n.code,{children:"true"})," to run against plan files. Default is ",(0,r.jsx)(n.code,{children:"false"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tf"}),": Set to ",(0,r.jsx)(n.code,{children:"true"})," to run against ",(0,r.jsx)(n.code,{children:"*.tf"})," and ",(0,r.jsx)(n.code,{children:"*.tf.json"})," files. Default is ",(0,r.jsx)(n.code,{children:"false"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"enabled"}),": Default is ",(0,r.jsx)(n.code,{children:"true"}),". Can be used to disable a policy when overriding settings."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453(e,n,t){t.d(n,{R:()=>l,x:()=>a});var i=t(6540);const r={},s=i.createContext(r);function l(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);