name: apply
description: apply
inputs:
  github_token:
    # If `TFACTION_JOB_TYPE` is `terraform`, the following permissions are required:
    # pull-requests:write - Create pull request comments and labels
    # actions:read - Download artifacts
    # contents:write - Update pull request branches
    #
    # If `TFACTION_JOB_TYPE` is `tfmigrate`, the following permissions are required:
    # pull-requests:write - Create pull request comments
    # contents:write - Update pull request branches
    description: "GitHub Access Token"
    required: false
    default: ${{ github.token }}
  securefix_action_app_id:
    required: false
    default: ""
    description: |
      The GitHub App ID for the Securefix Action client.
  securefix_action_app_private_key:
    required: false
    default: ""
    description: |
      The GitHub App private key for the Securefix Action client.
runs:
  using: composite
  steps:
    # terraform-apply
    - uses: suzuki-shunsuke/tfaction/js@main
      if: env.TFACTION_JOB_TYPE == 'terraform'
      id: check-terraform-skip
      with:
        action: check-terraform-skip

    - uses: suzuki-shunsuke/tfaction/js@main
      id: terraform-apply
      if: |
        steps.check-terraform-skip.outputs.skip_terraform != 'true' &&
        env.TFACTION_JOB_TYPE == 'terraform'
      with:
        action: terraform-apply
        github_token: ${{ inputs.github_token }}
        securefix_action_app_id: ${{inputs.securefix_action_app_id}}
        securefix_action_app_private_key: ${{inputs.securefix_action_app_private_key}}

    # tfmigrate-apply
    - uses: suzuki-shunsuke/tfaction/js@main
      if: env.TFACTION_JOB_TYPE == 'tfmigrate'
      id: tfmigrate-apply
      with:
        github_token: ${{ inputs.github_token }}
        action: tfmigrate-apply
        securefix_action_app_id: ${{ inputs.securefix_action_app_id }}
        securefix_action_app_private_key: ${{ inputs.securefix_action_app_private_key }}
