name: test
description: test
inputs:
  github_token:
    description: |
      GitHub Access Token
      pull-requests:write - Create pull request comments and reviews
      contents:write - Push commits
    required: false
    default: ${{ github.token }}
  securefix_action_app_id:
    description: |
      GitHub App ID for Securefix Action
      issues:write
    required: false
  securefix_action_app_private_key:
    description: |
      GitHub App Private Key for Securefix Action
    required: false
runs:
  using: composite
  steps:
    - uses: suzuki-shunsuke/tfaction/js@ad50afa9cd60fab51b94eba740f58e1a323d22b0
      id: target-config
      with:
        action: get-target-config
    - uses: suzuki-shunsuke/tfaction/js@ad50afa9cd60fab51b94eba740f58e1a323d22b0
      id: global-config
      with:
        action: get-global-config

    # Conftest
    - shell: bash
      id: action_path
      run: echo "value=$GITHUB_ACTION_PATH" >> "$GITHUB_OUTPUT"
    - uses: suzuki-shunsuke/tfaction/js@ad50afa9cd60fab51b94eba740f58e1a323d22b0
      with:
        action: conftest
        github_token: ${{inputs.github_token}}
      env:
        GH_COMMENT_CONFIG: ${{ steps.action_path.outputs.value }}/github-comment.yaml

    # terraform validate
    - run: |
        github-comment exec \
          -config "${GITHUB_ACTION_PATH}/github-comment.yaml" \
          -k terraform-validate \
          -var "tfaction_target:${TFACTION_TARGET}" \
          -- "$TF_COMMAND" validate
      working-directory: ${{ steps.target-config.outputs.working_directory }}
      if: steps.target-config.outputs.destroy != 'true'
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
        TF_COMMAND: ${{ steps.target-config.outputs.terraform_command }}

    # trivy
    - uses: suzuki-shunsuke/tfaction/js@ad50afa9cd60fab51b94eba740f58e1a323d22b0
      if: steps.target-config.outputs.enable_trivy == 'true' && steps.target-config.outputs.destroy != 'true'
      with:
        action: trivy
        github_token: ${{ inputs.github_token }}
        working_directory: ${{ steps.target-config.outputs.working_directory }}

    # tfsec
    - uses: suzuki-shunsuke/tfaction/js@ad50afa9cd60fab51b94eba740f58e1a323d22b0
      if: steps.target-config.outputs.enable_tfsec == 'true' && steps.target-config.outputs.destroy != 'true'
      with:
        action: tfsec
        github_token: ${{ inputs.github_token }}
        working_directory: ${{ steps.target-config.outputs.working_directory }}

    # tflint
    # deep check requires AWS credentials
    - if: steps.target-config.outputs.enable_tflint == 'true' && steps.target-config.outputs.destroy != 'true'
      id: tflint
      uses: suzuki-shunsuke/tfaction/js@ad50afa9cd60fab51b94eba740f58e1a323d22b0
      with:
        action: tflint
        github_token: ${{ inputs.github_token }}
        working_directory: ${{ steps.target-config.outputs.working_directory }}
        tflint_fix: ${{ steps.target-config.outputs.tflint_fix == 'true' }}
        use_securefix_action: ${{ steps.global-config.outputs.securefix_action_server_repository != '' }}
        # github_token_for_tflint_init
        # github_token_for_fix

    # tflint --fix with Securefix Action
    - if: |
        steps.target-config.outputs.enable_tflint == 'true' && steps.target-config.outputs.destroy != 'true' &&
        steps.global-config.outputs.securefix_action_server_repository != '' && steps.tflint.outputs.fixed_files != ''
      uses: csm-actions/securefix-action@949d3cfb554abee10f695014674759978ba8ba34 # v0.4.1
      with:
        app_id: ${{inputs.securefix_action_app_id}}
        app_private_key: ${{inputs.securefix_action_app_private_key}}
        server_repository: ${{ steps.global-config.outputs.securefix_action_server_repository }}
        commit_message: "fix(tflint): auto fix"
        files: |
          ${{ steps.tflint.outputs.fixed_files }}

    # terraform fmt
    - if: steps.target-config.outputs.destroy != 'true'
      shell: bash
      working-directory: ${{ steps.target-config.outputs.working_directory }}
      id: fmt-files
      env:
        TF_COMMAND: ${{ steps.target-config.outputs.terraform_command }}
        DIR: ${{ steps.target-config.outputs.working_directory }}
      run: |
        if [ -z "$DIR" ]; then
          {
            echo 'value<<EOF'
            "$TF_COMMAND" fmt -recursive
            echo EOF
          } >> "$GITHUB_OUTPUT"
          exit 0
        fi
        {
          echo 'value<<EOF'
          "$TF_COMMAND" fmt -recursive | sed "s|^|${DIR}/|"
          echo EOF
        } >> "$GITHUB_OUTPUT"

    # terraform fmt & commit action
    - if: |
        steps.target-config.outputs.destroy != 'true' &&
        steps.global-config.outputs.securefix_action_server_repository == '' && steps.fmt-files.outputs.value != ''
      uses: suzuki-shunsuke/commit-action@87b297f0ce551411b43d1880f4fb3cbc60381055 # v0.0.14
      with:
        commit_message: "style: ${{ steps.target-config.outputs.terraform_command }} fmt -recursive"
        github_token: ${{ inputs.github_token }}
        files: ${{ steps.fmt-files.outputs.value }}

    # terraform fmt & securefix action
    - if: |
        steps.target-config.outputs.destroy != 'true' &&
        steps.global-config.outputs.securefix_action_server_repository != '' && steps.fmt-files.outputs.value != ''
      uses: csm-actions/securefix-action@949d3cfb554abee10f695014674759978ba8ba34 # v0.4.1
      with:
        action: client
        app_id: ${{inputs.securefix_action_app_id}}
        app_private_key: ${{inputs.securefix_action_app_private_key}}
        server_repository: ${{ steps.global-config.outputs.securefix_action_server_repository }}
        commit_message: "style: ${{ steps.target-config.outputs.terraform_command }} fmt -recursive"
        files: ${{ steps.fmt-files.outputs.value }}

    # terraform-docs
    - uses: suzuki-shunsuke/tfaction/terraform-docs@32d7aa0833487aad1d0475d42563918907d350bf
      if: steps.target-config.outputs.enable_terraform_docs == 'true' && steps.target-config.outputs.destroy != 'true'
      with:
        github_token: ${{ inputs.github_token }}
        securefix_action_app_id: ${{ inputs.securefix_action_app_id }}
        securefix_action_app_private_key: ${{ inputs.securefix_action_app_private_key }}
        working_directory: ${{ steps.target-config.outputs.working_directory }}
