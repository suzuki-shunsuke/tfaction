name: test
description: test
inputs:
  github_token:
    description: |
      GitHub Access Token
      pull-requests:write - Create pull request comments and reviews
      contents:write - Push commits
    required: false
    default: ${{ github.token }}
  securefix_action_app_id:
    description: |
      GitHub App ID for Securefix Action
      issues:write
    required: false
  securefix_action_app_private_key:
    description: |
      GitHub App Private Key for Securefix Action
    required: false
runs:
  using: composite
  steps:
    - uses: suzuki-shunsuke/tfaction@28f9ae5e3d0e5e42944b407f00ce626c4b526ec0
      id: target-config
      with:
        action: get-target-config
    - uses: suzuki-shunsuke/tfaction@28f9ae5e3d0e5e42944b407f00ce626c4b526ec0
      id: global-config
      with:
        action: get-global-config

    # Conftest
    - uses: suzuki-shunsuke/tfaction@28f9ae5e3d0e5e42944b407f00ce626c4b526ec0
      with:
        action: conftest
        github_token: ${{inputs.github_token}}
      env:
        GH_COMMENT_CONFIG: ${{ env.TFACTION_GITHUB_COMMENT_CONFIG }}

    # terraform validate
    - run: |
        github-comment exec \
          -k terraform-validate \
          -var "tfaction_target:${TFACTION_TARGET}" \
          -- "$TF_COMMAND" validate
      working-directory: ${{ steps.target-config.outputs.working_directory }}
      if: steps.target-config.outputs.destroy != 'true'
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
        TF_COMMAND: ${{ steps.target-config.outputs.terraform_command }}
        GH_COMMENT_CONFIG: ${{ env.TFACTION_GITHUB_COMMENT_CONFIG }}

    # trivy
    - uses: suzuki-shunsuke/tfaction@28f9ae5e3d0e5e42944b407f00ce626c4b526ec0
      if: steps.target-config.outputs.enable_trivy == 'true' && steps.target-config.outputs.destroy != 'true'
      with:
        action: trivy
        github_token: ${{ inputs.github_token }}
        working_directory: ${{ steps.target-config.outputs.working_directory }}

    # tfsec
    - uses: suzuki-shunsuke/tfaction@28f9ae5e3d0e5e42944b407f00ce626c4b526ec0
      if: steps.target-config.outputs.enable_tfsec == 'true' && steps.target-config.outputs.destroy != 'true'
      with:
        action: tfsec
        github_token: ${{ inputs.github_token }}
        working_directory: ${{ steps.target-config.outputs.working_directory }}

    # tflint
    # deep check requires AWS credentials
    - if: steps.target-config.outputs.enable_tflint == 'true' && steps.target-config.outputs.destroy != 'true'
      id: tflint
      uses: suzuki-shunsuke/tfaction@28f9ae5e3d0e5e42944b407f00ce626c4b526ec0
      with:
        action: tflint
        github_token: ${{ inputs.github_token }}
        working_directory: ${{ steps.target-config.outputs.working_directory }}
        tflint_fix: ${{ steps.target-config.outputs.tflint_fix == 'true' }}
        use_securefix_action: ${{ steps.global-config.outputs.securefix_action_server_repository != '' }}
        securefix_action_app_id: ${{inputs.securefix_action_app_id}}
        securefix_action_app_private_key: ${{inputs.securefix_action_app_private_key}}
        securefix_action_server_repository: ${{ steps.global-config.outputs.securefix_action_server_repository }}
        # github_token_for_tflint_init
        # github_token_for_fix

    # terraform fmt
    - if: steps.target-config.outputs.destroy != 'true'
      shell: bash
      working-directory: ${{ steps.target-config.outputs.working_directory }}
      id: fmt-files
      env:
        TF_COMMAND: ${{ steps.target-config.outputs.terraform_command }}
        DIR: ${{ steps.target-config.outputs.working_directory }}
      run: |
        if [ -z "$DIR" ]; then
          {
            echo 'value<<EOF'
            "$TF_COMMAND" fmt -recursive
            echo EOF
          } >> "$GITHUB_OUTPUT"
          exit 0
        fi
        {
          echo 'value<<EOF'
          "$TF_COMMAND" fmt -recursive | sed "s|^|${DIR}/|"
          echo EOF
        } >> "$GITHUB_OUTPUT"

    # terraform fmt & commit
    - if: |
        steps.target-config.outputs.destroy != 'true' &&
        steps.fmt-files.outputs.value != ''
      uses: suzuki-shunsuke/tfaction@28f9ae5e3d0e5e42944b407f00ce626c4b526ec0
      with:
        action: commit
        commit_message: "style: ${{ steps.target-config.outputs.terraform_command }} fmt -recursive"
        files: ${{ steps.fmt-files.outputs.value }}
        github_token: ${{ inputs.github_token }}
        securefix_action_app_id: ${{inputs.securefix_action_app_id}}
        securefix_action_app_private_key: ${{inputs.securefix_action_app_private_key}}
        securefix_action_server_repository: ${{ steps.global-config.outputs.securefix_action_server_repository }}

    # terraform-docs
    - uses: suzuki-shunsuke/tfaction@28f9ae5e3d0e5e42944b407f00ce626c4b526ec0
      if: steps.target-config.outputs.enable_terraform_docs == 'true' && steps.target-config.outputs.destroy != 'true'
      with:
        action: terraform-docs
        github_token: ${{ inputs.github_token }}
        securefix_action_app_id: ${{ inputs.securefix_action_app_id }}
        securefix_action_app_private_key: ${{ inputs.securefix_action_app_private_key }}
        securefix_action_server_repository: ${{ steps.global-config.outputs.securefix_action_server_repository }}
        working_directory: ${{ steps.target-config.outputs.working_directory }}
